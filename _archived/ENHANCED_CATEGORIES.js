/**
 * ENHANCED_CATEGORIES.js
 * Ù†Ø¸Ø§Ù… ØªØµÙ†ÙŠÙØ§Øª Ø´Ø§Ù…Ù„ - Ø£Ø³Ø§Ø³ÙŠ ÙˆÙØ±Ø¹ÙŠ
 * Based on user requirements for comprehensive categorization
 */

/**
 * Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ÙØ±Ø¹ÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©
 */
var CATEGORIES_ENHANCED = {
  // 1. Ø§Ù„Ø·Ø¹Ø§Ù… ÙˆØ§Ù„Ø´Ø±Ø§Ø¨
  'Food & Dining': {
    icon: 'ğŸ½ï¸',
    subcategories: [
      'Ù…Ø·Ø§Ø¹Ù…',
      'ÙƒØ§ÙÙŠÙ‡Ø§Øª',
      'ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©',
      'Ø¨Ù‚Ø§Ù„Ø©',
      'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª',
      'Ù…Ø®Ø§Ø¨Ø²',
      'Ø­Ù„ÙˆÙŠØ§Øª',
      'ØªÙˆØµÙŠÙ„ Ø·Ø¹Ø§Ù…'
    ]
  },
  
  // 2. Ø§Ù„Ù†Ù‚Ù„ ÙˆØ§Ù„Ù…ÙˆØ§ØµÙ„Ø§Øª
  'Transportation': {
    icon: 'ğŸš—',
    subcategories: [
      'ÙˆÙ‚ÙˆØ¯ (Ø¨Ù†Ø²ÙŠÙ†)',
      'Ø£ÙˆØ¨Ø±/ÙƒØ±ÙŠÙ…',
      'ØµÙŠØ§Ù†Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
      'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±',
      'ØºØ³ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
      'Ù…ÙˆØ§Ù‚Ù',
      'ØªØ£Ù…ÙŠÙ† Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
      'Ø±Ø³ÙˆÙ… Ø·Ø±Ù‚'
    ]
  },
  
  // 3. Ø§Ù„ØªØ³ÙˆÙ‚
  'Shopping': {
    icon: 'ğŸ›ï¸',
    subcategories: [
      'Ù…Ù„Ø§Ø¨Ø³',
      'Ø£Ø­Ø°ÙŠØ©',
      'Ø¥ÙƒØ³Ø³ÙˆØ§Ø±Ø§Øª',
      'Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ§Øª',
      'Ø£Ø«Ø§Ø«',
      'Ø¯ÙŠÙƒÙˆØ± Ù…Ù†Ø²Ù„ÙŠ',
      'Ù‡Ø¯Ø§ÙŠØ§',
      'ÙƒØªØ¨',
      'Ø£Ù„Ø¹Ø§Ø¨'
    ]
  },
  
  // 4. Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø®Ø¯Ù…Ø§Øª
  'Bills & Utilities': {
    icon: 'ğŸ“„',
    subcategories: [
      'ÙƒÙ‡Ø±Ø¨Ø§Ø¡',
      'Ù…Ø§Ø¡',
      'Ø¬ÙˆØ§Ù„ (STC/Zain/Mobily)',
      'Ø¥Ù†ØªØ±Ù†Øª Ù…Ù†Ø²Ù„ÙŠ',
      'Ø±Ø³ÙˆÙ… Ø­ÙƒÙˆÙ…ÙŠØ©',
      'Ø±Ø³ÙˆÙ… Ø¨Ù†ÙƒÙŠØ©',
      'Ø§Ø´ØªØ±Ø§ÙƒØ§Øª',
      'ØµÙŠØ§Ù†Ø© Ù…Ù†Ø²Ù„'
    ]
  },
  
  // 5. Ø§Ù„ØªØ±ÙÙŠÙ‡
  'Entertainment': {
    icon: 'ğŸ¬',
    subcategories: [
      'Ø³ÙŠÙ†Ù…Ø§',
      'Ø£Ù„Ø¹Ø§Ø¨ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©',
      'Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø±Ù‚Ù…ÙŠØ© (Netflix/Shahid)',
      'Ø±Ø­Ù„Ø§Øª ØªØ±ÙÙŠÙ‡ÙŠØ©',
      'Ø­ÙÙ„Ø§Øª ÙˆÙ…Ù†Ø§Ø³Ø¨Ø§Øª',
      'Ù‡ÙˆØ§ÙŠØ§Øª',
      'Ø±ÙŠØ§Ø¶Ø©',
      'Ø³ÙØ± ÙˆØ³ÙŠØ§Ø­Ø©'
    ]
  },
  
  // 6. Ø§Ù„ØµØ­Ø©
  'Healthcare': {
    icon: 'ğŸ¥',
    subcategories: [
      'Ù…Ø³ØªØ´ÙÙŠØ§Øª',
      'Ø¹ÙŠØ§Ø¯Ø§Øª',
      'Ø£Ø¯ÙˆÙŠØ©',
      'ØµÙŠØ¯Ù„ÙŠØ§Øª',
      'ØªØ£Ù…ÙŠÙ† ØµØ­ÙŠ',
      'ØªØ­Ø§Ù„ÙŠÙ„ Ø·Ø¨ÙŠØ©',
      'Ù†Ø¸Ø§Ø±Ø§Øª',
      'Ø£Ø³Ù†Ø§Ù†'
    ]
  },
  
  // 7. Ø§Ù„ØªØ¹Ù„ÙŠÙ…
  'Education': {
    icon: 'ğŸ“š',
    subcategories: [
      'Ø±Ø³ÙˆÙ… Ø¯Ø±Ø§Ø³ÙŠØ©',
      'Ø¯ÙˆØ±Ø§Øª ØªØ¯Ø±ÙŠØ¨ÙŠØ©',
      'ÙƒØªØ¨ Ø¯Ø±Ø§Ø³ÙŠØ©',
      'Ù‚Ø±Ø·Ø§Ø³ÙŠØ©',
      'Ø¯Ø±ÙˆØ³ Ø®ØµÙˆØµÙŠØ©',
      'Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©'
    ]
  },
  
  // 8. Ø§Ù„Ø¹Ø§Ø¦Ù„Ø© ÙˆØ§Ù„Ø£Ø·ÙØ§Ù„
  'Family & Kids': {
    icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦',
    subcategories: [
      'Ø­ÙØ§Ø¶Ø§Øª',
      'Ø£Ù„Ø¹Ø§Ø¨ Ø£Ø·ÙØ§Ù„',
      'Ù…Ù„Ø§Ø¨Ø³ Ø£Ø·ÙØ§Ù„',
      'Ø­Ø¶Ø§Ù†Ø©',
      'Ù…ØµØ±ÙˆÙ Ø£Ø·ÙØ§Ù„',
      'Ø£Ù†Ø´Ø·Ø© Ø£Ø·ÙØ§Ù„'
    ]
  },
  
  // 9. Ø§Ù„Ø¬Ù…Ø§Ù„ ÙˆØ§Ù„Ø¹Ù†Ø§ÙŠØ© Ø§Ù„Ø´Ø®ØµÙŠØ©
  'Personal Care': {
    icon: 'ğŸ’…',
    subcategories: [
      'ØµØ§Ù„ÙˆÙ† Ø­Ù„Ø§Ù‚Ø©',
      'Ù…Ø³ØªØ­Ø¶Ø±Ø§Øª ØªØ¬Ù…ÙŠÙ„',
      'Ø¹Ø·ÙˆØ±',
      'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¨Ø´Ø±Ø©',
      'Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø´Ø¹Ø±',
      'Ù…Ù†ØªØ¬Ø§Øª ØµØ­ÙŠØ©'
    ]
  },
  
  // 10. Ø§Ù„Ù…Ù†Ø²Ù„
  'Home & Garden': {
    icon: 'ğŸ ',
    subcategories: [
      'Ø¥ÙŠØ¬Ø§Ø±',
      'Ø£Ø¯ÙˆØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©',
      'Ù†Ø¨Ø§ØªØ§Øª',
      'ØªÙ†Ø¸ÙŠÙ',
      'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…Ø·Ø¨Ø®',
      'ÙØ±Ø´ ÙˆØ³Ø¬Ø§Ø¯'
    ]
  },
  
  // 11. Ø§Ù„Ø£Ù‚Ø³Ø§Ø·
  'Installments': {
    icon: 'ğŸ’³',
    subcategories: [
      'ØªØ§Ø¨ÙŠ (Tabby)',
      'ØªÙ…Ø§Ø±Ø§ (Tamara)',
      'Ø£Ù‚Ø³Ø§Ø· Ø¨Ù†ÙƒÙŠØ©',
      'ØªÙ…ÙˆÙŠÙ„ Ø´Ø®ØµÙŠ',
      'ØªÙ‚Ø³ÙŠØ· Ù…ØªØ¬Ø±'
    ]
  },
  
  // 12. Ø§Ù„ØªØ¨Ø±Ø¹Ø§Øª ÙˆØ§Ù„Ø²ÙƒØ§Ø©
  'Charity & Donations': {
    icon: 'ğŸ¤²',
    subcategories: [
      'Ø²ÙƒØ§Ø©',
      'ØµØ¯Ù‚Ø©',
      'Ø¬Ù…Ø¹ÙŠØ§Øª Ø®ÙŠØ±ÙŠØ©',
      'ÙˆÙ‚Ù',
      'ÙƒÙØ§Ù„Ø© ÙŠØªÙŠÙ…',
      'Ù…Ø³Ø§Ø¹Ø¯Ø§Øª'
    ]
  },
  
  // 13. Ø§Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± ÙˆØ§Ù„Ø§Ø¯Ø®Ø§Ø±
  'Investment & Savings': {
    icon: 'ğŸ’°',
    subcategories: [
      'Ø§Ø¯Ø®Ø§Ø± Ø´Ù‡Ø±ÙŠ',
      'Ø£Ø³Ù‡Ù…',
      'Ø¹Ù‚Ø§Ø±Ø§Øª',
      'Ø°Ù‡Ø¨',
      'ØµÙ†Ø§Ø¯ÙŠÙ‚ Ø§Ø³ØªØ«Ù…Ø§Ø±ÙŠØ©',
      'ØªØ£Ù…ÙŠÙ† Ø§Ø¯Ø®Ø§Ø±ÙŠ'
    ]
  },
  
  // 14. Ø§Ù„Ø¹Ù…Ù„ ÙˆØ§Ù„Ù…Ù‡Ù†Ø©
  'Work & Business': {
    icon: 'ğŸ’¼',
    subcategories: [
      'Ø£Ø¯ÙˆØ§Øª Ø¹Ù…Ù„',
      'Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª Ø¹Ù…Ù„',
      'ØªØ·ÙˆÙŠØ± Ù…Ù‡Ù†ÙŠ',
      'ØªØ±Ø§Ø®ÙŠØµ Ø¹Ù…Ù„',
      'Ù…ØµØ§Ø±ÙŠÙ Ù…ÙƒØªØ¨',
      'Ø§Ø³ØªØ´Ø§Ø±Ø§Øª'
    ]
  },
  
  // 15. Ø§Ù„ØªØ£Ù…ÙŠÙ†Ø§Øª
  'Insurance': {
    icon: 'ğŸ›¡ï¸',
    subcategories: [
      'ØªØ£Ù…ÙŠÙ† Ø·Ø¨ÙŠ',
      'ØªØ£Ù…ÙŠÙ† Ø³ÙŠØ§Ø±Ø©',
      'ØªØ£Ù…ÙŠÙ† Ù…Ù†Ø²Ù„',
      'ØªØ£Ù…ÙŠÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø­ÙŠØ§Ø©',
      'ØªØ£Ù…ÙŠÙ†Ø§Øª Ø£Ø®Ø±Ù‰'
    ]
  },
  
  // 16. Ø§Ù„Ø­ÙˆØ§Ù„Ø§Øª - Ø¬Ø¯ÙŠØ¯
  'Transfers': {
    icon: 'ğŸ”„',
    subcategories: [
      'Ø­ÙˆØ§Ù„Ø© Ù„Ø£Ø­Ø¯ Ø§Ù„Ø£Ù‚Ø§Ø±Ø¨',
      'Ø­ÙˆØ§Ù„Ø© Ù„ØµØ¯ÙŠÙ‚',
      'Ø³Ù„ÙØ© (Ù‚Ø±Ø¶)',
      'Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ù…Ø¨Ù„Øº',
      'Ø­ÙˆØ§Ù„Ø© Ø¨ÙŠÙ† Ø­Ø³Ø§Ø¨Ø§ØªÙŠ',
      'Ù…ØµØ§Ø±ÙŠÙ Ù…Ø´ØªØ±ÙƒØ©'
    ]
  },
  
  // 17. Ø£Ø®Ø±Ù‰
  'Other': {
    icon: 'ğŸ“¦',
    subcategories: [
      'ØºÙŠØ± Ù…ØµÙ†Ù',
      'Ù†Ø«Ø±ÙŠØ§Øª',
      'Ø·ÙˆØ§Ø±Ø¦',
      'Ù…ØªÙ†ÙˆØ¹Ø©'
    ]
  }
};

/**
 * Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙÙŠ Google Sheets
 */
function createCategoriesSheet() {
  var sheetId = PropertiesService.getScriptProperties().getProperty('SHEET_ID');
  if (!sheetId) {
    throw new Error('SHEET_ID not found');
  }
  
  var ss = SpreadsheetApp.openById(sheetId);
  
  // Ø­Ø°Ù Ø§Ù„ÙˆØ±Ù‚Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ù† ÙˆØ¬Ø¯Øª
  var existingSheet = ss.getSheetByName('Categories');
  if (existingSheet) {
    ss.deleteSheet(existingSheet);
  }
  
  // Ø¥Ù†Ø´Ø§Ø¡ ÙˆØ±Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©
  var sheet = ss.insertSheet('Categories');
  
  // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø±Ø£Ø³
  var headers = ['Main Category', 'Icon', 'Subcategory', 'Is Active', 'Notes'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø±Ø£Ø³
  sheet.getRange(1, 1, 1, headers.length)
    .setBackground('#667eea')
    .setFontColor('#ffffff')
    .setFontWeight('bold')
    .setHorizontalAlignment('center');
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
  var data = [];
  var categories = Object.keys(CATEGORIES_ENHANCED);
  
  categories.forEach(function(mainCat) {
    var catInfo = CATEGORIES_ENHANCED[mainCat];
    var subcats = catInfo.subcategories || [];
    
    if (subcats.length === 0) {
      data.push([mainCat, catInfo.icon, '', 'Ù†Ø¹Ù…', '']);
    } else {
      subcats.forEach(function(subcat, index) {
        data.push([
          index === 0 ? mainCat : '',
          index === 0 ? catInfo.icon : '',
          subcat,
          'Ù†Ø¹Ù…',
          ''
        ]);
      });
    }
  });
  
  if (data.length > 0) {
    sheet.getRange(2, 1, data.length, 5).setValues(data);
  }
  
  // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
  sheet.setColumnWidth(1, 200); // Main Category
  sheet.setColumnWidth(2, 60);  // Icon
  sheet.setColumnWidth(3, 200); // Subcategory
  sheet.setColumnWidth(4, 100); // Is Active
  sheet.setColumnWidth(5, 250); // Notes
  
  // ØªØ¬Ù…ÙŠØ¯ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„
  sheet.setFrozenRows(1);
  
  // Ø¥Ø¶Ø§ÙØ© Ø­Ø¯ÙˆØ¯
  var lastRow = sheet.getLastRow();
  sheet.getRange(1, 1, lastRow, 5).setBorder(
    true, true, true, true, true, true,
    '#e0e0e0', SpreadsheetApp.BorderStyle.SOLID
  );
  
  // RTL direction
  sheet.setRightToLeft(true);
  
  Logger.log('âœ… Categories sheet created with ' + categories.length + ' main categories');
  return sheet;
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª
 */
function getAllCategories() {
  return Object.keys(CATEGORIES_ENHANCED);
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ù„ØªØµÙ†ÙŠÙ Ø±Ø¦ÙŠØ³ÙŠ
 */
function getSubcategories(mainCategory) {
  if (CATEGORIES_ENHANCED[mainCategory]) {
    return CATEGORIES_ENHANCED[mainCategory].subcategories || [];
  }
  return [];
}

/**
 * Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„ØªØµÙ†ÙŠÙ
 */
function getCategoryIcon(mainCategory) {
  if (CATEGORIES_ENHANCED[mainCategory]) {
    return CATEGORIES_ENHANCED[mainCategory].icon || 'ğŸ“¦';
  }
  return 'ğŸ“¦';
}

/**
 * ØªØµÙ†ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±
 */
function autoClassifyMerchant(merchantName) {
  var merchant = String(merchantName || '').toLowerCase();
  
  // Food & Dining
  if (merchant.match(/starbucks|Ù…Ù‚Ù‡Ù‰|coffee|cafe|restaurant|Ù…Ø·Ø¹Ù…|burger|pizza|kfc|mcdon|subway|herfy|Ø¨ÙŠÙƒ|Ø§Ù„Ø¨Ø§Ø´Ø§/)) {
    return { main: 'Food & Dining', sub: merchant.match(/starbucks|coffee|cafe|Ù…Ù‚Ù‡Ù‰/) ? 'ÙƒØ§ÙÙŠÙ‡Ø§Øª' : 'Ù…Ø·Ø§Ø¹Ù…' };
  }
  
  // Transportation
  if (merchant.match(/petro|Ø¨ØªØ±Ùˆ|ÙˆÙ‚ÙˆØ¯|benzin|fuel|uber|careem|ÙƒØ±ÙŠÙ…|Ø£ÙˆØ¨Ø±/)) {
    return { main: 'Transportation', sub: merchant.match(/uber|careem|ÙƒØ±ÙŠÙ…|Ø£ÙˆØ¨Ø±/) ? 'Ø£ÙˆØ¨Ø±/ÙƒØ±ÙŠÙ…' : 'ÙˆÙ‚ÙˆØ¯ (Ø¨Ù†Ø²ÙŠÙ†)' };
  }
  
  // Shopping
  if (merchant.match(/panda|carrefour|ÙƒØ§Ø±ÙÙˆØ±|danube|tamimi|Ø¹Ø«ÙŠÙ…|lulu|mall|Ø³Ù†ØªØ±|center/)) {
    return { main: 'Shopping', sub: 'Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª' };
  }
  
  // Bills
  if (merchant.match(/stc|mobily|zain|jawwy|electricity|ÙƒÙ‡Ø±Ø¨Ø§Ø¡|sec|saudi electric/)) {
    return { main: 'Bills & Utilities', sub: merchant.match(/stc|mobily|zain|jawwy/) ? 'Ø¬ÙˆØ§Ù„ (STC/Zain/Mobily)' : 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡' };
  }
  
  // Entertainment
  if (merchant.match(/cinema|Ø³ÙŠÙ†Ù…Ø§|vox|muvi|netflix|shahid|osn|playstation|xbox|steam/)) {
    return { main: 'Entertainment', sub: merchant.match(/netflix|shahid|osn/) ? 'Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø±Ù‚Ù…ÙŠØ© (Netflix/Shahid)' : 'Ø³ÙŠÙ†Ù…Ø§' };
  }
  
  // Healthcare
  if (merchant.match(/pharmacy|ØµÙŠØ¯Ù„ÙŠØ©|nahdi|Ø¯ÙˆØ§Ø¡|hospital|Ù…Ø³ØªØ´ÙÙ‰|clinic|Ø¹ÙŠØ§Ø¯Ø©/)) {
    return { main: 'Healthcare', sub: merchant.match(/pharmacy|ØµÙŠØ¯Ù„ÙŠØ©|nahdi|Ø¯ÙˆØ§Ø¡/) ? 'ØµÙŠØ¯Ù„ÙŠØ§Øª' : 'Ø¹ÙŠØ§Ø¯Ø§Øª' };
  }
  
  // Charity
  if (merchant.match(/Ø®ÙŠØ±ÙŠ|ØµØ¯Ù‚Ø©|Ø²ÙƒØ§Ø©|charity|donation|ÙˆÙ‚Ù/)) {
    return { main: 'Charity & Donations', sub: 'ØµØ¯Ù‚Ø©' };
  }
  
  // Installments
  if (merchant.match(/tabby|tamara|ØªØ§Ø¨ÙŠ|ØªÙ…Ø§Ø±Ø§/)) {
    return { main: 'Installments', sub: merchant.match(/tabby|ØªØ§Ø¨ÙŠ/) ? 'ØªØ§Ø¨ÙŠ (Tabby)' : 'ØªÙ…Ø§Ø±Ø§ (Tamara)' };
  }
  
  return { main: 'Other', sub: 'ØºÙŠØ± Ù…ØµÙ†Ù' };
}
