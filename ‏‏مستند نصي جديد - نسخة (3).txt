config,gs

/********** Sovereign V120 â€” R3.3 | Config.gs **********/

/** ENV Ù…Ù† Script Properties */
const ENV = (function () {
  var p = PropertiesService.getScriptProperties();
  return {
    OWNER: p.getProperty('OWNER') || 'Ø¯. Ø´Ø§ÙÙŠ',
    OWN_ACCOUNTS: (p.getProperty('OWN_ACCOUNTS') || '')
      .split(',')
      .map(function (s) { return s.trim(); })
      .filter(function (x) { return !!x; }),

    TELEGRAM_TOKEN: p.getProperty('TELEGRAM_TOKEN') || '',
    GROQ_KEY: p.getProperty('GROQ_KEY') || '',
    GEMINI_KEY: p.getProperty('GEMINI_KEY') || '',

    SHEET_ID: p.getProperty('SHEET_ID') || '',
    CHAT_ID: p.getProperty('CHAT_ID') || '',
    TG_SECRET_TOKEN: p.getProperty('TG_SECRET_TOKEN') || '',
    INGRESS_SECRET: p.getProperty('INGRESS_SECRET') || '',
    WEBAPP_URL: p.getProperty('WEBAPP_URL') || '',
    WEBAPP_URL_DIRECT: p.getProperty('WEBAPP_URL_DIRECT') || ''
  };
})();

function _ss() {
  return SpreadsheetApp.openById(ENV.SHEET_ID);
}

function _sheet(name) {
  var ss = _ss();
  return ss.getSheetByName(name) || ss.insertSheet(name);
}
``

Utlis.gs

/********** Sovereign V120 â€” R3.3 | Utils.gs **********/

function safeNotify(msg, optChatId) {
  try {
    SpreadsheetApp.getUi().alert(msg);
    return;
  } catch (e) { /* ignore */ }

  try {
    sendTelegram_(optChatId || ENV.CHAT_ID, msg);
  } catch (e2) { /* ignore */ }

  console.log(msg);
}

/** Ù…ÙØ­Ù„Ù‘Ù„ Ù…Ø¯Ø®Ù„Ø§Øª Ø¹Ø§Ù…: Telegram JSON Ø£Ùˆ JSON Ø¹Ø§Ù… {text:"..."} Ø£Ùˆ Ù†Øµ Ø¹Ø§Ø¯ÙŠ */
function _parseIncoming_(raw) {
  if (!raw) return { kind: 'none' };
  var s = String(raw).trim();

  if (s.charAt(0) === '{') {
    try {
      var obj = JSON.parse(s);

      // Telegram-like?
      if (obj.update_id || obj.message || obj.channel_post || obj.callback_query) {
        return { kind: 'telegram', update: obj };
      }

      // Generic JSON -> text/body/message/content
      var txt = obj.text || obj.message || obj.body || obj.content;
      if (typeof txt === 'string' && txt.length) return { kind: 'text', text: txt };

    } catch (e) {
      // treat as plain text
    }
  }
  return { kind: 'text', text: raw };
}

function isDuplicateV120(key) {
  var cache = CacheService.getScriptCache();
  if (cache.get(key)) return true;
  cache.put(key, '1', 600);
  return false;
}

function emergencyResetV114() {
  CacheService.getScriptCache().removeAll(['last_id']);
}

Ingress.gs

/********** Ingress.gs â€” FINAL (Search + Manual Add + Menu + Dedup + Error-only log) **********
 * âœ… ÙŠØ³Ø¬Ù‘Ù„ ÙÙ‚Ø·: FORBIDDEN Ø£Ùˆ ERROR ÙÙŠ ÙˆØ±Ù‚Ø© Ingress_Debug (Ù„Ø§ ÙŠÙ„ÙˆÙ‘Ø« Sheet1)
 * âœ… ÙŠØ¯Ø¹Ù… MAINTENANCE_MODE=on Ù„Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ø¤Ù‚ØªÙ‹Ø§
 * âœ… Telegram:
 *    /menu Ø£Ùˆ /menu@Bot â†’ Ø¥Ø±Ø³Ø§Ù„ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Reply Keyboard) Ù…Ù† Telegram.gs
 *    /menu_off â†’ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø©
 *    Ø¨Ø­Ø«: ÙƒÙ„Ù…Ø©  Ø£Ùˆ /search ÙƒÙ„Ù…Ø©  â†’ Ø¨Ø­Ø« ÙÙŠ Ø¢Ø®Ø± 200 Ø¹Ù…Ù„ÙŠØ©
 *    Ø£Ø¶Ù: Ù…Ø¨Ù„Øº | Ø¬Ù‡Ø© | ØªØµÙ†ÙŠÙ  Ø£Ùˆ /add ... â†’ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ
 *    Ø£Ø²Ø±Ø§Ø± Reply Keyboard (ğŸ“Š ØªÙ‚Ø±ÙŠØ± / Ø¢Ø®Ø± 5 / Ø¢Ø®Ø± 10 / Ø§Ù„ÙŠÙˆÙ… / Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ / Ø§Ù„Ø´Ù‡Ø±)
 * âœ… iPhone Shortcuts:
 *    POST JSON {text:"...", source:"ios_sms"} Ø¹Ù„Ù‰ Ø±Ø§Ø¨Ø· ÙÙŠÙ‡ ?secret=INGRESS-2026
 *    ÙˆÙŠÙØ±Ø¬Ø¹ JSON Ø¨Ø³ÙŠØ·: {"ok":true,"kind":"iphone"}
 *********************************************************************************************/

function doGet(e) {
  var secretParam = e && e.parameter && e.parameter.secret;

  if (ENV.INGRESS_SECRET && secretParam && secretParam !== ENV.INGRESS_SECRET) {
    logIngressEvent_('FORBIDDEN', 'doGet', { reason: 'secret mismatch' }, JSON.stringify(e || {}));
    return ContentService.createTextOutput('FORBIDDEN').setMimeType(ContentService.MimeType.TEXT);
  }

  var sms = (e && e.parameter && e.parameter.sms) ? e.parameter.sms : 'ÙØ­Øµ doGet';
  executeUniversalFlowV120(sms, 'Ø¢ÙŠÙÙˆÙ† (GET)', null);
  return ContentService.createTextOutput('âœ… Ù…Ø³Ø§Ø± doGet Ø³Ù„ÙŠÙ…').setMimeType(ContentService.MimeType.TEXT);
}

function _prop_(k, fallback) {
  try { return PropertiesService.getScriptProperties().getProperty(k) || (fallback || ''); }
  catch (e) { return (fallback || ''); }
}

function _normCmd_(text) {
  var s = String(text || '').trim();
  if (!s) return '';
  s = s.split(/\s+/)[0];
  s = s.split('@')[0]; // /cmd@bot â†’ /cmd
  return s;
}

function logIngressEvent_(level, where, meta, raw) {
  try {
    var sh = _sheet('Ingress_Debug');
    if (sh.getLastRow() === 0) {
      sh.appendRow(['Ø§Ù„ÙˆÙ‚Øª', 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰', 'Ø§Ù„Ù…Ø³Ø§Ø±', 'Ø¨ÙŠØ§Ù†Ø§Øª', 'Ù†Øµ Ù…Ø®ØªØµØ±']);
      sh.setFrozenRows(1);
      sh.setRightToLeft(true);
      sh.getRange('A:A').setNumberFormat('yyyy-MM-dd HH:mm:ss');
    }
    var metaStr = '';
    try { metaStr = JSON.stringify(meta || {}); } catch (e) { metaStr = String(meta || ''); }

    sh.appendRow([
      new Date(),
      String(level || ''),
      String(where || ''),
      metaStr.slice(0, 1200),
      String(raw || '').slice(0, 900)
    ]);
  } catch (e2) {}
}

function jsonOut_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj || {}))
    .setMimeType(ContentService.MimeType.JSON);
}

/** Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Dedup) Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚ */
function isDuplicateText_(prefix, text) {
  var s = String(text || '');
  var sig = Utilities.base64EncodeWebSafe(
    Utilities.computeDigest(Utilities.DigestAlgorithm.SHA_256, s)
  ).slice(0, 20);
  var key = prefix + '_' + sig;
  var cache = CacheService.getScriptCache();
  if (cache.get(key)) return true;
  cache.put(key, '1', 600);
  return false;
}

function normalizeNumber_(s) {
  s = String(s || '').trim();
  var map = {'Ù ':'0','Ù¡':'1','Ù¢':'2','Ù£':'3','Ù¤':'4','Ù¥':'5','Ù¦':'6','Ù§':'7','Ù¨':'8','Ù©':'9','Ù«':'.','Ù¬':','};
  s = s.replace(/[Ù -Ù©Ù«Ù¬]/g, function(ch){ return map[ch] || ch; });
  s = s.replace(/,/g, '').replace(/\s+/g, '');
  return s;
}

/** ğŸ” Ø¨Ø­Ø« Ø¢Ø®Ø± 200 Ø¹Ù…Ù„ÙŠØ© */
function V120_searchLast200_(keyword, chatId) {
  keyword = String(keyword || '').trim().toLowerCase();
  if (!keyword) { sendTelegram_(chatId, 'ğŸ” Ø§ÙƒØªØ¨: Ø¨Ø­Ø«: ÙƒÙ„Ù…Ø©'); return; }

  var s1 = _sheet('Sheet1');
  var last = s1.getLastRow();
  if (last < 2) { sendTelegram_(chatId, 'ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯.'); return; }

  var n = Math.min(200, last - 1);
  var start = last - n + 1;
  var rows = s1.getRange(start, 1, n, 12).getValues();

  var hits = [];
  for (var i = rows.length - 1; i >= 0; i--) {
    var r = rows[i];
    var dt = (r[0] instanceof Date) ? Utilities.formatDate(r[0], Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm') : '';
    var amt = Number(r[7]) || 0;
    var merch = String(r[8] || '').toLowerCase();
    var cat = String(r[9] || '').toLowerCase();
    var raw = String(r[11] || '').toLowerCase();

    if (merch.indexOf(keyword) !== -1 || cat.indexOf(keyword) !== -1 || raw.indexOf(keyword) !== -1) {
      hits.push('â€¢ ' + dt + ' | ' + amt.toFixed(2) + ' | ' + (r[8] || '') + ' | ' + (r[9] || ''));
      if (hits.length >= 10) break;
    }
  }

  if (!hits.length) { sendTelegram_(chatId, 'ğŸ” Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù€: ' + keyword); return; }
  sendTelegram_(chatId, 'ğŸ” Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« (Ø¢Ø®Ø± ' + n + '):\n' + hits.join('\n'));
}

/** â• Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ: Ø£Ø¶Ù: Ù…Ø¨Ù„Øº | Ø¬Ù‡Ø© | ØªØµÙ†ÙŠÙ */
function V120_addManual_(payload, chatId) {
  var s = String(payload || '').trim();
  if (!s) { sendTelegram_(chatId, 'â• Ù…Ø«Ø§Ù„: Ø£Ø¶Ù: 45.75 | Ù…Ø·Ø¹Ù… | Ù…Ø·Ø§Ø¹Ù…'); return; }

  var parts = s.split('|').map(function(x){return x.trim();}).filter(Boolean);
  if (parts.length < 3) parts = s.split(/[ØŒ,]/).map(function(x){return x.trim();}).filter(Boolean);
  if (parts.length < 3) { sendTelegram_(chatId, 'â— ØµÙŠØºØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.\nÙ…Ø«Ø§Ù„: Ø£Ø¶Ù: 45.75 | Ù…Ø·Ø¹Ù… | Ù…Ø·Ø§Ø¹Ù…'); return; }

  var amt = Number(normalizeNumber_(parts[0]));
  if (!isFinite(amt) || amt === 0) { sendTelegram_(chatId, 'â— Ø§Ù„Ù…Ø¨Ù„Øº ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }

  var merchant = parts[1];
  var category = parts.slice(2).join(' | ');

  // Ø³Ø§Ù„Ø¨ = ÙˆØ§Ø±Ø¯ØŒ Ù…ÙˆØ¬Ø¨ = ØµØ§Ø¯Ø±
  var isIncoming = (amt < 0);
  var amountAbs = Math.abs(amt);

  var ai = {
    merchant: merchant,
    amount: amountAbs,
    currency: 'SAR',
    category: category,
    type: isIncoming ? 'Ø­ÙˆØ§Ù„Ø©' : 'Ù…Ø´ØªØ±ÙŠØ§Øª',
    isIncoming: isIncoming,
    accNum: '',
    cardNum: ''
  };

  try {
    var sync = syncQuadV120(ai, 'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ: ' + s, 'Ø¥Ø¯Ø®Ø§Ù„_ÙŠØ¯ÙˆÙŠ');
    sendSovereignReportV120(ai, sync, 'Ø¥Ø¯Ø®Ø§Ù„_ÙŠØ¯ÙˆÙŠ', 'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ: ' + s, chatId);
    sendTelegram_(chatId, 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ.');
  } catch (e) {
    logIngressEvent_('ERROR', 'manual_add', { error: String(e) }, s);
    sendTelegram_(chatId, 'âš ï¸ ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙŠØ¯ÙˆÙŠ. Ø±Ø§Ø¬Ø¹ Ingress_Debug.');
  }
}

function doPost(e) {
  // âœ… ØµÙŠØ§Ù†Ø©
  if ((_prop_('MAINTENANCE_MODE', '') || '').toLowerCase() === 'on') {
    return jsonOut_({ ok: true, maintenance: true });
  }

  var raw = (e && e.postData && e.postData.contents) ? e.postData.contents : '';
  var parsed = _parseIncoming_(raw);

  try {
    var urlSecret = (e && e.parameter && e.parameter.secret) ? String(e.parameter.secret) : '';
    var headerIngress = (e && e.headers && (e.headers['X-INGRESS-SECRET'] || e.headers['x-ingress-secret'])) || '';

    // ===== Telegram =====
    if (parsed.kind === 'telegram') {
      // Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ?secret=... ÙÙŠ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆÙŠØ¨Ù‡ÙˆÙƒ
      var okByUrl = !!(ENV.INGRESS_SECRET && urlSecret && (urlSecret === String(ENV.INGRESS_SECRET)));
      if (!okByUrl) {
        logIngressEvent_('FORBIDDEN', 'telegram_auth', { urlSecret_present: !!urlSecret }, raw);
        return ContentService.createTextOutput('FORBIDDEN').setMimeType(ContentService.MimeType.TEXT);
      }

      var update = parsed.update;
      if (update.update_id && isDuplicateV120('tg_' + update.update_id)) return jsonOut_({ ok: true, kind: 'telegram', dup: true });

      // Inline callback: Ø¥Ù† ÙƒÙ†Øª ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ Telegram.gs (Ù‚Ø¯ÙŠÙ…Ø©)
      if (update.callback_query) {
        handleInteractionV120(update.callback_query);
        return jsonOut_({ ok: true, kind: 'telegram', cb: true });
      }

      var msg = update.message || update.channel_post || {};
      var text = msg.text || msg.caption || '';
      var chatId = (msg.chat && msg.chat.id) ? String(msg.chat.id) : '';

      // Dedup Ø±Ø³Ø§Ø¦Ù„ ÙŠØ¯ÙˆÙŠØ© Ø³Ø±ÙŠØ¹Ø©
      if (isDuplicateText_('tg_text', text)) return jsonOut_({ ok: true, kind: 'telegram', dupText: true });

      var cmd = _normCmd_(text);

      // /menu Ùˆ /menu_off (ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¯ÙˆØ§Ù„ ÙÙŠ Telegram.gs)
      if (cmd === '/menu' || cmd === '/start') {
        if (typeof V120_sendMenuPanel_ === 'function') V120_sendMenuPanel_(chatId);
        else sendTelegram_(chatId, 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ØºÙŠØ± Ù…ØªØ§Ø­Ø©. ØªØ£ÙƒØ¯ Ù…Ù† Telegram.gs');
        return jsonOut_({ ok: true, kind: 'telegram', menu: true });
      }
      if (cmd === '/menu_off') {
        if (typeof V120_removeMenuPanel_ === 'function') V120_removeMenuPanel_(chatId);
        return jsonOut_({ ok: true, kind: 'telegram', menuOff: true });
      }

      // Ø£ÙˆØ§Ù…Ø± Ø§Ù„Ù„ÙˆØ­Ø© (Reply Keyboard): Ù†ØµÙˆØµ Ø¬Ø§Ù‡Ø²Ø©
      if (text === 'ğŸ“Š ØªÙ‚Ø±ÙŠØ±' || text === 'ØªÙ‚Ø±ÙŠØ±') { sendBudgetsSnapshotToTelegram_(); return jsonOut_({ ok: true, kind: 'telegram', report: true }); }
      if (text === 'ğŸ§¾ Ø¢Ø®Ø± 5') { sendLastNToTelegram_(chatId, 5); return jsonOut_({ ok: true, kind: 'telegram', last5: true }); }
      if (text === 'ğŸ§¾ Ø¢Ø®Ø± 10') { sendLastNToTelegram_(chatId, 10); return jsonOut_({ ok: true, kind: 'telegram', last10: true }); }
      if (text === 'ğŸ“… Ø§Ù„ÙŠÙˆÙ…') { sendPeriodSummary_(chatId, 'today'); return jsonOut_({ ok: true, kind: 'telegram', today: true }); }
      if (text === 'ğŸ—“ï¸ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹') { sendPeriodSummary_(chatId, 'week'); return jsonOut_({ ok: true, kind: 'telegram', week: true }); }
      if (text === 'ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±') { sendPeriodSummary_(chatId, 'month'); return jsonOut_({ ok: true, kind: 'telegram', month: true }); }

      // ğŸ” Ø¨Ø­Ø«
      if (text === 'ğŸ” Ø¨Ø­Ø«') { sendTelegram_(chatId, 'Ø§ÙƒØªØ¨: Ø¨Ø­Ø«: ÙƒÙ„Ù…Ø©'); return jsonOut_({ ok: true, kind: 'telegram', searchPrompt: true }); }
      if (text.trim().indexOf('Ø¨Ø­Ø«:') === 0) { V120_searchLast200_(text.replace(/^Ø¨Ø­Ø«:/,'').trim(), chatId); return jsonOut_({ ok: true, kind: 'telegram', search: true }); }
      if (cmd === '/search') { V120_searchLast200_(text.replace(/^\/search/i,'').trim(), chatId); return jsonOut_({ ok: true, kind: 'telegram', search: true }); }

      // â• Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ
      if (text === 'â• Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ') { sendTelegram_(chatId, 'Ø§ÙƒØªØ¨: Ø£Ø¶Ù: 45.75 | Ø¬Ù‡Ø© | ØªØµÙ†ÙŠÙ'); return jsonOut_({ ok: true, kind: 'telegram', addPrompt: true }); }
      if (text.trim().indexOf('Ø£Ø¶Ù:') === 0) { V120_addManual_(text.replace(/^Ø£Ø¶Ù:/,'').trim(), chatId); return jsonOut_({ ok: true, kind: 'telegram', add: true }); }
      if (cmd === '/add') { V120_addManual_(text.replace(/^\/add/i,'').trim(), chatId); return jsonOut_({ ok: true, kind: 'telegram', add: true }); }

      // Ø®Ù„Ø§Ù Ø°Ù„Ùƒ: Ù…Ø³Ø§Ø± Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¹Ø§Ø¯ÙŠ
      if (text) executeUniversalFlowV120(text, update.channel_post ? 'Ù‚Ù†Ø§Ø© Ø§Ù„Ø±ØµØ¯' : 'ØªÙ„ÙŠØ¬Ø±Ø§Ù… (ÙŠØ¯ÙˆÙŠ)', chatId);
      return jsonOut_({ ok: true, kind: 'telegram', flow: true });
    }

    // ===== iPhone / non-Telegram =====
    if (ENV.INGRESS_SECRET && (urlSecret !== ENV.INGRESS_SECRET && headerIngress !== ENV.INGRESS_SECRET)) {
      logIngressEvent_('FORBIDDEN', 'iphone_auth', { urlSecret_present: !!urlSecret, headerIngress_present: !!headerIngress }, raw);
      return ContentService.createTextOutput('FORBIDDEN').setMimeType(ContentService.MimeType.TEXT);
    }

    // Dedup
    if (parsed.kind === 'text' && parsed.text && isDuplicateText_('iphone', parsed.text)) {
      return jsonOut_({ ok: true, kind: 'iphone', dup: true });
    }

    if (parsed.kind === 'text' && parsed.text) {
      executeUniversalFlowV120(parsed.text, 'Ø¢ÙŠÙÙˆÙ† (POST)', null);
      return jsonOut_({ ok: true, kind: 'iphone' });
    }

    return jsonOut_({ ok: true, kind: 'none' });

  } catch (err) {
    logIngressEvent_('ERROR', 'doPost', { error: String(err) }, raw);
    return jsonOut_({ ok: false, error: String(err) });
  }
}


/********** Flow.gs â€” Sync + Interlink Sheets (Budgets + Debt + Dashboard) **********/

function executeUniversalFlowV120(smsText, source, destChatId) {
  var ss = _ss();
  try {
    var ai = callAiHybridV120(smsText);
    ai = applyClassifierMap_(smsText, ai);

    var sync = syncQuadV120(ai, smsText, source);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ØµØ¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø¨Ø·Ø§Ù‚Ø© Ù†Ø¸ÙŠÙØ© Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø±)
    sendSovereignReportV120(ai, sync, source, smsText, destChatId);

  } catch (err) {
    try {
      ss.getSheetByName('Sheet1').appendRow([new Date(), 'FLOW_ERROR', '-', '-', source, '-', '-', '-', '-', '-', '-', err.toString()]);
    } catch (_) {}
  }
}

function ensureBudgetRowExists_(category) {
  category = String(category || '').trim();
  if (!category) return;

  var sB = _sheet('Budgets');
  var vals = sB.getDataRange().getValues();
  for (var i = 1; i < vals.length; i++) {
    if (String(vals[i][0] || '') === category) return;
  }

  var row = sB.getLastRow() + 1;
  sB.getRange(row, 1, 1, 4).setValues([[category, 0, 0, '=B' + row + '-C' + row]]);
}

/** ØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
function isInternalTransfer_(data) {
  var cat = String(data && data.category ? data.category : '');
  var typ = String(data && data.type ? data.type : '');
  // ØªÙˆØ³Ø¹Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ø­Ø³Ø¨ Ù‚Ø§Ù…ÙˆØ³Ùƒ
  return (cat.indexOf('Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ©') !== -1) || (typ.indexOf('Ø¯Ø§Ø®Ù„ÙŠØ©') !== -1);
}

/**
 * Ù…Ø²Ø§Ù…Ù†Ø© Ø±Ø¨Ø§Ø¹ÙŠØ©:
 * - Sheet1 (Ø³Ø¬Ù„)
 * - Budgets (Ù…ØµØ±ÙˆÙ)
 * - Debt_Ledger + Debt_Index (Ø­ÙˆØ§Ù„Ø§Øª/Ø­ÙˆÙ‘Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©)
 * - Dashboard (Ø®Ø§Ù…)
 */
function syncQuadV120(data, raw, source) {
  var now = new Date();
  var s1 = _sheet('Sheet1');
  var sB = _sheet('Budgets');
  var sD = _sheet('Debt_Ledger');
  var sDash = _sheet('Dashboard');

  // 1) Sheet1
  s1.appendRow([
    now, 'V120_AUTO', 'Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', source,
    data.accNum || '',
    data.cardNum || '',
    Number(data.amount) || 0,
    data.merchant || '',
    data.category || '',
    data.type || '',
    raw
  ]);

  // 2) Budgets â€” Ø£Ø¶Ù Ø§Ù„ØªØµÙ†ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø«Ù… Ø­Ø¯Ø« Ø§Ù„Ù…ØµØ±ÙˆÙ
  var bRem = 0;
  try {
    ensureBudgetRowExists_(data.category);

    var bData = sB.getDataRange().getValues();
    for (var i = 1; i < bData.length; i++) {
      if (String(bData[i][0] || '') === String(data.category || '')) {
        var current = Number(bData[i][2]) || 0;

        // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ: ÙˆØ§Ø±Ø¯ ÙŠÙ‚Ù„Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ø³Ø§Ù„Ø¨) ÙˆØµØ§Ø¯Ø± ÙŠØ²ÙŠØ¯Ù‡ (Ù…ÙˆØ¬Ø¨)
        var delta = data.isIncoming ? -(Number(data.amount) || 0) : (Number(data.amount) || 0);

        sB.getRange(i + 1, 3).setValue(current + delta);
        SpreadsheetApp.flush();
        bRem = Number(sB.getRange(i + 1, 4).getValue()) || 0;
        break;
      }
    }
  } catch (_) {}

  // 3) Debt_Ledger â€” ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (ØµØ§Ø¯Ø±Ø© = Ø¯Ø§Ø¦Ù†ØŒ ÙˆØ§Ø±Ø¯Ø© = Ù…Ø¯ÙŠÙ†)
  var dBal = 0;
  try {
    var internal = isInternalTransfer_(data);

    if (internal) {
      var amt = Number(data.amount) || 0;
      var party = data.merchant || 'ØªØ­ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ';

      // âœ… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ:
      // ÙˆØ§Ø±Ø¯Ø© => Ù…Ø¯ÙŠÙ† (C)
      // ØµØ§Ø¯Ø±Ø© => Ø¯Ø§Ø¦Ù† (D)
      var debtor = data.isIncoming ? amt : 0;
      var creditor = data.isIncoming ? 0 : amt;

      var desc = (data.isIncoming ? 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆØ§Ø±Ø¯Ø©' : 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØµØ§Ø¯Ø±Ø©') + ' - ' + party;

      sD.appendRow([now, party, debtor, creditor, '', desc]);
      SpreadsheetApp.flush();
      try { dBal = Number(sD.getRange(sD.getLastRow(), 5).getValue()) || 0; } catch (e1) {}

      // Ù„Ø§ Ù†Ø­Ø¯Ù‘Ø« Debt_Index Ù„Ù„Ø­ÙˆØ§Ù„Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ù„ÙŠØ³Øª Ø¯ÙŠÙ†Ù‹Ø§ Ø¹Ù„Ù‰ Ø·Ø±Ù Ø¹Ø§Ø¯Ø©)
      // Ø¥Ø°Ø§ Ø±ØºØ¨Øª Ù†Ø¶ÙŠÙ Ø®ÙŠØ§Ø± Ù„ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.
    } else {
      // Ù„Ù„Ø­ÙˆØ§Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©/Ø§Ù„Ø¯ÙŠÙˆÙ†: ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¨Ù‚Ø§Ø¡ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† Ø±ØºØ¨Øª
      // (Ù‡Ù†Ø§ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø´ÙŠØ¡ Ø­ØªÙ‰ Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ø³Ù„ÙˆÙƒÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯ÙˆÙ† Ø·Ù„Ø¨)
    }
  } catch (_) {}

  // 4) Dashboard raw (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  try {
    sDash.appendRow([now, data.merchant || '', Number(data.amount) || 0, data.category || '', source]);
  } catch (_) {}

  return { debt: dBal, budget: bRem };
}
Flow.gs

/********** Flow.gs â€” Sync + Interlink Sheets (Budgets + Debt + Dashboard) **********/

function executeUniversalFlowV120(smsText, source, destChatId) {
  var ss = _ss();
  try {
    var ai = callAiHybridV120(smsText);
    ai = applyClassifierMap_(smsText, ai);

    var sync = syncQuadV120(ai, smsText, source);

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ØµØ¯ Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© (Ø¨Ø·Ø§Ù‚Ø© Ù†Ø¸ÙŠÙØ© Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø±)
    sendSovereignReportV120(ai, sync, source, smsText, destChatId);

  } catch (err) {
    try {
      ss.getSheetByName('Sheet1').appendRow([new Date(), 'FLOW_ERROR', '-', '-', source, '-', '-', '-', '-', '-', '-', err.toString()]);
    } catch (_) {}
  }
}

function ensureBudgetRowExists_(category) {
  category = String(category || '').trim();
  if (!category) return;

  var sB = _sheet('Budgets');
  var vals = sB.getDataRange().getValues();
  for (var i = 1; i < vals.length; i++) {
    if (String(vals[i][0] || '') === category) return;
  }

  var row = sB.getLastRow() + 1;
  sB.getRange(row, 1, 1, 4).setValues([[category, 0, 0, '=B' + row + '-C' + row]]);
}

/** ØªØ­Ø¯ÙŠØ¯ Ù‡Ù„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© */
function isInternalTransfer_(data) {
  var cat = String(data && data.category ? data.category : '');
  var typ = String(data && data.type ? data.type : '');
  // ØªÙˆØ³Ø¹Ø© Ø§Ù„Ø´Ø±ÙˆØ· Ø­Ø³Ø¨ Ù‚Ø§Ù…ÙˆØ³Ùƒ
  return (cat.indexOf('Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ©') !== -1) || (typ.indexOf('Ø¯Ø§Ø®Ù„ÙŠØ©') !== -1);
}

/**
 * Ù…Ø²Ø§Ù…Ù†Ø© Ø±Ø¨Ø§Ø¹ÙŠØ©:
 * - Sheet1 (Ø³Ø¬Ù„)
 * - Budgets (Ù…ØµØ±ÙˆÙ)
 * - Debt_Ledger + Debt_Index (Ø­ÙˆØ§Ù„Ø§Øª/Ø­ÙˆÙ‘Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©)
 * - Dashboard (Ø®Ø§Ù…)
 */
function syncQuadV120(data, raw, source) {
  var now = new Date();
  var s1 = _sheet('Sheet1');
  var sB = _sheet('Budgets');
  var sD = _sheet('Debt_Ledger');
  var sDash = _sheet('Dashboard');

  // 1) Sheet1
  s1.appendRow([
    now, 'V120_AUTO', 'Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', source,
    data.accNum || '',
    data.cardNum || '',
    Number(data.amount) || 0,
    data.merchant || '',
    data.category || '',
    data.type || '',
    raw
  ]);

  // 2) Budgets â€” Ø£Ø¶Ù Ø§Ù„ØªØµÙ†ÙŠÙ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø«Ù… Ø­Ø¯Ø« Ø§Ù„Ù…ØµØ±ÙˆÙ
  var bRem = 0;
  try {
    ensureBudgetRowExists_(data.category);

    var bData = sB.getDataRange().getValues();
    for (var i = 1; i < bData.length; i++) {
      if (String(bData[i][0] || '') === String(data.category || '')) {
        var current = Number(bData[i][2]) || 0;

        // Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ: ÙˆØ§Ø±Ø¯ ÙŠÙ‚Ù„Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ (Ø³Ø§Ù„Ø¨) ÙˆØµØ§Ø¯Ø± ÙŠØ²ÙŠØ¯Ù‡ (Ù…ÙˆØ¬Ø¨)
        var delta = data.isIncoming ? -(Number(data.amount) || 0) : (Number(data.amount) || 0);

        sB.getRange(i + 1, 3).setValue(current + delta);
        SpreadsheetApp.flush();
        bRem = Number(sB.getRange(i + 1, 4).getValue()) || 0;
        break;
      }
    }
  } catch (_) {}

  // 3) Debt_Ledger â€” ØªØ·Ø¨ÙŠÙ‚ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø­ÙˆØ§Ù„Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (ØµØ§Ø¯Ø±Ø© = Ø¯Ø§Ø¦Ù†ØŒ ÙˆØ§Ø±Ø¯Ø© = Ù…Ø¯ÙŠÙ†)
  var dBal = 0;
  try {
    var internal = isInternalTransfer_(data);

    if (internal) {
      var amt = Number(data.amount) || 0;
      var party = data.merchant || 'ØªØ­ÙˆÙŠÙ„ Ø¯Ø§Ø®Ù„ÙŠ';

      // âœ… Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ:
      // ÙˆØ§Ø±Ø¯Ø© => Ù…Ø¯ÙŠÙ† (C)
      // ØµØ§Ø¯Ø±Ø© => Ø¯Ø§Ø¦Ù† (D)
      var debtor = data.isIncoming ? amt : 0;
      var creditor = data.isIncoming ? 0 : amt;

      var desc = (data.isIncoming ? 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ÙˆØ§Ø±Ø¯Ø©' : 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØµØ§Ø¯Ø±Ø©') + ' - ' + party;

      sD.appendRow([now, party, debtor, creditor, '', desc]);
      SpreadsheetApp.flush();
      try { dBal = Number(sD.getRange(sD.getLastRow(), 5).getValue()) || 0; } catch (e1) {}

      // Ù„Ø§ Ù†Ø­Ø¯Ù‘Ø« Debt_Index Ù„Ù„Ø­ÙˆØ§Ù„Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ© (Ù„ÙŠØ³Øª Ø¯ÙŠÙ†Ù‹Ø§ Ø¹Ù„Ù‰ Ø·Ø±Ù Ø¹Ø§Ø¯Ø©)
      // Ø¥Ø°Ø§ Ø±ØºØ¨Øª Ù†Ø¶ÙŠÙ Ø®ÙŠØ§Ø± Ù„ØªØ­Ø¯ÙŠØ«Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§.
    } else {
      // Ù„Ù„Ø­ÙˆØ§Ù„Ø§Øª Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©/Ø§Ù„Ø¯ÙŠÙˆÙ†: ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¨Ù‚Ø§Ø¡ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¥Ù† Ø±ØºØ¨Øª
      // (Ù‡Ù†Ø§ Ù„Ø§ Ù†Ø¶ÙŠÙ Ø´ÙŠØ¡ Ø­ØªÙ‰ Ù„Ø§ Ù†ØºÙŠÙ‘Ø± Ø³Ù„ÙˆÙƒÙƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¯ÙˆÙ† Ø·Ù„Ø¨)
    }
  } catch (_) {}

  // 4) Dashboard raw (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  try {
    sDash.appendRow([now, data.merchant || '', Number(data.amount) || 0, data.category || '', source]);
  } catch (_) {}

  return { debt: dBal, budget: bRem };
}

AI.gs

/********** Sovereign V120 â€” R3.3 | AI.gs **********/

function callAiHybridV120(text) {
  var seed = preParseFallback(text);

  if (ENV.GROQ_KEY) {
    try {
      var url1 = 'https://api.groq.com/openai/v1/chat/completions';
      var options1 = {
        method: 'post',
        headers: { Authorization: 'Bearer ' + ENV.GROQ_KEY, 'Content-Type': 'application/json' },
        payload: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: 'Extract Arabic banking transaction fields. Return strict JSON ONLY.' },
            { role: 'user', content: 'Ø§Ù„Ù†Øµ: """' + text + '""" Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ JSON: {"merchant":"string","amount":"number","currency":"SAR","category":"string","type":"string","isIncoming":"boolean","accNum":"string","cardNum":"string"}' }
          ],
          response_format: { type: 'json_object' },
          temperature: 0
        })
      };
      var resp1 = UrlFetchApp.fetch(url1, options1);
      var content = JSON.parse(resp1.getContentText()).choices[0].message.content;
      var parsed = JSON.parse(content);
      return sanitizeAI(parsed, seed);
    } catch (e1) { /* ignore */ }
  }

  if (ENV.GEMINI_KEY) {
    try {
      var url2 = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + encodeURIComponent(ENV.GEMINI_KEY);
      var prompt = 'Ø­Ù„Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØµØ±ÙÙŠ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ø³ØªØ®Ø±Ø¬ JSON Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø·: {"merchant":"string","amount":"number","currency":"SAR","category":"string","type":"string","isIncoming":"boolean","accNum":"string","cardNum":"string"}.\n' +
        'Ø§Ù„Ù†Øµ: """' + text + '"""';

      var payload2 = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0 } };
      var resp2 = UrlFetchApp.fetch(url2, { method: 'post', contentType: 'application/json', payload: JSON.stringify(payload2) });

      var data = JSON.parse(resp2.getContentText());
      var rawText = (data.candidates && data.candidates[0] && data.candidates[0].content &&
        data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) || '{}';

      var m = rawText.match(/\{[\s\S]*\}/);
      var parsed2 = m ? JSON.parse(m[0]) : {};
      return sanitizeAI(parsed2, seed);
    } catch (e2) { /* ignore */ }
  }

  return seed;
}

function preParseFallback(text) {
  var t = String(text || '').replace(/\s+/g, ' ');

  var amtMatch = t.match(/(\d[\d,\.]*)\s*(SAR|Ø±ÙŠØ§Ù„(?:\s*Ø³Ø¹ÙˆØ¯ÙŠ)?)/i);
  var amt = amtMatch ? Number(String(amtMatch[1]).replace(/[,]/g, '')) : 0;

  var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…|Ø¥Ø¶Ø§ÙØ©)/i.test(t);
  var outgoing = /(Ø®ØµÙ…|Ø´Ø±Ø§Ø¡|Ø³Ø­Ø¨|Ø±Ø³ÙˆÙ…|POS|ØµØ§Ø¯Ø±)/i.test(t);

  var accMatch = t.match(/Ø­Ø³Ø§Ø¨(?:\s*Ø±Ù‚Ù…)?\s*(\d{3,})/i);
  var cardMatch = t.match(/(?:Ø¨Ø·Ø§Ù‚Ø©|Ø¨Ø·Ø§Ù‚Ù‡|ÙƒØ§Ø±Øª)\s*(\d{3,})/i);

  var merchMatch = t.match(/Ù…Ù†\s+([^\s]+)|Ø¥Ù„Ù‰\s+([^\s]+)/i);
  var merchant = (merchMatch && (merchMatch[1] || merchMatch[2])) ? (merchMatch[1] || merchMatch[2]) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';

  var cat = 'Ø£Ø®Ø±Ù‰', type = 'Ø­ÙˆØ§Ù„Ø©';
  if (/(ØªØ­ÙˆÙŠÙ„|Ø­ÙˆØ§Ù„Ø©)/i.test(t)) type = 'Ø­ÙˆØ§Ù„Ø©';
  else if (/(Ø´Ø±Ø§Ø¡|POS|Ù…ØªØ¬Ø±|Ø³Ø¯Ø§Ø¯)/i.test(t)) { type = 'Ù…Ø´ØªØ±ÙŠØ§Øª'; cat = 'Ù…Ø´ØªØ±ÙŠØ§Øª Ø¹Ø§Ù…Ø©'; }

  if (incoming) cat = 'Ø­ÙˆØ§Ù„Ø§Øª ÙˆØ§Ø±Ø¯Ø©';
  if (outgoing) cat = 'Ø­ÙˆØ§Ù„Ø§Øª ØµØ§Ø¯Ø±Ø©';

  return {
    merchant: merchant,
    amount: amt || 0,
    currency: 'SAR',
    category: cat,
    type: type,
    isIncoming: incoming ? true : (outgoing ? false : (amt >= 0)),
    accNum: accMatch ? accMatch[1] : '',
    cardNum: cardMatch ? cardMatch[1] : ''
  };
}

function sanitizeAI(ai, seed) {
  var safe = {};
  for (var k in seed) safe[k] = seed[k];
  for (var k2 in (ai || {})) safe[k2] = ai[k2];

  safe.amount = Number(safe.amount) || 0;
  safe.isIncoming = !!safe.isIncoming;

  safe.merchant = String(safe.merchant || '').slice(0, 100);
  safe.category = String(safe.category || 'Ø£Ø®Ø±Ù‰').slice(0, 100);
  safe.type = String(safe.type || 'Ø­ÙˆØ§Ù„Ø©').slice(0, 50);
  safe.accNum = String(safe.accNum || '').slice(0, 32);
  safe.cardNum = String(safe.cardNum || '').slice(0, 32);

  return safe;
}

/** AI Diagnostics */
function callAiProbe_(text) {
  var seed = preParseFallback(text);

  if (ENV.GROQ_KEY) {
    try {
      var url1 = 'https://api.groq.com/openai/v1/chat/completions';
      var options1 = {
        method: 'post',
        headers: { Authorization: 'Bearer ' + ENV.GROQ_KEY, 'Content-Type': 'application/json' },
        payload: JSON.stringify({
          model: 'llama-3.3-70b-versatile',
          messages: [
            { role: 'system', content: 'Extract Arabic banking transaction fields. Return strict JSON ONLY.' },
            { role: 'user', content: 'Ø§Ù„Ù†Øµ: """' + text + '""" Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ JSON: {"merchant":"string","amount":"number","currency":"SAR","category":"string","type":"string","isIncoming":"boolean","accNum":"string","cardNum":"string"}' }
          ],
          response_format: { type: 'json_object' },
          temperature: 0
        })
      };

      var resp1 = UrlFetchApp.fetch(url1, options1);
      var content = JSON.parse(resp1.getContentText()).choices[0].message.content;
      var parsed = JSON.parse(content);

      return { ai: sanitizeAI(parsed, seed), engine: 'groq' };
    } catch (e1) { /* ignore */ }
  }

  if (ENV.GEMINI_KEY) {
    try {
      var url2 = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=' + encodeURIComponent(ENV.GEMINI_KEY);
      var prompt = 'Ø­Ù„Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…ØµØ±ÙÙŠ Ø§Ù„ØªØ§Ù„ÙŠ ÙˆØ§Ø³ØªØ®Ø±Ø¬ JSON Ø¨Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙ‚Ø·: {"merchant":"string","amount":"number","currency":"SAR","category":"string","type":"string","isIncoming":"boolean","accNum":"string","cardNum":"string"}.\n' +
        'Ø§Ù„Ù†Øµ: """' + text + '"""';

      var payload2 = { contents: [{ parts: [{ text: prompt }] }], generationConfig: { temperature: 0 } };
      var resp2 = UrlFetchApp.fetch(url2, { method: 'post', contentType: 'application/json', payload: JSON.stringify(payload2) });

      var data = JSON.parse(resp2.getContentText());
      var rawText = (data.candidates && data.candidates[0] && data.candidates[0].content &&
        data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) || '{}';

      var m = rawText.match(/\{[\s\S]*\}/);
      var parsed2 = m ? JSON.parse(m[0]) : {};

      return { ai: sanitizeAI(parsed2, seed), engine: 'gemini' };
    } catch (e2) { /* ignore */ }
  }

  return { ai: seed, engine: 'fallback' };
}
``


/********** Sovereign V120 â€” R3.3 | Classifier.gs **********/

function applyClassifierMap_(rawText, ai) {
  try {
    var sMap = _sheet('Classifier_Map');
    var vals = sMap.getDataRange().getValues();
    var t = String(rawText || '').toLowerCase();

    for (var i = 1; i < vals.length; i++) {
      var key = String(vals[i][0] || '').toLowerCase();
      if (!key) continue;

      if (t.indexOf(key) >= 0 || String(ai.merchant || '').toLowerCase().indexOf(key) >= 0) {
        if (vals[i][1]) ai.category = vals[i][1];
        if (vals[i][2]) ai.type = vals[i][2];
        if (String(vals[i][3] || '') !== '') ai.isIncoming = String(vals[i][3]).toLowerCase() === 'true';
        if (vals[i][4]) ai.accNum = vals[i][4];
        if (vals[i][5]) ai.cardNum = vals[i][5];
        break;
      }
    }
  } catch (e) { /* ignore */ }

  return ai;
}

function updateClassifierMapFromLast_(newCat) {
  try {
    var s1 = _sheet('Sheet1');
    var last = s1.getLastRow();
    if (last < 2) return;

    var merchant = String(s1.getRange(last, 9).getValue() || '').toLowerCase();
    var rawText = String(s1.getRange(last, 12).getValue() || '').toLowerCase();
    var key = merchant || (rawText.split(/\s+/)[0] || '');

    if (!key) return;

    var sMap = _sheet('Classifier_Map');
    var vals = sMap.getDataRange().getValues();

    for (var i = 1; i < vals.length; i++) {
      if (String(vals[i][0] || '').toLowerCase() === key) {
        sMap.getRange(i + 1, 2).setValue(newCat);
        return;
      }
    }

    sMap.appendRow([key, newCat, '', '', '', '']);
  } catch (e) { /* ignore */ }
}
``

/********** Telegram.gs â€” Clean Group (No buttons per transaction) **********/

function _prop_(k, fallback) {
  try { return PropertiesService.getScriptProperties().getProperty(k) || (fallback || ''); }
  catch (e) { return (fallback || ''); }
}

function getHubChatId_() {
  var hub = _prop_('CHANNEL_ID', '') || _prop_('ADMIN_CHAT_ID', '') || _prop_('CHAT_ID', '') || (ENV.CHAT_ID || '');
  return String(hub || '');
}

function getArchiveChatId_() {
  return String(_prop_('ARCHIVE_CHANNEL_ID', '') || '');
}

function escHtml_(s) {
  return String(s || '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function sendTelegramLogged_(chatId, text, extra) {
  if (!ENV.TELEGRAM_TOKEN || !chatId) return { ok: false, code: 0, body: 'missing token/chatId' };

  var payload = Object.assign({
    chat_id: String(chatId),
    text: String(text || ''),
    disable_web_page_preview: true
  }, extra || {});

  var resp = UrlFetchApp.fetch('https://api.telegram.org/bot' + ENV.TELEGRAM_TOKEN + '/sendMessage', {
    method: 'post',
    payload: payload,
    muteHttpExceptions: true
  });

  var code = resp.getResponseCode();
  var body = resp.getContentText();

  if (code !== 200) {
    try { if (typeof logIngressEvent_ === 'function') logIngressEvent_('ERROR', 'sendMessage', { code: code }, body); } catch (_) {}
  }
  return { ok: (code === 200), code: code, body: body };
}

function sendTelegram_(chatId, text) {
  sendTelegramLogged_(chatId, text);
}

/** Ù„ÙˆØ­Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø«Ø§Ø¨ØªØ© (Reply Keyboard) â€” ØªØ¸Ù‡Ø± Ø¹Ù†Ø¯ /menu ÙÙ‚Ø· */
function V120_sendMenuPanel_(chatId) {
  var hub = String(chatId || getHubChatId_());
  if (!hub) return;

  var keyboard = {
    keyboard: [
      ['ğŸ“Š ØªÙ‚Ø±ÙŠØ±', 'ğŸ“… Ø§Ù„ÙŠÙˆÙ…', 'ğŸ—“ï¸ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', 'ğŸ—“ï¸ Ø§Ù„Ø´Ù‡Ø±'],
      ['ğŸ§¾ Ø¢Ø®Ø± 5', 'ğŸ§¾ Ø¢Ø®Ø± 10', 'ğŸ” Ø¨Ø­Ø«', 'â• Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ']
    ],
    resize_keyboard: true,
    is_persistent: true
  };

  var msg =
    'ğŸ§­ <b>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Sovereign V120</b>\n' +
    'â€¢ Ø¨Ø­Ø«: <code>Ø¨Ø­Ø«: ÙƒÙ„Ù…Ø©</code>\n' +
    'â€¢ Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ: <code>Ø£Ø¶Ù: 45.75 | Ø¬Ù‡Ø© | ØªØµÙ†ÙŠÙ</code>\n' +
    'â€¢ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø©: <code>/menu_off</code>';

  sendTelegramLogged_(hub, msg, { parse_mode: 'HTML', reply_markup: JSON.stringify(keyboard) });
}

function V120_removeMenuPanel_(chatId) {
  var hub = String(chatId || getHubChatId_());
  if (!hub) return;
  sendTelegramLogged_(hub, 'âœ… ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ….', { reply_markup: JSON.stringify({ remove_keyboard: true }) });
}

/** Ù…Ù„Ø®Øµ Budgets */
function sendBudgetsSnapshotToTelegram_() {
  var hub = getHubChatId_();
  if (!hub) return;

  var cache = CacheService.getScriptCache();
  var cached = cache.get('BUDGET_SNAP');
  if (cached) { sendTelegram_(hub, cached); return; }

  var sB = _sheet('Budgets').getDataRange().getValues();
  var totalB = 0, totalC = 0, lines = [];
  for (var i = 1; i < sB.length; i++) {
    var cat = sB[i][0] || '';
    var b = Number(sB[i][1]) || 0;
    var c = Number(sB[i][2]) || 0;
    totalB += b; totalC += c;
    lines.push('â€¢ ' + cat + ': Ù…ØªØ¨Ù‚Ù‘ÙŠ ' + (b - c).toFixed(2));
  }

  var msg = 'ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø©\n' +
    'Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø©: ' + totalB.toFixed(2) + ' SAR\n' +
    'Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + totalC.toFixed(2) + ' SAR\n' +
    'â”â”â”â”â”â”â”â”â”â”â”â”\n' + lines.join('\n');

  cache.put('BUDGET_SNAP', msg, 15);
  sendTelegram_(hub, msg);
}

/** Ø¢Ø®Ø± N */
function sendLastNToTelegram_(chatId, n) {
  n = n || 5;
  var s1 = _sheet('Sheet1');
  var last = s1.getLastRow();
  if (last < 2) { sendTelegram_(chatId, 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¨Ø¹Ø¯.'); return; }

  var start = Math.max(2, last - n + 1);
  var rows = s1.getRange(start, 1, last - start + 1, 12).getValues();

  var out = ['ğŸ§¾ Ø¢Ø®Ø± ' + n + ' Ø¹Ù…Ù„ÙŠØ§Øª:'];
  for (var i = rows.length - 1; i >= 0; i--) {
    var r = rows[i];
    var dt = (r[0] instanceof Date) ? Utilities.formatDate(r[0], Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm') : '';
    out.push('â€¢ ' + dt + ' | ' + (Number(r[7]) || 0).toFixed(2) + ' | ' + (r[8] || '') + ' | ' + (r[9] || ''));
  }
  sendTelegram_(chatId, out.join('\n'));
}

/** Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹/Ø§Ù„Ø´Ù‡Ø± */
function sendPeriodSummary_(chatId, mode) {
  var cache = CacheService.getScriptCache();
  var key = 'SUM_' + mode;
  var cached = cache.get(key);
  if (cached) { sendTelegram_(chatId, cached); return; }

  var now = new Date(), start, end;
  if (mode === 'today') {
    start = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 0, 0, 0);
    end = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 0);
  } else if (mode === 'week') {
    var day = now.getDay();
    var offsetToSat = (day + 1) % 7;
    start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - offsetToSat, 0, 0, 0);
    end = new Date(start.getFullYear(), start.getMonth(), start.getDate() + 7, 0, 0, 0);
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1, 0, 0, 0);
    end = new Date(now.getFullYear(), now.getMonth() + 1, 1, 0, 0, 0);
  }

  var s1 = _sheet('Sheet1');
  var rows = s1.getDataRange().getValues();
  var spend = 0, income = 0, byCat = {};

  for (var i = 1; i < rows.length; i++) {
    var d = rows[i][0];
    if (!(d instanceof Date)) continue;
    if (d < start || d >= end) continue;

    var amt = Number(rows[i][7]) || 0;
    var cat = String(rows[i][9] || 'Ø£Ø®Ø±Ù‰');
    var type = String(rows[i][10] || '');
    var raw = String(rows[i][11] || '');
    var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(type) || /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(raw);

    if (incoming) income += amt;
    else { spend += amt; byCat[cat] = (byCat[cat] || 0) + amt; }
  }

  var title = (mode === 'today') ? 'ğŸ“… Ù…Ù„Ø®Øµ Ø§Ù„ÙŠÙˆÙ…' : (mode === 'week' ? 'ğŸ—“ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹' : 'ğŸ—“ï¸ Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±');
  var top = Object.keys(byCat).sort(function(a,b){return byCat[b]-byCat[a];}).slice(0,6)
    .map(function(k){ return 'â€¢ ' + k + ': ' + byCat[k].toFixed(2); });

  var msg = title + '\n' +
    'Ø§Ù„Ø¯Ø®Ù„: ' + income.toFixed(2) + ' SAR\n' +
    'Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + spend.toFixed(2) + ' SAR\n' +
    'Ø§Ù„ØµØ§ÙÙŠ: ' + (income - spend).toFixed(2) + ' SAR\n' +
    (top.length ? ('â”â”â”â”â”â”â”â”â”â”â”â”\nØ£Ø¹Ù„Ù‰ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª:\n' + top.join('\n')) : '');

  cache.put(key, msg, 15);
  sendTelegram_(chatId, msg);
}

/** Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù…Ù„ÙŠØ© Ù†Ø¸ÙŠÙØ© (Ø¨Ø¯ÙˆÙ† Ø£Ø²Ø±Ø§Ø±) */
function sendSovereignReportV120(ai, sync, src, raw, destChatId) {
  var hub = String(destChatId || getHubChatId_() || '');
  if (!hub) return;

  var amount = Number(ai && ai.amount ? ai.amount : 0);
  var merchant = (ai && ai.merchant) ? String(ai.merchant) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
  var category = (ai && ai.category) ? String(ai.category) : 'Ø£Ø®Ø±Ù‰';
  var type = (ai && ai.type) ? String(ai.type) : 'Ø­ÙˆØ§Ù„Ø©';
  var isIncoming = !!(ai && ai.isIncoming);
  var budgetRem = Number(sync && sync.budget ? sync.budget : 0);

  var html =
    'ğŸ§¾ <b>Ø¹Ù…Ù„ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© â€” V120</b>\n' +
    'ğŸ’° <b>' + escHtml_(amount.toFixed(2)) + ' SAR</b> ' + (isIncoming ? '(ÙˆØ§Ø±Ø¯)' : '(ØµØ§Ø¯Ø±)') + '\n' +
    'ğŸ‘¤ ' + escHtml_(merchant) + '\n' +
    'ğŸ·ï¸ ' + escHtml_(category) + ' | ' + escHtml_(type) + '\n' +
    'ğŸ“‰ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (Ù…ÙŠØ²Ø§Ù†ÙŠØ©): ' + escHtml_(budgetRem.toFixed(2)) + ' SAR\n' +
    'ğŸ“ ' + escHtml_(raw || '');

  sendTelegramLogged_(hub, html, { parse_mode: 'HTML' });

  // Ø£Ø±Ø´ÙØ© Ø§Ø®ØªÙŠØ§Ø±ÙŠØ©
  var arch = getArchiveChatId_();
  if (arch && arch !== hub) {
    sendTelegramLogged_(arch, html, { parse_mode: 'HTML' });
  }
}

/** Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø­ØªØ§Ø¬ callback_query â€” Ù†ØªØ±ÙƒÙ‡Ø§ ÙƒØ¥Ø±Ø´Ø§Ø¯ */
function handleInteractionV120(callbackQuery) {
  // Ù„Ø§ Ø´ÙŠØ¡ â€” Ù„Ø£Ù†Ù†Ø§ Ù„Ù… Ù†Ø¹Ø¯ Ù†Ø¶Ø¹ inline buttons Ù…Ø¹ ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©
}


/********** Sovereign V120 â€” R3.3 | Debt.gs **********/

function updateDebtIndex_(data) {
  try {
    var sIdx = _sheet('Debt_Index');
    var party = (data.merchant || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
    var acct = (data.cardNum || data.accNum || '');

    // Ù…Ø§ Ù†Ø¯ÙØ¹Ù‡ = Ø¹Ù„ÙŠÙ‡Ù… Ù„Ù†Ø§ (+). Ù…Ø§ Ù†Ø³ØªÙ„Ù…Ù‡ Ù…Ù†Ù‡Ù… = ÙŠÙ‚Ù„Ù‘.
    var sign = data.isIncoming ? -1 : 1;
    var delta = sign * (Number(data.amount) || 0);

    var vals = sIdx.getDataRange().getValues();
    var found = -1;

    for (var i = 1; i < vals.length; i++) {
      if ((vals[i][0] || '') === party && (vals[i][1] || '') === acct) { found = i; break; }
    }

    if (found > 0) {
      var cur = Number(vals[found][2]) || 0;
      sIdx.getRange(found + 1, 2).setValue(acct);
      sIdx.getRange(found + 1, 3).setValue(cur + delta);
      sIdx.getRange(found + 1, 4).setValue(new Date());
    } else {
      sIdx.appendRow([party, acct, delta, new Date()]);
    }
  } catch (e) { /* ignore */ }
}
``


/********** Dashboard.gs â€” Improved Layout **********/

function rebuildDashboard() {
  var ss = _ss();
  var s1 = _sheet('Sheet1');
  var sB = _sheet('Budgets');
  var sDash = _sheet('Dashboard');

  // ØªÙ†Ø¸ÙŠÙ ÙƒØ§Ù…Ù„
  sDash.clear();
  var charts = sDash.getCharts();
  for (var i = 0; i < charts.length; i++) sDash.removeChart(charts[i]);

  sDash.setRightToLeft(true);
  sDash.setFrozenRows(0);

  // Ø¹Ù†ÙˆØ§Ù†
  sDash.getRange('A1').setValue('Ù„ÙˆØ­Ø© Sovereign V120');
  sDash.getRange('A1').setFontSize(14).setFontWeight('bold');

  // Ù†Ø³Ø® Budgets Ø¥Ù„Ù‰ Ø§Ù„Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ (Ù…Ù† A3)
  var valsB = sB.getDataRange().getValues();
  if (valsB.length < 1) {
    sDash.getRange('A3').setValue('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Budgets.');
    return;
  }
  sDash.getRange(3, 1, valsB.length, valsB[0].length).setValues(valsB);

  // ØªÙ†Ø³ÙŠÙ‚ Budgets Ø¯Ø§Ø®Ù„ Dashboard
  sDash.getRange(3, 2, Math.max(1, valsB.length - 1), 3).setNumberFormat('#,##0.00');
  sDash.getRange('A3:D3').setFontWeight('bold').setBackground('#f3f3f3');

  // Ù…Ù„Ø®Øµ Ø£Ø¹Ù„Ù‰ (F2:H4)
  var totalBudget = 0, totalSpent = 0, totalRem = 0;
  for (var r = 1; r < valsB.length; r++) {
    totalBudget += Number(valsB[r][1]) || 0;
    totalSpent += Number(valsB[r][2]) || 0;
    totalRem += Number(valsB[r][3]) || 0;
  }

  sDash.getRange('F2').setValue('Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±');
  sDash.getRange('F2').setFontWeight('bold');

  sDash.getRange('F3').setValue('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø©');
  sDash.getRange('G3').setValue(totalBudget);
  sDash.getRange('F4').setValue('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ');
  sDash.getRange('G4').setValue(totalSpent);
  sDash.getRange('F5').setValue('Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ');
  sDash.getRange('G5').setValue(totalRem);

  sDash.getRange('G3:G5').setNumberFormat('#,##0.00');
  sDash.getRange('F3:F5').setFontWeight('bold').setBackground('#fafafa');
  sDash.getRange('G3:G5').setBackground('#fafafa');

  // ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ ÙÙŠ (A20:B..)
  var rows = s1.getDataRange().getValues();
  var now = new Date(), m = now.getMonth(), y = now.getFullYear();
  var daily = {};

  for (var i2 = 1; i2 < rows.length; i2++) {
    var d = rows[i2][0];
    if (!(d instanceof Date)) continue;
    if (d.getMonth() !== m || d.getFullYear() !== y) continue;

    var amt = Number(rows[i2][7]) || 0;
    var type = String(rows[i2][10] || '');
    var raw = String(rows[i2][11] || '');
    var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(type) || /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(raw);

    var spent = incoming ? 0 : amt; // Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙ‚Ø·
    var key = Utilities.formatDate(d, Session.getScriptTimeZone(), 'yyyy-MM-dd');
    daily[key] = (daily[key] || 0) + Math.max(spent, 0);
  }

  var days = Object.keys(daily).sort();
  sDash.getRange('A18').setValue('Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ (Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ)');
  sDash.getRange('A18').setFontWeight('bold');

  sDash.getRange('A19').setValue('Ø§Ù„ØªØ§Ø±ÙŠØ®');
  sDash.getRange('B19').setValue('Ø§Ù„Ù…ØµØ±ÙˆÙ');
  sDash.getRange('A19:B19').setFontWeight('bold').setBackground('#f3f3f3');

  if (days.length) {
    var out = [];
    for (var k = 0; k < days.length; k++) out.push([days[k], daily[days[k]]]);
    sDash.getRange(20, 1, out.length, 2).setValues(out);
    sDash.getRange(20, 1, out.length, 1).setNumberFormat('yyyy-MM-dd');
    sDash.getRange(20, 2, out.length, 1).setNumberFormat('#,##0.00');
  } else {
    sDash.getRange('A20').setValue('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙŠ Sheet1.');
  }

  // Ø¥Ø¯Ø±Ø§Ø¬ Ø§Ù„Ø±Ø³ÙˆÙ… (ÙŠÙ…ÙŠÙ† Ø§Ù„Ø¬Ø¯ÙˆÙ„)
  try {
    // Pie: A3:B?
    var pie = sDash.newChart().asPieChart()
      .addRange(sDash.getRange(3, 1, valsB.length, 2))
      .setOption('title', 'Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ø­Ø³Ø¨ Ø§Ù„ØªØµÙ†ÙŠÙ')
      .setPosition(3, 6, 0, 0)
      .build();
    sDash.insertChart(pie);
  } catch (e1) {}

  try {
    // Column: A3:D?
    var col = sDash.newChart().asColumnChart()
      .addRange(sDash.getRange(3, 1, valsB.length, 4))
      .setOption('title', 'Ù…ÙˆØ§Ø²Ù†Ø© Ù…Ù‚Ø§Ø¨Ù„ Ù…ØµØ±ÙˆÙ ÙˆÙ…ØªÙØ¨Ù‚Ù‘ÙŠ')
      .setOption('legend', { position: 'bottom' })
      .setPosition(16, 6, 0, 0)
      .build();
    sDash.insertChart(col);
  } catch (e2) {}

  try {
    // Line chart Ù„Ù„Ø¥Ù†ÙØ§Ù‚ Ø§Ù„ÙŠÙˆÙ…ÙŠ: A19:B..
    var lastRowDaily = 20 + Math.max(0, days.length - 1);
    if (days.length) {
      var line = sDash.newChart().asLineChart()
        .addRange(sDash.getRange(19, 1, lastRowDaily - 18, 2))
        .setOption('title', 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ')
        .setPosition(30, 1, 0, 0)
        .build();
      sDash.insertChart(line);
    }
  } catch (e3) {}

  // ØªØ­Ø³ÙŠÙ† Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
  try {
    sDash.autoResizeColumns(1, 8);
    sDash.setColumnWidths(1, 1, 170);
    sDash.setColumnWidths(2, 1, 130);
  } catch (e4) {}

  safeNotify('âœ… Dashboard: ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨ØªØ®Ø·ÙŠØ· Ù…ÙØ­Ø³Ù‘Ù†.');
}


/********** Sovereign V120 â€” R3.3 | Triggers.gs **********/

function resetSystemKeepSalary() {
  var s1 = _sheet('Sheet1');
  var sD = _sheet('Debt_Ledger');
  var sDash = _sheet('Dashboard');
  var sB = _sheet('Budgets');

  if (s1.getLastRow() > 1) s1.getRange(2, 1, s1.getLastRow() - 1, 12).clearContent();
  if (sD.getLastRow() > 1) sD.getRange(2, 1, sD.getLastRow() - 1, 6).clearContent();
  if (sDash.getMaxRows() > 1) sDash.clear();

  var found = false;
  var vals = sB.getDataRange().getValues();
  for (var i = 1; i < vals.length; i++) {
    if (String(vals[i][0] || '') === 'Ø§Ù„Ø±Ø§ØªØ¨') {
      sB.getRange(i + 1, 1, 1, 4).setValues([['Ø§Ù„Ø±Ø§ØªØ¨', 5000, 0, 5000]]);
      found = true;
      break;
    }
  }
  if (!found) sB.appendRow(['Ø§Ù„Ø±Ø§ØªØ¨', 5000, 0, 5000]);

  safeNotify('ğŸ§¹ ØªÙ…Ù‘Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¶Ø¨Ø· Ù…Ø¹ ØªØ«Ø¨ÙŠØª Ø¨Ù†Ø¯ Ø§Ù„Ø±Ø§ØªØ¨ 5000. Ø³ÙŠØªÙ… Ø¥Ø¯Ø±Ø§Ø¬ Ø±Ø§ØªØ¨ ÙŠÙˆÙ… 27 ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§.');
}

function setupTimeTriggers() {
  deleteTriggers_(['weeklyReport', 'monthlyReport', 'insertMonthlySalary']);

  ScriptApp.newTrigger('weeklyReport')
    .timeBased()
    .onWeekDay(ScriptApp.WeekDay.SATURDAY)
    .atHour(20)
    .create();

  ScriptApp.newTrigger('monthlyReport')
    .timeBased()
    .onMonthDay(26)
    .atHour(20)
    .create();

  ScriptApp.newTrigger('insertMonthlySalary')
    .timeBased()
    .onMonthDay(27)
    .atHour(9)
    .create();

  safeNotify('â° ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø´ØºÙ„Ø§Øª: Ø³Ø¨Øª Ø£Ø³Ø¨ÙˆØ¹ÙŠÙ‹Ø§ØŒ 26 Ø´Ù‡Ø±ÙŠÙ‹Ø§ ØªÙ‚Ø±ÙŠØ±ØŒ 27 Ø´Ù‡Ø±ÙŠÙ‹Ø§ Ø±Ø§ØªØ¨.');
}

function deleteTriggers_(names) {
  var ts = ScriptApp.getProjectTriggers();
  ts.forEach(function (t) {
    if (names.indexOf(t.getHandlerFunction()) >= 0) ScriptApp.deleteTrigger(t);
  });
}

function insertMonthlySalary() {
  var ai = {
    merchant: 'Ø±Ø§ØªØ¨',
    amount: 5000,
    currency: 'SAR',
    category: 'Ø§Ù„Ø±Ø§ØªØ¨',
    type: 'Ø­ÙˆØ§Ù„Ø©',
    isIncoming: true,
    accNum: 'Ø§Ù„Ø±Ø§ØªØ¨',
    cardNum: ''
  };

  var sync = syncQuadV120(ai, 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ 5000', 'Ø±Ø§ØªØ¨_Ù…Ø¬Ø¯ÙˆÙÙ„');
  sendSovereignReportV120(ai, sync, 'Ø±Ø§ØªØ¨_Ù…Ø¬Ø¯ÙˆÙÙ„', 'Ø±Ø§ØªØ¨ Ø´Ù‡Ø±ÙŠ 5000', ENV.CHAT_ID);
}

function weeklyReport() {
  var s1 = _sheet('Sheet1');
  var rows = s1.getDataRange().getValues();

  var now = new Date();
  var day = now.getDay();

  // Ø§Ù„Ø³Ø¨Øª Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¨Ø¯Ø§ÙŠØ© Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±)
  var todaySat = new Date(now.getFullYear(), now.getMonth(), now.getDate() - ((day + 1) % 7));
  var lastSat = new Date(todaySat.getFullYear(), todaySat.getMonth(), todaySat.getDate() - 7);

  var sum = 0, byCat = {};
  for (var i = 1; i < rows.length; i++) {
    var d = rows[i][0];
    if (!(d instanceof Date)) continue;

    if (d >= lastSat && d < todaySat) {
      var amt = Number(rows[i][7]) || 0;
      var cat = String(rows[i][9] || 'Ø£Ø®Ø±Ù‰');
      var type = String(rows[i][10] || '');
      var raw = String(rows[i][11] || '');

      var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(type) || /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(raw);
      if (!incoming) {
        sum += amt;
        byCat[cat] = (byCat[cat] || 0) + amt;
      }
    }
  }

  var lines = [];
  for (var k in byCat) lines.push('â€¢ ' + k + ': ' + byCat[k].toFixed(2));

  var msg = 'ğŸ“… ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ (Ø§Ù„Ø³Ø¨Øªâ€“Ø§Ù„Ø¬Ù…Ø¹Ø©)\n' +
    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + sum.toFixed(2) + ' SAR\n' +
    (lines.length ? ('ØªÙØµÙŠÙ„:\n' + lines.join('\n')) : '');

  sendTelegram_(ENV.CHAT_ID, msg);
}

function monthlyReport() {
  var s1 = _sheet('Sheet1');
  var rows = s1.getDataRange().getValues();

  var now = new Date();
  var start = new Date(now.getFullYear(), now.getMonth(), 1);
  var end = new Date(now.getFullYear(), now.getMonth(), 27); // 1â€“26

  var sum = 0, byCat = {};
  for (var i = 1; i < rows.length; i++) {
    var d = rows[i][0];
    if (!(d instanceof Date)) continue;

    if (d >= start && d < end) {
      var amt = Number(rows[i][7]) || 0;
      var cat = String(rows[i][9] || 'Ø£Ø®Ø±Ù‰');
      var type = String(rows[i][10] || '');
      var raw = String(rows[i][11] || '');

      var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(type) || /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(raw);
      if (!incoming) {
        sum += amt;
        byCat[cat] = (byCat[cat] || 0) + amt;
      }
    }
  }

  var lines = [];
  for (var k in byCat) lines.push('â€¢ ' + k + ': ' + byCat[k].toFixed(2));

  var msg = 'ğŸ“† ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ (1â€“26)\n' +
    'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ: ' + sum.toFixed(2) + ' SAR\n' +
    (lines.length ? ('ØªÙØµÙŠÙ„:\n' + lines.join('\n')) : '');

  sendTelegram_(ENV.CHAT_ID, msg);
}


/********** Setup.gs â€” V120 Menu (LIGHT default) **********/

function onOpen(e) {
  try {
    var ui = SpreadsheetApp.getUi();

    // ===== Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© =====
    var menu = ui.createMenu('V120');

    // 1) ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹ (LIGHT) â€” Ø§ÙØªØ±Ø§Ø¶ÙŠ
    menu.addItem('âœ… ØªØ´ØºÙŠÙ„ Ø³Ø±ÙŠØ¹ (LIGHT) â€” Ø§ÙØªØ±Ø§Ø¶ÙŠ', 'V120_MasterRun_LIGHT');

    // 2) Ø£Ù‡Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
    menu.addSeparator();
    menu.addSubMenu(
      ui.createMenu('ğŸ§© ØªØ´ØºÙŠÙ„ ÙŠÙˆÙ…ÙŠ')
        .addItem('ğŸ§± ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© (Initial)', 'initialsystem')
        .addItem('ğŸ§ª Ø²Ø±Ø¹ Ø§Ù„ØµÙŠØº (Seed Formulas)', 'test_10_seed_formulas')
        .addItem('ğŸŒ Seed Classifier (AR)', 'seedClassifierMap_AR')
        .addSeparator()
        .addItem('ğŸ§® Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© (Ù…Ù† Sheet1)', 'test_05_recompute_budgets_from_sheet1')
        .addItem('ğŸ“Š Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Dashboard (Ù…Ø­Ø³Ù‘Ù†)', 'rebuildDashboard')
        .addSeparator()
        .addItem('ğŸ“Š Ø¥Ø±Ø³Ø§Ù„ Snapshot (Budgets)', 'test_08_send_snapshot')
    );

    // 3) Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØªØ´Ø®ÙŠØµ
    menu.addSubMenu(
      ui.createMenu('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙˆØªØ´Ø®ÙŠØµ')
        .addItem('ğŸŒ Probe Webhook (GET/POST)', 'test_01_probeWebhook')
        .addItem('ğŸ¤– AI Diagnostics', 'test_AI_Diagnostics')
        .addSeparator()
        .addItem('ğŸ“¥ ÙÙ„Ùˆ ÙˆØ§Ø±Ø¯ (Ø¹ÙŠÙ†Ø©)', 'test_03_flow_incoming_sample')
        .addItem('ğŸ“¤ ÙÙ„Ùˆ ØµØ§Ø¯Ø± (Ø¹ÙŠÙ†Ø©)', 'test_04_flow_outgoing_sample')
    );

    // 4) ØµÙŠØ§Ù†Ø©/Ø¥Ø¯Ø§Ø±Ø© (Ù„Ù…Ù†Ø¹ ØªÙ„ÙˆÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    menu.addSubMenu(
      ui.createMenu('ğŸ› ï¸ ØµÙŠØ§Ù†Ø© ÙˆØ¥Ø¯Ø§Ø±Ø©')
        .addItem('ğŸ”’ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (ON)', 'V120_Maintenance_ON')
        .addItem('ğŸ”“ Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (OFF)', 'V120_Maintenance_OFF')
        .addSeparator()
        .addItem('ğŸ§¹ Reset Ledgers (Debt/Budgets/Dashboard)', 'resetLedgers_KeepHeaders')
        .addSeparator()
        .addItem('ğŸ§½ TestReset (LIGHT) â€” ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Sheet1', 'V120_TestReset_LIGHT_KeepSheet1')
        .addItem('ğŸ§½ TestReset (FULL) â€” ÙŠÙ…Ø³Ø­ Sheet1', 'V120_TestReset_FULL_WipeSheet1')
        .addSeparator()
        .addItem('ğŸ” ØªØ¹ÙŠÙŠÙ†/Ø¥ØµÙ„Ø§Ø­ Webhook (DIRECT)', 'setWebhook_DIRECT_no302')
        .addItem('â›” Ø¥ÙŠÙ‚Ø§Ù Webhook ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… + ØªØµÙÙŠØ± Pending', 'V120_StopTelegramWebhook_NOW')
    );

    // 5) Ù…ØªÙ‚Ø¯Ù… (FULL Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© ÙÙ‚Ø·)
    menu.addSeparator();
    menu.addSubMenu(
      ui.createMenu('âš¡ Ù…ØªÙ‚Ø¯Ù…')
        .addItem('ğŸ§ª ØªØ´ØºÙŠÙ„ Ø´Ø§Ù…Ù„ (FULL) â€” ÙŠÙ…Ø³Ø­ Sheet1', 'V120_MasterRun_FULL')
        .addSeparator()
        .addItem('âœ… ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ¦Ø© (Healthcheck)', 'test_00_healthcheck')
    );

    menu.addToUi();

  } catch (err) {
    console.log('onOpen error: ' + err);
  }
}

/** ØºÙ„Ø§Ù Ù„Ù„ØªÙˆØ§ÙÙ‚ (Ø¥Ø°Ø§ Ø§Ø­ØªØ¬ØªÙ‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) */
function initialsystem() {
  if (typeof V120_runInitial_ === 'function') return V120_runInitial_();
  throw new Error('V120_runInitial_ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© â€” ØªØ£ÙƒØ¯ Ù…Ù† InitCompat.gs');
}


/********** Ø¥Ø¶Ø§ÙØ§Øª Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª V120 (Restore) **********/

function test_03_flow_incoming_sample() {
  // Ø¹ÙŠÙ†Ø© ÙˆØ§Ø±Ø¯
  executeUniversalFlowV120(
    'Ø­ÙˆØ§Ù„Ø© ÙˆØ§Ø±Ø¯Ø© Ø¨Ù€ 2000 SAR Ù…Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ 8001',
    'Ø§Ø®ØªØ¨Ø§Ø±_ÙˆØ§Ø±Ø¯',
    getHubChatId_ ? getHubChatId_() : (ENV.CHAT_ID || null)
  );
  safeNotify('âœ… ÙÙ„Ùˆ ÙˆØ§Ø±Ø¯: ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„.');
}

function test_04_flow_outgoing_sample() {
  // Ø¹ÙŠÙ†Ø© ØµØ§Ø¯Ø±
  executeUniversalFlowV120(
    'ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø± 350 SAR Ù…Ù† Ø­Ø³Ø§Ø¨ 4912 Ø¥Ù„Ù‰ ØªØ§Ø¬Ø± Ø¨Ù†Ø¯Ù‡ POS',
    'Ø§Ø®ØªØ¨Ø§Ø±_ØµØ§Ø¯Ø±',
    getHubChatId_ ? getHubChatId_() : (ENV.CHAT_ID || null)
  );
  safeNotify('âœ… ÙÙ„Ùˆ ØµØ§Ø¯Ø±: ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„.');
}

function test_05_recompute_budgets_from_sheet1() {
  var sB = _sheet('Budgets');
  var s1 = _sheet('Sheet1');

  // ØªØµÙÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª
  var lastB = sB.getLastRow();
  if (lastB >= 2) sB.getRange(2, 3, lastB - 1, 1).setValue(0);

  // Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ
  var now = new Date(), m = now.getMonth(), y = now.getFullYear();
  var rows = s1.getDataRange().getValues();
  var sums = {};

  for (var i = 1; i < rows.length; i++) {
    var r = rows[i];
    var d = r[0];
    if (!(d instanceof Date)) continue;
    if (d.getMonth() !== m || d.getFullYear() !== y) continue;

    var amt = Number(r[7]) || 0;
    var cat = String(r[9] || 'Ø£Ø®Ø±Ù‰');
    var type = String(r[10] || '');
    var raw = String(r[11] || '');

    var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(type) || /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(raw);
    var delta = incoming ? -amt : amt;

    sums[cat] = (sums[cat] || 0) + delta;
  }

  var bVals = sB.getDataRange().getValues();
  for (var j = 1; j < bVals.length; j++) {
    var cat2 = String(bVals[j][0] || '');
    sB.getRange(j + 1, 3).setValue(sums[cat2] || 0);
  }

  safeNotify('âœ… Ø£Ø¹ÙŠØ¯ Ø§Ø­ØªØ³Ø§Ø¨ Budgets!C Ù…Ù† Sheet1 Ù„Ù„Ø´Ù‡Ø± Ø§Ù„Ø¬Ø§Ø±ÙŠ.');
}

function test_08_send_snapshot() {
  // ØªÙ‚Ø±ÙŠØ± Ø³Ø±ÙŠØ¹ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
  sendBudgetsSnapshotToTelegram_();
  safeNotify('âœ… Ø£ÙØ±Ø³Ù„ ØªÙ‚Ø±ÙŠØ± snapshot.');
}


/********** Sovereign V120 â€” R3.3 | Reclassify.gs **********/

function reclassifyLastRowsAndBudget_(n, newCategory) {
  n = n || 1;
  newCategory = newCategory || 'Ù…Ø´ØªØ±ÙŠØ§Øª Ø¹Ø§Ù…Ø©';

  var s1 = _sheet('Sheet1');
  var sB = _sheet('Budgets');

  var last = s1.getLastRow();
  var start = Math.max(2, last - n + 1);

  for (var r = start; r <= last; r++) {
    var oldCat = String(s1.getRange(r, 10).getValue() || 'Ø£Ø®Ø±Ù‰');
    var amt = Number(s1.getRange(r, 8).getValue()) || 0;
    var type = String(s1.getRange(r, 11).getValue() || '');
    var raw = String(s1.getRange(r, 12).getValue() || '');

    var incoming = /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(type) || /(ÙˆØ§Ø±Ø¯|Ø¥ÙŠØ¯Ø§Ø¹|Ø§Ø³ØªÙ„Ø§Ù…)/i.test(raw);
    var delta = incoming ? -amt : amt;

    // Ù†Ø¹ÙƒØ³ Ø£Ø«Ø± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø«Ù… Ù†Ø·Ø¨Ù‘Ù‚ Ø£Ø«Ø± Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    _addToBudgetSpent(sB, oldCat, -delta);
    _addToBudgetSpent(sB, newCategory, delta);

    s1.getRange(r, 10).setValue(newCategory);
  }
}

function _addToBudgetSpent(sB, cat, delta) {
  var vals = sB.getDataRange().getValues();

  for (var i = 1; i < vals.length; i++) {
    if (String(vals[i][0] || '') === String(cat || '')) {
      var cur = Number(vals[i][2]) || 0;
      sB.getRange(i + 1, 3).setValue(cur + delta);
      return;
    }
  }

  // Ø¥Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Budgets Ù†Ø¶ÙŠÙÙ‡
  var row = sB.getLastRow() + 1;
  var spent = Math.max(0, delta);
  sB.getRange(row, 1, 1, 4).setValues([[cat, 0, spent, 0 - spent]]);
}


/********** Sovereign V120 â€” R3.3 | ClassifierSeed.gs **********/

function seedClassifierMap_AR() {
  var sMap = _sheet('Classifier_Map');
  var headers = ['ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©','Ø§Ù„ØªØµÙ†ÙŠÙ','Ø§Ù„Ù†ÙˆØ¹','isIncoming','accNum','cardNum'];

  if (sMap.getLastRow() === 0) sMap.appendRow(headers);

  var seed = [
    ['tiqmo','Ù…Ø­Ø§ÙØ¸ Ø±Ù‚Ù…ÙŠØ©','Ø­ÙˆØ§Ù„Ø©',false,'',''],['ØªÙŠÙ‚Ù…Ùˆ','Ù…Ø­Ø§ÙØ¸ Ø±Ù‚Ù…ÙŠØ©','Ø­ÙˆØ§Ù„Ø©',false,'',''],
    ['tiqmo pay','Ù…Ø­Ø§ÙØ¸ Ø±Ù‚Ù…ÙŠØ©','Ø­ÙˆØ§Ù„Ø©',false,'',''],['stcpay','Ù…Ø­Ø§ÙØ¸ Ø±Ù‚Ù…ÙŠØ©','Ø­ÙˆØ§Ù„Ø©',false,'',''],
    ['stc pay','Ù…Ø­Ø§ÙØ¸ Ø±Ù‚Ù…ÙŠØ©','Ø­ÙˆØ§Ù„Ø©',false,'',''],['Ø¥Ø³ ØªÙŠ Ø³ÙŠ Ø¨Ø§ÙŠ','Ù…Ø­Ø§ÙØ¸ Ø±Ù‚Ù…ÙŠØ©','Ø­ÙˆØ§Ù„Ø©',false,'',''],

    ['pos','Ù…Ø´ØªØ±ÙŠØ§Øª Ø¹Ø§Ù…Ø©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['Ù…Ø¯Ù‰','Ù…Ø´ØªØ±ÙŠØ§Øª Ø¹Ø§Ù…Ø©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['Ø¨Ù†Ø¯Ù‡','Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['ÙƒØ§Ø±ÙÙˆØ±','Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],
    ['Ù‡Ø§ÙŠØ¨Ø±','Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['ØªÙ…ÙˆÙŠÙ†Ø§Øª','Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['Ù…Ø·Ø¹Ù…','Ù…Ø·Ø§Ø¹Ù…','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['Ù…Ø§ÙƒØ¯ÙˆÙ†Ø§Ù„Ø¯Ø²','Ù…Ø·Ø§Ø¹Ù…','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],
    ['Ù‡Ø±ÙÙŠ','Ù…Ø·Ø§Ø¹Ù…','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['Ø¨Ø±ØºØ±','Ù…Ø·Ø§Ø¹Ù…','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['Ø³ØªØ§Ø±Ø¨ÙƒØ³','Ù…Ù‚Ø§Ù‡ÙŠ','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['ÙƒÙˆÙÙŠ','Ù…Ù‚Ø§Ù‡ÙŠ','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['Ø¨Ù†Ø²ÙŠÙ†','ÙˆÙ‚ÙˆØ¯','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['ÙˆÙ‚ÙˆØ¯','ÙˆÙ‚ÙˆØ¯','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],
    ['gas','ÙˆÙ‚ÙˆØ¯','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['Ù…ÙˆØ§Ù‚Ù','Ù…ÙˆØ§ØµÙ„Ø§Øª','Ø±Ø³ÙˆÙ…',false,'',''],
    ['ØµÙŠØ¯Ù„ÙŠØ©','ØµÙŠØ¯Ù„ÙŠØ§Øª','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['stc','Ø§ØªØµØ§Ù„Ø§Øª','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['Ø²ÙŠÙ†','Ø§ØªØµØ§Ù„Ø§Øª','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['Ù…ÙˆØ¨Ø§ÙŠÙ„ÙŠ','Ø§ØªØµØ§Ù„Ø§Øª','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['ÙƒÙ‡Ø±Ø¨Ø§Ø¡','ÙƒÙ‡Ø±Ø¨Ø§Ø¡','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],
    ['Ù…Ø§Ø¡','Ù…ÙŠØ§Ù‡','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['Ù…ÙŠØ§Ù‡','Ù…ÙŠØ§Ù‡','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],

    ['Ø±Ø³ÙˆÙ…','Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø§Øª','Ø±Ø³ÙˆÙ…',false,'',''],

    ['Ø§Ø´ØªØ±Ø§Ùƒ','Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†Ø´Ø¢Øª','Ø±Ø³ÙˆÙ…',false,'',''],['Ø¹Ø¶ÙˆÙŠØ©','Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†Ø´Ø¢Øª','Ø±Ø³ÙˆÙ…',false,'',''],
    ['Ù†Ø§Ø¯ÙŠ','Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†Ø´Ø¢Øª','Ø±Ø³ÙˆÙ…',false,'',''],['ØµØ§Ù„Ø©','Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ù…Ù†Ø´Ø¢Øª','Ø±Ø³ÙˆÙ…',false,'',''],

    ['Ø³Ø­Ø¨','Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ','Ø³Ø­Ø¨',false,'',''],['atm','Ø³Ø­Ø¨ Ù†Ù‚Ø¯ÙŠ','Ø³Ø­Ø¨',false,'',''],

    ['Ø­ÙˆØ§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©','Ø­ÙˆØ§Ù„Ø§Øª ÙˆØ§Ø±Ø¯Ø©','Ø­ÙˆØ§Ù„Ø©',true,'',''],['ØªØ­ÙˆÙŠÙ„ ÙˆØ§Ø±Ø¯','Ø­ÙˆØ§Ù„Ø§Øª ÙˆØ§Ø±Ø¯Ø©','Ø­ÙˆØ§Ù„Ø©',true,'',''],['Ø¥ÙŠØ¯Ø§Ø¹','Ø­ÙˆØ§Ù„Ø§Øª ÙˆØ§Ø±Ø¯Ø©','Ø­ÙˆØ§Ù„Ø©',true,'',''],

    ['Ø­ÙˆØ§Ù„Ø© ØµØ§Ø¯Ø±Ø©','Ø­ÙˆØ§Ù„Ø§Øª ØµØ§Ø¯Ø±Ø©','Ø­ÙˆØ§Ù„Ø©',false,'',''],['ØªØ­ÙˆÙŠÙ„ ØµØ§Ø¯Ø±','Ø­ÙˆØ§Ù„Ø§Øª ØµØ§Ø¯Ø±Ø©','Ø­ÙˆØ§Ù„Ø©',false,'',''],

    ['paypal','Ø®Ø¯Ù…Ø§Øª Ø±Ù‚Ù…ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['itunes','Ø®Ø¯Ù…Ø§Øª Ø±Ù‚Ù…ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'',''],['google','Ø®Ø¯Ù…Ø§Øª Ø±Ù‚Ù…ÙŠØ©','Ù…Ø´ØªØ±ÙŠØ§Øª',false,'','']
  ];

  // ÙÙ‡Ø±Ø³Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­ØªÙ‰ Ù†Ø­Ø¯Ø« ÙˆÙ„Ø§ Ù†ÙƒØ±Ø±
  var current = sMap.getDataRange().getValues();
  var idx = {};
  for (var i = 1; i < current.length; i++) {
    var k = String(current[i][0] || '').toLowerCase();
    if (k) idx[k] = i + 1;
  }

  var toAppend = [];
  for (var j = 0; j < seed.length; j++) {
    var key = String(seed[j][0] || '').toLowerCase();
    if (!key) continue;

    if (idx[key]) {
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© 2-4 (Ø§Ù„ØªØµÙ†ÙŠÙ/Ø§Ù„Ù†ÙˆØ¹/isIncoming)
      sMap.getRange(idx[key], 2, 1, 3).setValues([[seed[j][1], seed[j][2], seed[j][3]]]);
    } else {
      toAppend.push(seed[j]);
    }
  }

  if (toAppend.length) {
    sMap.getRange(sMap.getLastRow() + 1, 1, toAppend.length, 6).setValues(toAppend);
  }

  // Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª ÙÙŠ Budgets
  var cats = {};
  for (var k2 = 0; k2 < seed.length; k2++) cats[seed[k2][1]] = true;
  ensureBudgetCats_(Object.keys(cats));

  safeNotify('âœ… ØªÙ… Ø²Ø±Ø¹ Ø§Ù„Ù‚Ø§Ù…ÙˆØ³ Ø§Ù„Ø¹Ø±Ø¨ÙŠ ÙˆØªØ­Ø¯ÙŠØ« Budgets Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©.');
}

function ensureBudgetCats_(cats) {
  var sB = _sheet('Budgets');
  var existing = sB.getDataRange().getValues();

  var have = {};
  for (var i = 1; i < existing.length; i++) have[String(existing[i][0] || '')] = true;

  var adds = [];
  cats.forEach(function (c) {
    if (c && !have[c]) {
      var nextRow = sB.getLastRow() + adds.length + 1;
      adds.push([c, 0, 0, '=B' + nextRow + '-C' + nextRow]);
    }
  });

  if (adds.length) {
    sB.getRange(sB.getLastRow() + 1, 1, adds.length, 4).setValues(adds);
  }
}


function diag_sendPingToHub() {
  var p = PropertiesService.getScriptProperties();
  var hub = p.getProperty('CHANNEL_ID') || p.getProperty('ADMIN_CHAT_ID') || p.getProperty('CHAT_ID') || '';
  var token = p.getProperty('TELEGRAM_TOKEN') || '';
  if (!hub || !token) throw new Error('Missing CHANNEL_ID/ADMIN_CHAT_ID/CHAT_ID or TELEGRAM_TOKEN');

  var resp = UrlFetchApp.fetch('https://api.telegram.org/bot' + token + '/sendMessage', {
    method: 'post',
    payload: {
      chat_id: String(hub),
      text: 'âœ… Ø§Ø®ØªØ¨Ø§Ø± Ping Ù…Ù† GAS Ø¥Ù„Ù‰ Bank Transactions Hub\nØ§Ù„ÙˆÙ‚Øª: ' + new Date().toLocaleString()
    },
    muteHttpExceptions: true
  });

  Logger.log(resp.getResponseCode());
  Logger.log(resp.getContentText());

  // Ù†ÙƒØªØ¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙÙŠ Sheet1 Ù„Ù„ØªÙˆØ«ÙŠÙ‚
  _sheet('Sheet1').appendRow([new Date(), 'TG_PING', '-', '-', 'diag_sendPingToHub', '-', '-', '-', '-', '-', '-', resp.getResponseCode() + ' | ' + resp.getContentText()]);
}
``


function diag_showChatProps() {
  var p = PropertiesService.getScriptProperties();
  var out = {
    CHAT_ID: p.getProperty('CHAT_ID'),
    CHANNEL_ID: p.getProperty('CHANNEL_ID'),
    ADMIN_CHAT_ID: p.getProperty('ADMIN_CHAT_ID'),
    INGRESS_SECRET: p.getProperty('INGRESS_SECRET'),
    WEBAPP_URL_DIRECT: p.getProperty('WEBAPP_URL_DIRECT')
  };
  Logger.log(JSON.stringify(out, null, 2));
  _sheet('Sheet1').appendRow([new Date(), 'PROPS_DIAG', '-', '-', 'diag_showChatProps', '-', '-', '-', '-', '-', '-', JSON.stringify(out)]);
}


function cleanup_Sheet1_DebugRows() {
  var sh = _sheet('Sheet1');
  var last = sh.getLastRow();
  if (last < 2) return;

  // Ø¹Ù…ÙˆØ¯ "Ø§Ù„Ù…ØµØ¯Ø±" Ø¹Ù†Ø¯Ùƒ Ù‡Ùˆ Ø§Ù„Ø¹Ù…ÙˆØ¯ B (Ø­Ø³Ø¨ ØªÙ‡ÙŠØ¦Ø© Sheet1)
  // Ø¥Ø°Ø§ Ø§Ø®ØªÙ„Ù Ø¹Ù†Ø¯ÙƒØŒ Ù‚Ù„ Ù„ÙŠ ÙˆØ£Ø¹Ø¯Ù„Ù‡ Ù„Ùƒ
  var colB = sh.getRange(2, 2, last - 1, 1).getValues(); // B2:B
  var kill = {
    'INGRESS_DEBUG': true,
    'TG_SEND_LOG': true,
    'PROPS_DIAG': true,
    'TG_PING': true
    // 'FLOW_ERROR': true  // ÙØ¹Ù‘Ù„Ù‡Ø§ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ø£Ø®Ø·Ø§Ø¡ Ø£ÙŠØ¶Ù‹Ø§
  };

  // Ø­Ø°Ù Ù…Ù† Ø§Ù„Ø£Ø³ÙÙ„ Ù„Ù„Ø£Ø¹Ù„Ù‰ Ø­ØªÙ‰ Ù„Ø§ ØªØªÙ„Ø®Ø¨Ø· Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØµÙÙˆÙ
  for (var i = colB.length - 1; i >= 0; i--) {
    var v = String(colB[i][0] || '');
    if (kill[v]) {
      sh.deleteRow(i + 2);
    }
  }
}

/********** Reset.gs â€” Reset Ledgers + Optional Dashboard Clear **********/

function resetLedgers_KeepHeaders() {
  var ss = _ss();

  // 1) Debt_Ledger: keep header row, clear everything below
  var sD = ss.getSheetByName('Debt_Ledger') || ss.insertSheet('Debt_Ledger');
  if (sD.getLastRow() > 1) {
    sD.getRange(2, 1, sD.getLastRow() - 1, sD.getLastColumn()).clearContent();
  }

  // 2) Debt_Index: keep header row, clear everything below
  var sIdx = ss.getSheetByName('Debt_Index') || ss.insertSheet('Debt_Index');
  if (sIdx.getLastRow() > 1) {
    sIdx.getRange(2, 1, sIdx.getLastRow() - 1, sIdx.getLastColumn()).clearContent();
  }

  // 3) Dashboard: clear sheet + remove charts (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† Ù…ÙÙŠØ¯ Ø¨Ø¹Ø¯ Ù…Ø³Ø­ Sheet1)
  var sDash = ss.getSheetByName('Dashboard') || ss.insertSheet('Dashboard');
  sDash.clear();
  var charts = sDash.getCharts();
  for (var i = 0; i < charts.length; i++) sDash.removeChart(charts[i]);

  // 4) Budgets: Ù„Ø§ Ù†Ù…Ø³Ø­ "Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø©" (B) â€” ÙÙ‚Ø· Ù†ØµÙØ± "Ø§Ù„Ù…ØµØ±ÙˆÙ" (C) ÙˆÙ†ØªØ±Ùƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ (D) ØµÙŠØºØ©
  var sB = ss.getSheetByName('Budgets') || ss.insertSheet('Budgets');
  var lastB = sB.getLastRow();
  if (lastB > 1) {
    sB.getRange(2, 3, lastB - 1, 1).setValue(0); // C2:C = 0
  }

  SpreadsheetApp.flush();

  safeNotify('âœ… Reset Ledgers: ØªÙ… ØªØµÙÙŠØ± Debt_Ledger ÙˆDebt_Index ÙˆØªØµÙÙŠØ± Ù…ØµØ±ÙˆÙ Budgets ÙˆÙ…Ø³Ø­ Dashboard.');
}
``


/********** MasterRun.gs â€” ØªØ´ØºÙŠÙ„ Ø´Ø§Ù…Ù„ V120 (LIGHT default, FULL on demand) **********/

function V120_MasterRun_LIGHT() {
  // LIGHT: Ù„Ø§ ÙŠÙ…Ø³Ø­ Sheet1 (ÙŠØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„)
  V120_MasterRun_({
    wipeSheet1: false,
    wipeRunLog: false,
    wipeIngressDebug: true,
    resetLedgers: false,
    seedClassifier: true,
    probeWebhook: true,
    runAI: true,
    rebuildDash: true,
    maintenanceDuringRun: true
  });
}

function V120_MasterRun_FULL() {
  // FULL: Ø¨ÙŠØ¦Ø© Ø§Ø®ØªØ¨Ø§Ø± Ù†Ø¸ÙŠÙØ© (ÙŠÙ…Ø³Ø­ Sheet1 + ÙŠÙ†Ø¸Ù‘Ù/ÙŠØµÙÙ‘Ø±)
  V120_MasterRun_({
    wipeSheet1: true,
    wipeRunLog: true,
    wipeIngressDebug: true,
    resetLedgers: true,
    seedClassifier: true,
    probeWebhook: true,
    runAI: true,
    rebuildDash: true,
    maintenanceDuringRun: true
  });
}

function V120_MasterRun_(opt) {
  opt = opt || {};
  var lock = LockService.getScriptLock();
  lock.waitLock(30000);

  var started = new Date();
  var runId = Utilities.getUuid().slice(0, 8);

  try {
    ensureRunLogSheet_();

    // Ù„Ùˆ FULL Ùˆ wipeRunLog=true Ø§Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡
    if (opt.wipeRunLog) {
      clearRunLog_();
    }

    runLog_(runId, 'Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„', 'INFO', { opt: opt });

    // 0) ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ¦Ø©
    step_(runId, 'ÙØ­Øµ Ø§Ù„Ø¨ÙŠØ¦Ø©', function () {
      var required = ['SHEET_ID', 'TELEGRAM_TOKEN'];
      var missing = [];
      required.forEach(function (k) { if (!ENV[k]) missing.push(k); });
      if (missing.length) throw new Error('Ø®ØµØ§Ø¦Øµ Ù†Ø§Ù‚ØµØ©: ' + missing.join(', '));
    });

    // 1) ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
    if (opt.maintenanceDuringRun) {
      step_(runId, 'ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©', function () {
        setMaintenanceMode_('on');
      });
    }

    // 2) Reset Ø§Ø®ØªØ¨Ø§Ø±ÙŠ (Ù…Ù† TestReset.gs)
    step_(runId, 'Reset Ø§Ø®ØªØ¨Ø§Ø±ÙŠ', function () {
      if (typeof V120_TestReset_ !== 'function') {
        throw new Error('V120_TestReset_ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© â€” ØªØ£ÙƒØ¯ Ù…Ù† TestReset.gs');
      }
      V120_TestReset_({
        wipeSheet1: !!opt.wipeSheet1,
        wipeRunLog: false, // Ù„Ø§ Ù†Ù…Ø³Ø­ Run_Log Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ù†ÙØ³Ù‡
        wipeIngressDebug: !!opt.wipeIngressDebug
      });
    });

    // 3) Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø£ÙˆÙ„ÙŠØ© (Ù…Ù† InitCompat + InitialSystem)
    step_(runId, 'ØªÙ‡ÙŠØ¦Ø© Ø£ÙˆÙ„ÙŠØ© (Initial)', function () {
      if (typeof V120_runInitial_ === 'function') {
        V120_runInitial_();
        return;
      }
      // fallback Ø§Ø­ØªÙŠØ§Ø·ÙŠ
      if (typeof initialsystem === 'function') { initialsystem(); return; }
      throw new Error('V120_runInitial_ / initialsystem ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© â€” ØªØ£ÙƒØ¯ Ù…Ù† InitCompat.gs Ùˆ InitialSystem.gs');
    });

    // 4) Ø²Ø±Ø¹ Ø§Ù„ØµÙŠØº (ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ test_10_seed_formulas Ø£Ùˆ V120_seedFormulas_)
    step_(runId, 'Ø²Ø±Ø¹ Ø§Ù„ØµÙŠØº', function () {
      if (typeof test_10_seed_formulas === 'function') {
        test_10_seed_formulas();
        return;
      }
      if (typeof V120_seedFormulas_ === 'function') {
        V120_seedFormulas_();
        return;
      }
      throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ù„Ø© Ø²Ø±Ø¹ ØµÙŠØº: test_10_seed_formulas Ø£Ùˆ V120_seedFormulas_');
    });

    // 5) Reset Ledgers (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (opt.resetLedgers) {
      step_(runId, 'Reset Ledgers', function () {
        if (typeof resetLedgers_KeepHeaders !== 'function') throw new Error('resetLedgers_KeepHeaders ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        resetLedgers_KeepHeaders();
      });
    }

    // 6) Seed Classifier (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (opt.seedClassifier) {
      step_(runId, 'Seed Classifier (AR)', function () {
        if (typeof seedClassifierMap_AR !== 'function') throw new Error('seedClassifierMap_AR ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        seedClassifierMap_AR();
      });
    }

    // 7) Probe Webhook (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (opt.probeWebhook) {
      step_(runId, 'Probe Webhook (GET/POST)', function () {
        if (typeof test_01_probeWebhook !== 'function') throw new Error('test_01_probeWebhook ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        test_01_probeWebhook();
      });
    }

    // 8) AI Diagnostics (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (opt.runAI) {
      step_(runId, 'AI Diagnostics', function () {
        if (typeof test_AI_Diagnostics !== 'function') throw new Error('test_AI_Diagnostics ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        test_AI_Diagnostics();
      });
    }

    // 9) Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Budgets Ù…Ù† Sheet1
    step_(runId, 'Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ù† Sheet1', function () {
      if (typeof test_05_recompute_budgets_from_sheet1 !== 'function') throw new Error('test_05_recompute_budgets_from_sheet1 ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
      test_05_recompute_budgets_from_sheet1();
    });

    // 10) Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Dashboard (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
    if (opt.rebuildDash) {
      step_(runId, 'Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ù†Ø§Ø¡ Dashboard', function () {
        if (typeof rebuildDashboard !== 'function') throw new Error('rebuildDashboard ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
        rebuildDashboard();
      });
    }

    // 11) Telegram Ping Ø¥Ù„Ù‰ HUB
    step_(runId, 'Telegram Ping', function () {
      var hub = (typeof getHubChatId_ === 'function') ? getHubChatId_() : (ENV.CHAT_ID || '');
      if (!hub) throw new Error('Ù„Ø§ ÙŠÙˆØ¬Ø¯ HUB/CHAT_ID Ù„Ù„Ø¥Ø±Ø³Ø§Ù„');
      if (typeof sendTelegram_ !== 'function') throw new Error('sendTelegram_ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©');
      sendTelegram_(hub, 'âœ… V120 MasterRun OK\nRunId: ' + runId + '\nØ§Ù„ÙˆÙ‚Øª: ' + started.toLocaleString());
    });

    // 12) Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©
    if (opt.maintenanceDuringRun) {
      step_(runId, 'Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø©', function () {
        setMaintenanceMode_('off');
      });
    }

    runLog_(runId, 'Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„', 'OK', { durationSec: Math.round((new Date() - started) / 1000) });

  } catch (e) {
    runLog_(runId, 'ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„', 'ERROR', { error: String(e) });
    throw e;
  } finally {
    // Ø¶Ù…Ø§Ù† Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø­ØªÙ‰ Ù„Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
    try { setMaintenanceMode_('off'); } catch (_) {}
    lock.releaseLock();
  }
}

function setMaintenanceMode_(mode) {
  mode = String(mode || '').toLowerCase();
  PropertiesService.getScriptProperties().setProperty('MAINTENANCE_MODE', mode === 'on' ? 'on' : 'off');
}

function step_(runId, name, fn) {
  var t0 = new Date();
  runLog_(runId, name, 'RUN', {});
  try {
    fn();
    runLog_(runId, name, 'OK', { ms: (new Date() - t0) });
  } catch (e) {
    runLog_(runId, name, 'FAIL', { ms: (new Date() - t0), error: String(e) });
    throw e;
  }
}

function ensureRunLogSheet_() {
  var sh = _sheet('Run_Log');
  if (sh.getLastRow() === 0) {
    sh.appendRow(['Ø§Ù„ÙˆÙ‚Øª', 'RunId', 'Ø§Ù„Ù…Ø±Ø­Ù„Ø©', 'Ø§Ù„Ø­Ø§Ù„Ø©', 'ØªÙØ§ØµÙŠÙ„']);
    sh.setFrozenRows(1);
    sh.setRightToLeft(true);
    sh.getRange('A:A').setNumberFormat('yyyy-MM-dd HH:mm:ss');
  }
}

function clearRunLog_() {
  var sh = _sheet('Run_Log');
  if (sh.getLastRow() > 1) {
    sh.getRange(2, 1, sh.getLastRow() - 1, sh.getLastColumn()).clearContent();
  }
}

function runLog_(runId, stage, status, details) {
  var sh = _sheet('Run_Log');
  var s = '';
  try { s = JSON.stringify(details || {}); } catch (e) { s = String(details || ''); }
  sh.appendRow([new Date(), String(runId), String(stage), String(status), s.slice(0, 1500)]);
}


/********** InitCompat.gs â€” ØªÙˆØ§ÙÙ‚ Ø¢Ù…Ù† Ø¨Ø¯ÙˆÙ† Recursion **********/

/**
 * Ø¯Ø§Ù„Ø© Ù…ÙˆØ­Ø¯Ø© Ù„Ù„ØªÙ‡ÙŠØ¦Ø© â€” ØªØ³ØªØ¯Ø¹ÙŠ "Ø§Ù„ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ" ÙÙ‚Ø·
 * ÙˆÙ„Ø§ ØªØ³ØªØ¯Ø¹ÙŠ initialSystemSetup (Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª).
 */
function V120_runInitial_() {
  if (typeof V120_initialSystemSetupImpl_ === 'function') {
    return V120_initialSystemSetupImpl_();
  }
  // fallback Ø¥Ù† ÙƒØ§Ù†Øª Ù„Ø¯ÙŠÙƒ Ù†Ø³Ø®Ø© Ù‚Ø¯ÙŠÙ…Ø© ÙÙŠ Ù…Ù„Ù Ø¢Ø®Ø±
  if (typeof initialSystemSetup_ === 'function') return initialSystemSetup_();
  if (typeof initialSystemSetupV120 === 'function') return initialSystemSetupV120();

  throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© ØªÙ†ÙÙŠØ°ÙŠØ©: V120_initialSystemSetupImpl_');
}

/**
 * Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©/Ø§Ù„ØªÙˆØ§ÙÙ‚
 */
function initialsystem() {
  return V120_runInitial_();
}


/********** Control.gs â€” Maintenance + Stop Webhook **********/

function V120_Maintenance_ON() {
  PropertiesService.getScriptProperties().setProperty('MAINTENANCE_MODE', 'on');
  safeNotify('âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (MAINTENANCE_MODE=on).');
}

function V120_Maintenance_OFF() {
  PropertiesService.getScriptProperties().setProperty('MAINTENANCE_MODE', 'off');
  safeNotify('âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙˆØ¶Ø¹ Ø§Ù„ØµÙŠØ§Ù†Ø© (MAINTENANCE_MODE=off).');
}

/**
 * Ø¥ÙŠÙ‚Ø§Ù Webhook ÙÙŠ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… + ØªØµÙÙŠØ± Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©
 * Ù…ÙÙŠØ¯ Ø¥Ø°Ø§ ØªØ±ÙŠØ¯ "ØªØ¬Ù…ÙŠØ¯" Ø§Ù„Ø¨ÙˆØª Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ ÙƒØ¨ÙŠØ±.
 */
function V120_StopTelegramWebhook_NOW() {
  var token = PropertiesService.getScriptProperties().getProperty('TELEGRAM_TOKEN');
  if (!token) throw new Error('TELEGRAM_TOKEN ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');

  var resp = UrlFetchApp.fetch('https://api.telegram.org/bot' + token + '/deleteWebhook', {
    method: 'post',
    payload: { drop_pending_updates: true },
    muteHttpExceptions: true
  });

  safeNotify('deleteWebhook: ' + resp.getResponseCode() + '\n' + resp.getContentText());
}


/********** TestReset.gs â€” Reset Ø´Ø§Ù…Ù„ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø± **********/

function V120_TestReset_FULL_WipeSheet1() {
  V120_TestReset_({ wipeSheet1: true, wipeRunLog: true, wipeIngressDebug: true });
}

function V120_TestReset_LIGHT_KeepSheet1() {
  V120_TestReset_({ wipeSheet1: false, wipeRunLog: false, wipeIngressDebug: true });
}

function V120_TestReset_(opt) {
  opt = opt || {};
  var ss = _ss();

  // 1) Sheet1
  var s1 = _sheet('Sheet1');
  if (opt.wipeSheet1 && s1.getLastRow() > 1) {
    s1.getRange(2, 1, s1.getLastRow() - 1, s1.getLastColumn()).clearContent();
  }

  // 2) Budgets: ØµÙÙ‘Ø± Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙ‚Ø·
  var sB = _sheet('Budgets');
  if (sB.getLastRow() > 1) sB.getRange(2, 3, sB.getLastRow() - 1, 1).setValue(0);

  // 3) Debt_Ledger + Debt_Index
  var sD = _sheet('Debt_Ledger');
  if (sD.getLastRow() > 1) sD.getRange(2, 1, sD.getLastRow() - 1, sD.getLastColumn()).clearContent();

  var sIdx = _sheet('Debt_Index');
  if (sIdx.getLastRow() > 1) sIdx.getRange(2, 1, sIdx.getLastRow() - 1, sIdx.getLastColumn()).clearContent();

  // 4) Dashboard: Ù…Ø³Ø­ ÙƒØ§Ù…Ù„ + Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø±Ø³ÙˆÙ…
  var sDash = _sheet('Dashboard');
  sDash.clear();
  var charts = sDash.getCharts();
  for (var i = 0; i < charts.length; i++) sDash.removeChart(charts[i]);

  // 5) Run_Log (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if (opt.wipeRunLog) {
    var sRun = _sheet('Run_Log');
    if (sRun.getLastRow() > 1) sRun.getRange(2, 1, sRun.getLastRow() - 1, sRun.getLastColumn()).clearContent();
  }

  // 6) Ingress_Debug (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
  if (opt.wipeIngressDebug) {
    var sDbg = _sheet('Ingress_Debug');
    if (sDbg.getLastRow() > 1) sDbg.getRange(2, 1, sDbg.getLastRow() - 1, sDbg.getLastColumn()).clearContent();
  }

  SpreadsheetApp.flush();
  safeNotify('âœ… TestReset: Ø§ÙƒØªÙ…Ù„ (wipeSheet1=' + !!opt.wipeSheet1 + ')');
}


/********** InitialSystem.gs â€” Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªÙ†ÙÙŠØ°ÙŠØ© Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© **********/

function V120_initialSystemSetupImpl_() {
  var ss = _ss();

  // Sheet1
  var s1 = _sheet('Sheet1');
  var h1 = ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ù…ØµØ¯Ø±','Ø§Ù„ÙØªØ±Ø©Ù¡','Ø§Ù„ÙØªØ±Ø©Ù¢','Ø§Ù„Ù‚Ù†Ø§Ø©/Ø§Ù„Ù…ØµØ¯Ø±','Ø±Ù‚Ù… Ø§Ù„Ø­Ø³Ø§Ø¨','Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©/Ø§Ù„Ø·Ø±Ù','Ø§Ù„Ù…Ø¨Ù„Øº','Ø§Ù„Ø¬Ù‡Ø©/Ø§Ù„ØªØ§Ø¬Ø±','Ø§Ù„ØªØµÙ†ÙŠÙ','Ø§Ù„Ù†ÙˆØ¹','Ø§Ù„Ù†Øµ Ø§Ù„Ø®Ø§Ù…'];
  if (s1.getLastRow() === 0) s1.appendRow(h1);
  else s1.getRange(1, 1, 1, h1.length).setValues([h1]);
  s1.setFrozenRows(1);
  s1.setRightToLeft(true);
  s1.getRange('A:A').setNumberFormat('yyyy-MM-dd HH:mm');
  s1.getRange('H:H').setNumberFormat('#,##0.00');

  // Budgets
  var sB = _sheet('Budgets');
  var hB = ['Ø§Ù„ØªØµÙ†ÙŠÙ','Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø©','Ø§Ù„Ù…ØµØ±ÙˆÙ','Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ'];
  if (sB.getLastRow() === 0) sB.appendRow(hB);
  else sB.getRange(1, 1, 1, hB.length).setValues([hB]);
  sB.setFrozenRows(1);
  sB.setRightToLeft(true);
  var lastB = Math.max(2, sB.getLastRow());
  if (lastB >= 2) {
    sB.getRange(2, 2, lastB - 1, 3).setNumberFormat('#,##0.00');
    sB.getRange(2, 4, lastB - 1, 1).setFormulaR1C1('=RC[-2]-RC[-1]');
  }
  try { ss.setNamedRange('BudgetCategories', sB.getRange('A2:A')); } catch (e) {}

  // Debt_Ledger
  var sD = _sheet('Debt_Ledger');
  var hD = ['Ø§Ù„ØªØ§Ø±ÙŠØ®','Ø§Ù„Ø·Ø±Ù','Ù…Ø¯ÙŠÙ†','Ø¯Ø§Ø¦Ù†','Ø§Ù„Ø±ØµÙŠØ¯','ÙˆØµÙ'];
  if (sD.getLastRow() === 0) sD.appendRow(hD);
  else sD.getRange(1, 1, 1, hD.length).setValues([hD]);
  sD.setFrozenRows(1);
  sD.setRightToLeft(true);
  sD.getRange('A:A').setNumberFormat('yyyy-MM-dd HH:mm');
  sD.getRange('C:E').setNumberFormat('#,##0.00');
  if (sD.getLastRow() >= 2) {
    sD.getRange(2, 5).setFormula('=D2-C2');
    if (sD.getLastRow() > 2) {
      sD.getRange(3, 5, sD.getLastRow() - 2, 1).setFormulaR1C1('=R[-1]C+RC[-1]-RC[-2]');
    }
  }

  // Dashboard
  var sDash = _sheet('Dashboard');
  sDash.setRightToLeft(true);

  // Debt_Index
  var sIdx = _sheet('Debt_Index');
  var hIdx = ['Ø§Ù„Ø·Ø±Ù','Ø§Ù„Ø­Ø³Ø§Ø¨/Ø§Ù„Ø·Ø±Ù','ØµØ§ÙÙ Ù…ÙØ³ØªØ­Ù‚ Ù„Ù†Ø§ (+) / Ø¹Ù„ÙŠÙ†Ø§ (-)','Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«'];
  if (sIdx.getLastRow() === 0) sIdx.appendRow(hIdx);
  else sIdx.getRange(1, 1, 1, hIdx.length).setValues([hIdx]);
  sIdx.setFrozenRows(1);
  sIdx.setRightToLeft(true);
  sIdx.getRange('C:C').setNumberFormat('#,##0.00');
  sIdx.getRange('D:D').setNumberFormat('yyyy-MM-dd HH:mm');

  // Classifier_Map
  var sMap = _sheet('Classifier_Map');
  var hM = ['ÙƒÙ„Ù…Ø© Ù…ÙØªØ§Ø­ÙŠØ©','Ø§Ù„ØªØµÙ†ÙŠÙ','Ø§Ù„Ù†ÙˆØ¹','isIncoming','accNum','cardNum'];
  if (sMap.getLastRow() === 0) sMap.appendRow(hM);
  else sMap.getRange(1, 1, 1, hM.length).setValues([hM]);
  sMap.setRightToLeft(true);

  // Validation Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ Ø§Ù„ØªØµÙ†ÙŠÙ ÙÙŠ Sheet1 (J)
  try {
    var rule = SpreadsheetApp.newDataValidation()
      .requireFormulaSatisfied('=COUNTIF(BudgetCategories,INDIRECT("RC",FALSE))>0')
      .setAllowInvalid(true)
      .build();
    s1.getRange('J2:J').setDataValidation(rule);
  } catch (e2) {}

  // RTL Ù„ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
  try { ss.getSheets().forEach(function (sh) { sh.setRightToLeft(true); }); } catch (e3) {}

  safeNotify('âœ… initialsystem: ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆØ§Ù„ØµÙŠØº ÙˆØ§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª ÙˆRTL.');
}


/********** SeedFormulas.gs â€” ØªÙˆÙÙŠØ± test_10_seed_formulas + V120_seedFormulas_ **********/

function V120_seedFormulas_() {
  // Budgets: Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ = Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø© - Ø§Ù„Ù…ØµØ±ÙˆÙ
  var sB = _sheet('Budgets');
  if (sB.getLastRow() >= 2) {
    sB.getRange(2, 4, sB.getLastRow() - 1, 1).setFormulaR1C1('=RC[-2]-RC[-1]');
  }

  // Debt_Ledger: Ø§Ù„Ø±ØµÙŠØ¯ = Ø§Ù„Ø³Ø§Ø¨Ù‚ + (Ø¯Ø§Ø¦Ù† - Ù…Ø¯ÙŠÙ†)
  var sD = _sheet('Debt_Ledger');
  if (sD.getLastRow() >= 2) {
    sD.getRange(2, 5).setFormula('=D2-C2');
    if (sD.getLastRow() > 2) {
      sD.getRange(3, 5, sD.getLastRow() - 2, 1).setFormulaR1C1('=R[-1]C+RC[-1]-RC[-2]');
    }
  }

  safeNotify('âœ… Seed formulas: ØªÙ… Ø²Ø±Ø¹/Ø¥ØµÙ„Ø§Ø­ ØµÙŠØº Budgets ÙˆDebt_Ledger.');
}

/**
 * Ø§Ø³Ù… Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø§Ù„Ø°ÙŠ ÙŠØ¨Ø­Ø« Ø¹Ù†Ù‡ MasterRun Ø£Ø­ÙŠØ§Ù†Ù‹Ø§
 * Ù†Ø¬Ø¹Ù„Ù‡ Wrapper Ø¹Ù„Ù‰ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
 */
function test_10_seed_formulas() {
  V120_seedFormulas_();
}


/********** ProbeWebhook.gs â€” ØªÙˆÙÙŠØ± test_01_probeWebhook + V120_probeWebhook_ **********/

function V120_probeWebhook_() {
  var url = ENV.WEBAPP_URL_DIRECT || ENV.WEBAPP_URL;
  if (!url) throw new Error('Ø¶Ø¹ WEBAPP_URL_DIRECT Ø£Ùˆ WEBAPP_URL ÙÙŠ Script Properties.');

  var secret = ENV.INGRESS_SECRET || '';
  var getUrl = url + '?sms=' + encodeURIComponent('Hello') + '&secret=' + encodeURIComponent(secret);

  // GET
  var respGet = UrlFetchApp.fetch(getUrl, {
    muteHttpExceptions: true,
    followRedirects: true
  });

  // POST (Ù†Øµ Ø®Ø§Ù…)
  var postUrl = url + '?secret=' + encodeURIComponent(secret);
  var respPost = UrlFetchApp.fetch(postUrl, {
    method: 'post',
    headers: { 'X-INGRESS-SECRET': String(secret) },
    payload: 'Ø­ÙˆØ§Ù„Ø© ÙˆØ§Ø±Ø¯Ø© Ø¨Ù€ 2000 SAR Ù…Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ 8001',
    muteHttpExceptions: true,
    followRedirects: true
  });

  var msg = 'Probe Webhook\n' +
    'GET=' + respGet.getResponseCode() + '\n' +
    'POST=' + respPost.getResponseCode() + '\n' +
    'â€”\n' +
    'GET body: ' + String(respGet.getContentText() || '').slice(0, 200) + '\n' +
    'POST body: ' + String(respPost.getContentText() || '').slice(0, 200);

  // Ø³Ø¬Ù„ Ø³Ø±ÙŠØ¹ ÙÙŠ Run_Log Ø¥Ù† ÙˆØ¬Ø¯
  try {
    _sheet('Run_Log').appendRow([new Date(), '-', 'Probe Webhook (manual)', 'INFO', msg]);
  } catch (_) {}

  // ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
  safeNotify(msg);
}

function test_01_probeWebhook() {
  V120_probeWebhook_();
}


/********** AIDiagnostics.gs â€” ØªÙˆÙÙŠØ± test_AI_Diagnostics + V120_AI_Diagnostics_ **********/

function V120_AI_Diagnostics_() {
  // Ø¹ÙŠÙ†Ø§Øª Ù‚ÙŠØ§Ø³ÙŠØ©
  var samples = [
    'Ø­ÙˆØ§Ù„Ø© ÙˆØ§Ø±Ø¯Ø© Ø¨Ù€ 2000 SAR Ù…Ù† Ù…Ø­Ù…Ø¯ Ø§Ù„Ø­Ø±Ø¨ÙŠ Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨ 8001',
    'Ø´Ø±Ø§Ø¡ 120 SAR Ø¹Ø¨Ø± STC Pay ÙÙŠ Ù…ØªØ¬Ø± ØªØ¬Ø±ÙŠØ¨ÙŠ',
    'Ø³Ø­Ø¨ ATM Ø¨Ù…Ø¨Ù„Øº 400 SAR Ù…Ù† Ø¨Ø·Ø§Ù‚Ø© 4912'
  ];

  // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªÙˆÙØ± Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  var hasProbe = (typeof callAiProbe_ === 'function');
  var hasHybrid = (typeof callAiHybridV120 === 'function');
  var hasClassifier = (typeof applyClassifierMap_ === 'function');

  if (!hasProbe && !hasHybrid) {
    throw new Error('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø§Ù„Ø© AI: callAiProbe_ Ø£Ùˆ callAiHybridV120 â€” ØªØ£ÙƒØ¯ Ù…Ù† AI.gs');
  }
  if (!hasClassifier) {
    throw new Error('applyClassifierMap_ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø© â€” ØªØ£ÙƒØ¯ Ù…Ù† Classifier.gs');
  }

  var lines = [];
  var s1 = _sheet('Sheet1');

  for (var i = 0; i < samples.length; i++) {
    var text = samples[i];

    // 1) Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ AI (Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø­Ø±Ùƒ Ø¥Ù† ØªÙˆÙÙ‘Ø± callAiProbe_)
    var out;
    if (hasProbe) {
      out = callAiProbe_(text);  // ÙŠØ±Ø¬Ø¹ {ai, engine}
    } else {
      out = { ai: callAiHybridV120(text), engine: 'hybrid' };
    }

    // 2) ØªØ·Ø¨ÙŠÙ‚ Ø°Ø§ÙƒØ±Ø© Ø§Ù„ØªØµÙ†ÙŠÙ
    var ai2 = applyClassifierMap_(text, out.ai);

    // 3) ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Sheet1 ÙƒØ³Ø·Ø± ØªØ´Ø®ÙŠØµ
    s1.appendRow([
      new Date(),
      'AI_DIAG',
      '-',
      '-',
      'Ø§Ø®ØªØ¨Ø§Ø±_AI',
      '',
      '',
      Number(ai2.amount || 0),
      ai2.merchant || '',
      ai2.category || '',
      ai2.type || '',
      text
    ]);

    // 4) ØªÙ„Ø®ÙŠØµ
    lines.push('â€¢ ' + String(out.engine || '').toUpperCase() + ' â†’ ' +
      (ai2.type || '-') + ' | ' + (ai2.category || '-') + ' | ' +
      Number(ai2.amount || 0).toFixed(2) + ' SAR');
  }

  // Ø¥Ø±Ø³Ø§Ù„ Ù…Ù„Ø®Øµ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù… (HUB)
  var hub = (typeof getHubChatId_ === 'function') ? getHubChatId_() : (ENV.CHAT_ID || '');
  if (hub && typeof sendTelegram_ === 'function') {
    sendTelegram_(hub, 'ğŸ¤– Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:\n' + lines.join('\n'));
  }

  safeNotify('âœ… ØªÙ… Ø§Ø®ØªØ¨Ø§Ø± AI. Ø§Ù†Ø¸Ø± Sheet1 ÙˆØ±Ø³Ø§Ù„Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….');
}

function test_AI_Diagnostics() {
  V120_AI_Diagnostics_();
}
``


/********** Webhook.gs â€” setWebhook_DIRECT_no302 **********/

function setWebhook_DIRECT_no302() {
  var base = ENV.WEBAPP_URL_DIRECT || ENV.WEBAPP_URL || '';
  if (!base) throw new Error('Ø¶Ø¹ WEBAPP_URL_DIRECT Ø£Ùˆ WEBAPP_URL ÙÙŠ Script Properties.');

  // Ù†Ø¶ÙŠÙ secret ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø· (Ø§Ù„Ø£ÙƒØ«Ø± Ø«Ø¨Ø§ØªÙ‹Ø§ ÙÙŠ GAS)
  var url = base + '?secret=' + encodeURIComponent(ENV.INGRESS_SECRET || '');

  // deleteWebhook Ø«Ù… setWebhook
  UrlFetchApp.fetch('https://api.telegram.org/bot' + ENV.TELEGRAM_TOKEN + '/deleteWebhook', {
    method: 'post',
    payload: { drop_pending_updates: true },
    muteHttpExceptions: true
  });

  var resp = UrlFetchApp.fetch('https://api.telegram.org/bot' + ENV.TELEGRAM_TOKEN + '/setWebhook', {
    method: 'post',
    payload: {
      url: url,
      allowed_updates: JSON.stringify(['message', 'channel_post', 'callback_query']),
      max_connections: 40,
      drop_pending_updates: true,
      // secret_token Ø§Ø®ØªÙŠØ§Ø±ÙŠ (Ù‚Ø¯ Ù„Ø§ ÙŠØ¸Ù‡Ø± ÙÙŠ e.headers Ø¯Ø§Ø¦Ù…Ù‹Ø§ Ø¯Ø§Ø®Ù„ GAS)
      secret_token: (ENV.TG_SECRET_TOKEN || '')
    },
    muteHttpExceptions: true
  });

  var info = UrlFetchApp.fetch('https://api.telegram.org/bot' + ENV.TELEGRAM_TOKEN + '/getWebhookInfo', {
    muteHttpExceptions: true
  });

  safeNotify('setWebhook(DIRECT): ' + resp.getContentText() + '\ninfo: ' + info.getContentText());
}
