/**
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * COMPREHENSIVE_TEST.js - Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù…ÙˆØ­Ø¯ END-TO-END
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * 
 * ğŸ¯ Ø´ØºÙ„ Ø¯Ø§Ù„Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·: RUN_COMPREHENSIVE_TEST()
 * 
 * ÙŠÙ‚ÙˆÙ… Ù‡Ø°Ø§ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù€:
 * 1. ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª
 * 2. ÙØ­Øµ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆÙ‡ÙŠÙƒÙ„Ù‡Ø§
 * 3. Ø§Ø®ØªØ¨Ø§Ø± Parser Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©
 * 4. Ø§Ø®ØªØ¨Ø§Ø± Flow ÙƒØ§Ù…Ù„ (Ø¥Ø¯Ø®Ø§Ù„ â†’ Ù…Ø¹Ø§Ù„Ø¬Ø© â†’ ØªØ®Ø²ÙŠÙ†)
 * 5. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ±Ø§Ø¨Ø· Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
 * 6. Ø§Ø®ØªØ¨Ø§Ø± Cascade Delete
 * 7. ÙØ­Øµ Webhook
 * 8. Ø§Ø®ØªØ¨Ø§Ø± Ø¥Ø±Ø³Ø§Ù„ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
 * 
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 */

/**
 * ğŸš€ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ - Ø´ØºÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙ‚Ø·!
 */
function RUN_COMPREHENSIVE_TEST() {
  var startTime = Date.now();
  var results = {
    total: 0,
    passed: 0,
    failed: 0,
    tests: [],
    errors: []
  };
  
  Logger.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  Logger.log('â•‘           ğŸ§ª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ - SJA MoneyTracker              â•‘');
  Logger.log('â•‘                    ' + new Date().toLocaleString('ar-SA') + '                   â•‘');
  Logger.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1/8: ÙØ­Øµ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ù…ØªØºÙŠØ±Ø§Øª');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  runTest_(results, 'ENV Ù…Ø¹Ø±Ù‘Ù', function() {
    return typeof ENV !== 'undefined' && ENV !== null;
  });
  
  runTest_(results, 'SHEET_ID Ù…ÙˆØ¬ÙˆØ¯', function() {
    return ENV.SHEET_ID && ENV.SHEET_ID.length > 10;
  });
  
  runTest_(results, 'TELEGRAM_TOKEN Ù…ÙˆØ¬ÙˆØ¯', function() {
    return ENV.TELEGRAM_TOKEN && ENV.TELEGRAM_TOKEN.length > 20;
  });
  
  runTest_(results, 'CHAT_ID Ù…ÙˆØ¬ÙˆØ¯', function() {
    return (ENV.CHAT_ID && ENV.CHAT_ID.length > 0) || (ENV.CHANNEL_ID && ENV.CHANNEL_ID.length > 0);
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: ÙØ­Øµ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2/8: ÙØ­Øµ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚ ÙˆØ§Ù„Ù‡ÙŠÙƒÙ„');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  runTest_(results, 'Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ Spreadsheet', function() {
    var ss = _ss();
    return ss && ss.getName().length > 0;
  });
  
  var requiredSheets = ['Sheet1', 'Budgets', 'Dashboard', 'Debt_Ledger'];
  requiredSheets.forEach(function(sheetName) {
    runTest_(results, 'ÙˆØ±Ù‚Ø© ' + sheetName + ' Ù…ÙˆØ¬ÙˆØ¯Ø©', function() {
      var sheet = _sheet(sheetName);
      return sheet !== null;
    });
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø§Ø®ØªØ¨Ø§Ø± Parser
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3/8: Ø§Ø®ØªØ¨Ø§Ø± Parser Ø¹Ù„Ù‰ Ø±Ø³Ø§Ø¦Ù„ Ø­Ù‚ÙŠÙ‚ÙŠØ©');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  var testMessages = [
    {
      name: 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØµØ§Ø¯Ø±Ø©',
      sms: 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØµØ§Ø¯Ø±Ø©\nÙ…Ù†1626\nØ¨Ù€SAR 500\nÙ„Ù€3818;Ù…Ù‚Ø±Ù† Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ\n26/1/20 17:16',
      expected: { amount: 500, isIncoming: false }
    },
    {
      name: 'Ø´Ø±Ø§Ø¡ Ù…Ø¯Ù‰',
      sms: 'Ø´Ø±Ø§Ø¡ Ù…Ø¯Ù‰ Ù…Ø¨Ù„Øº: SAR 150.00 Ù„Ø¯Ù‰: Ø¬Ø±ÙŠØ±',
      expected: { amount: 150, isIncoming: false }
    },
    {
      name: 'Ø­ÙˆØ§Ù„Ø© ÙˆØ§Ø±Ø¯Ø©',
      sms: 'Ø­ÙˆØ§Ù„Ø© ÙˆØ§Ø±Ø¯Ø© Ø¥Ù„Ù‰ Ø­Ø³Ø§Ø¨Ùƒ Ø¨Ù…Ø¨Ù„Øº 1000 Ø±ÙŠØ§Ù„',
      expected: { isIncoming: true }
    }
  ];
  
  testMessages.forEach(function(test) {
    runTest_(results, 'Parser: ' + test.name, function() {
      var parsed = SOV1_preParseFallback_(test.sms);
      Logger.log('     â†’ Ø§Ù„Ù…Ø¨Ù„Øº: ' + parsed.amount + ', ÙˆØ§Ø±Ø¯: ' + parsed.isIncoming + ', Ø§Ù„ØªØ§Ø¬Ø±: ' + parsed.merchant);
      
      if (test.expected.amount && Math.abs(parsed.amount - test.expected.amount) > 0.01) return false;
      if (test.expected.isIncoming !== undefined && parsed.isIncoming !== test.expected.isIncoming) return false;
      return parsed.amount > 0 || test.expected.isIncoming;
    });
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø§Ø®ØªØ¨Ø§Ø± Flow ÙƒØ§Ù…Ù„
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4/8: Ø§Ø®ØªØ¨Ø§Ø± Flow ÙƒØ§Ù…Ù„ (END-TO-END)');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  var testUUID = null;
  var s1 = _sheet('Sheet1');
  var beforeCount = s1.getLastRow();
  
  runTest_(results, 'Flow: Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø³Ø§Ù„Ø© SMS', function() {
    var testSMS = 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØµØ§Ø¯Ø±Ø©\nÙ…Ù†9999\nØ¨Ù€SAR 123.45\nÙ„Ù€1234;Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„\n26/1/21 22:00';
    var result = executeUniversalFlowV120(testSMS, 'COMPREHENSIVE_TEST', null);
    
    if (result && result.uuid) {
      testUUID = result.uuid;
      Logger.log('     â†’ UUID: ' + testUUID);
    }
    
    return result !== null;
  });
  
  runTest_(results, 'Flow: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙØ¶ÙŠÙØª Ù„Ù€ Sheet1', function() {
    SpreadsheetApp.flush();
    var afterCount = s1.getLastRow();
    Logger.log('     â†’ Ù‚Ø¨Ù„: ' + beforeCount + ', Ø¨Ø¹Ø¯: ' + afterCount);
    return afterCount > beforeCount;
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ±Ø§Ø¨Ø· Ø§Ù„Ø£ÙˆØ±Ø§Ù‚
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5/8: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ±Ø§Ø¨Ø· Ø§Ù„Ø£ÙˆØ±Ø§Ù‚');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  runTest_(results, 'UUID Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Sheet1', function() {
    if (!testUUID) return false;
    var found = findTransactionByUUID_(testUUID);
    return found !== null;
  });
  
  runTest_(results, 'Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Dashboard', function() {
    var dash = _sheet('Dashboard');
    var lastRow = dash.getLastRow();
    return lastRow >= 2;
  });
  
  runTest_(results, 'Budgets Ù…Ø­Ø¯Ù‘Ø«Ø©', function() {
    var budgets = _sheet('Budgets');
    var data = budgets.getDataRange().getValues();
    return data.length >= 2;
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø§Ø®ØªØ¨Ø§Ø± Cascade Delete
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6/8: Ø§Ø®ØªØ¨Ø§Ø± Cascade Delete');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  runTest_(results, 'Cascade Delete ÙŠØ¹Ù…Ù„', function() {
    if (!testUUID) return false;
    var result = deleteTransaction_(testUUID);
    Logger.log('     â†’ Ø­ÙØ°ÙØª Ù…Ù†: ' + (result.deleted || []).join(', '));
    return result && result.success && result.deleted && result.deleted.length > 0;
  });
  
  runTest_(results, 'UUID Ù…Ø­Ø°ÙˆÙ Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£ÙˆØ±Ø§Ù‚', function() {
    if (!testUUID) return true; // ØªØ®Ø·ÙŠ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ UUID
    var found = findTransactionByUUID_(testUUID);
    return found === null;
  });
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7: ÙØ­Øµ Webhook
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 7/8: ÙØ­Øµ Webhook');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  runTest_(results, 'Web App URL', function() {
    var url = ScriptApp.getService().getUrl();
    Logger.log('     â†’ URL: ' + (url || 'ØºÙŠØ± Ù…Ù†Ø´ÙˆØ±'));
    return url && url.length > 0;
  });
  
  runTest_(results, 'Webhook Ù…Ø¶Ø¨ÙˆØ· (ÙŠØ­ØªØ§Ø¬ /exec)', function() {
    if (!ENV.TELEGRAM_TOKEN) return null; // skip
    
    try {
      var resp = UrlFetchApp.fetch('https://api.telegram.org/bot' + ENV.TELEGRAM_TOKEN + '/getWebhookInfo', {
        muteHttpExceptions: true
      });
      var info = JSON.parse(resp.getContentText());
      
      if (info.ok && info.result && info.result.url) {
        var url = info.result.url;
        var isExec = url.indexOf('/exec') !== -1;
        var isDev = url.indexOf('/dev') !== -1;
        
        Logger.log('     â†’ URL: ' + url);
        Logger.log('     â†’ Ù†ÙˆØ¹: ' + (isExec ? '/exec âœ…' : (isDev ? '/dev âŒ (ÙŠØ³Ø¨Ø¨ 401!)' : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ')));
        
        if (info.result.last_error_message) {
          Logger.log('     â†’ Ø¢Ø®Ø± Ø®Ø·Ø£: ' + info.result.last_error_message);
        }
        
        return isExec;
      }
      return false;
    } catch (e) {
      return false;
    }
  }, true);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8: Ø§Ø®ØªØ¨Ø§Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  Logger.log('\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“¦ Ø§Ù„Ù…Ø±Ø­Ù„Ø© 8/8: Ø§Ø®ØªØ¨Ø§Ø± ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  runTest_(results, 'Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…', function() {
    if (!ENV.TELEGRAM_TOKEN || !(ENV.CHAT_ID || ENV.CHANNEL_ID)) return null;
    
    var chatId = ENV.CHAT_ID || ENV.CHANNEL_ID;
    var result = sendTelegram_(chatId, 'âœ… Ø§Ø®ØªØ¨Ø§Ø± Ø´Ø§Ù…Ù„ Ù†Ø§Ø¬Ø­!\nâ° ' + new Date().toLocaleString('ar-SA'));
    return result && result.ok;
  }, true);
  
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  // ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  var duration = ((Date.now() - startTime) / 1000).toFixed(2);
  var passRate = results.total > 0 ? ((results.passed / results.total) * 100).toFixed(1) : 0;
  
  Logger.log('\n\n');
  Logger.log('â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—');
  Logger.log('â•‘                         ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©                          â•‘');
  Logger.log('â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£');
  Logger.log('â•‘                                                                       â•‘');
  Logger.log('â•‘   âœ… Ù†Ø¬Ø­: ' + String(results.passed).padEnd(5) + '  âŒ ÙØ´Ù„: ' + String(results.failed).padEnd(5) + '  ğŸ“Š Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + String(results.total).padEnd(15) + 'â•‘');
  Logger.log('â•‘   ğŸ“ˆ Ù†Ø³Ø¨Ø© Ø§Ù„Ù†Ø¬Ø§Ø­: ' + passRate + '%'.padEnd(50) + 'â•‘');
  Logger.log('â•‘   â±ï¸ Ø§Ù„ÙˆÙ‚Øª: ' + duration + ' Ø«Ø§Ù†ÙŠØ©'.padEnd(55) + 'â•‘');
  Logger.log('â•‘                                                                       â•‘');
  
  if (results.failed === 0) {
    Logger.log('â•‘   ğŸ‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù†Ø¬Ø­Øª!                                          â•‘');
  } else {
    Logger.log('â•‘   âš ï¸ Ø¨Ø¹Ø¶ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ÙØ´Ù„Øª - Ø±Ø§Ø¬Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ø£Ø¹Ù„Ø§Ù‡                     â•‘');
  }
  
  Logger.log('â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  // ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙØ´Ù„
  if (results.errors.length > 0) {
    Logger.log('\nâŒ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡:');
    results.errors.forEach(function(err) {
      Logger.log('   â€¢ ' + err.name + ': ' + err.error);
    });
  }
  
  // Ø¥Ø±Ø³Ø§Ù„ ØªÙ‚Ø±ÙŠØ± Ù„Ù„ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…
  try {
    var chatId = ENV.CHAT_ID || ENV.CHANNEL_ID;
    if (chatId && ENV.TELEGRAM_TOKEN) {
      var msg = (results.failed === 0 ? 'âœ…' : 'âš ï¸') + ' <b>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø´Ø§Ù…Ù„</b>\n\n' +
                'âœ… Ù†Ø¬Ø­: ' + results.passed + '\n' +
                'âŒ ÙØ´Ù„: ' + results.failed + '\n' +
                'ğŸ“ˆ Ø§Ù„Ù†Ø³Ø¨Ø©: ' + passRate + '%\n' +
                'â±ï¸ Ø§Ù„ÙˆÙ‚Øª: ' + duration + ' Ø«Ø§Ù†ÙŠØ©';
      
      sendTelegramLogged_(chatId, msg, { parse_mode: 'HTML' });
    }
  } catch (e) {}
  
  return results;
}

/**
 * Ø¯Ø§Ù„Ø© Ø§Ø®ØªØ¨Ø§Ø± ÙØ±Ø¯ÙŠØ©
 */
function runTest_(results, name, fn, optional) {
  results.total++;
  
  try {
    var result = fn();
    
    if (result === null && optional) {
      Logger.log('   âŠ˜ ' + name + ' (ØªØ®Ø·ÙŠ)');
      results.total--;
      return;
    }
    
    if (result) {
      Logger.log('   âœ… ' + name);
      results.passed++;
    } else {
      Logger.log('   âŒ ' + name);
      results.failed++;
      results.errors.push({ name: name, error: 'ÙØ´Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' });
    }
  } catch (e) {
    Logger.log('   âŒ ' + name + ' - ' + e.message);
    results.failed++;
    results.errors.push({ name: name, error: e.message });
  }
}

/**
 * Ø¯Ø§Ù„Ø© Ø³Ø±ÙŠØ¹Ø© Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ù…Ø¹ÙŠÙ†Ø©
 */
function QUICK_TEST_MESSAGE() {
  var testSMS = 'Ø­ÙˆØ§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© ØµØ§Ø¯Ø±Ø©\nÙ…Ù†1626\nØ¨Ù€SAR 500\nÙ„Ù€3818;Ù…Ù‚Ø±Ù† Ø§Ù„Ù…Ø·ÙŠØ±ÙŠ\n26/1/20 17:16';
  
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ø³Ø±ÙŠØ¹ Ù„Ø±Ø³Ø§Ù„Ø©');
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  Logger.log('ğŸ“ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:\n' + testSMS);
  Logger.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  
  // 1. Parser
  Logger.log('\nğŸ“Š Ù†ØªÙŠØ¬Ø© Parser:');
  var parsed = SOV1_preParseFallback_(testSMS);
  Logger.log(JSON.stringify(parsed, null, 2));
  
  // 2. Flow
  Logger.log('\nğŸš€ ØªÙ†ÙÙŠØ° Flow:');
  try {
    var result = executeUniversalFlowV120(testSMS, 'QUICK_TEST', null);
    Logger.log('âœ… Ø§Ù„Ù†ØªÙŠØ¬Ø©: ' + JSON.stringify(result, null, 2));
  } catch (e) {
    Logger.log('âŒ Ø®Ø·Ø£: ' + e.message);
  }
  
  // 3. Ø¢Ø®Ø± ØµÙ ÙÙŠ Sheet1
  Logger.log('\nğŸ“‹ Ø¢Ø®Ø± ØµÙ ÙÙŠ Sheet1:');
  var s1 = _sheet('Sheet1');
  var lastRow = s1.getLastRow();
  if (lastRow >= 2) {
    var data = s1.getRange(lastRow, 1, 1, 13).getValues()[0];
    Logger.log('UUID: ' + data[0]);
    Logger.log('Date: ' + data[1]);
    Logger.log('Amount: ' + data[8]);
    Logger.log('Merchant: ' + data[9]);
    Logger.log('Category: ' + data[10]);
  }
}
