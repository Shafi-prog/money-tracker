<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุงูุฅุนุฏุงุฏุงุช - MoneyTracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50" x-data="settingsPage()" x-init="init()">
  
  <!-- Header -->
  <div class="bg-gray-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <h1 class="text-3xl font-bold">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h1>
      <p class="text-gray-300 mt-2">ุฅุฏุงุฑุฉ ุฅุนุฏุงุฏุงุช ุงููุธุงู ูุงูุชูุถููุงุช</p>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">

    <!-- Success Message (Professional Pattern from Firefly III) -->
    <div 
      x-show="notifications.success.show" 
      x-transition
      class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4 mb-6 shadow-md"
    >
      <div class="flex items-center gap-3">
        <div class="text-2xl">โ</div>
        <div>
          <h3 class="font-bold text-green-800">ุชู ุงูุญูุธ ุจูุฌุงุญ!</h3>
          <p class="text-green-700" x-text="notifications.success.text"></p>
        </div>
        <button @click="notifications.success.show = false" class="mr-auto text-green-600 hover:text-green-800">
          โ
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div 
      x-show="notifications.error.show" 
      x-transition
      class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6 shadow-md"
    >
      <div class="flex items-center gap-3">
        <div class="text-2xl">โ</div>
        <div>
          <h3 class="font-bold text-red-800">ุฎุทุฃ ูู ุงูุญูุธ</h3>
          <p class="text-red-700" x-text="notifications.error.text"></p>
        </div>
        <button @click="notifications.error.show = false" class="mr-auto text-red-600 hover:text-red-800">
          โ
        </button>
      </div>
    </div>

    <!-- Loading Overlay (Fixes "ุฌุงุฑู ูุชุญููู" stuck issue) -->
    <div 
      x-show="formStates.isSubmitting" 
      x-transition
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-8 shadow-2xl text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
        <p class="text-xl font-semibold text-gray-700">ุฌุงุฑู ุงูุญูุธ...</p>
        <p class="text-gray-500 mt-2">ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ</p>
      </div>
    </div>

    <!-- Settings Form -->
    <form @submit.prevent="saveSettings()">
      <div class="grid md:grid-cols-2 gap-6">
        
        <!-- User Profile Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span>๐ค</span>
            <span>ุงูููู ุงูุดุฎุตู</span>
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุงุณู</label>
              <input 
                type="text" 
                x-model="settings.user_name"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="ุฃุฏุฎู ุงุณูู"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
              <input 
                type="email" 
                x-model="settings.user_email"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="example@gmail.com"
                dir="ltr"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ</label>
              <select 
                x-model="settings.default_currency"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="USD">๐บ๐ธ USD - ุฏููุงุฑ ุฃูุฑููู</option>
                <option value="SAR">๐ธ๐ฆ SAR - ุฑูุงู ุณุนูุฏู</option>
                <option value="AED">๐ฆ๐ช AED - ุฏุฑูู ุฅูุงุฑุงุชู</option>
                <option value="EGP">๐ช๐ฌ EGP - ุฌููู ูุตุฑู</option>
                <option value="EUR">๐ช๐บ EUR - ููุฑู</option>
                <option value="GBP">๐ฌ๐ง GBP - ุฌููู ุฅุณุชุฑูููู</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงููุบุฉ</label>
              <select 
                x-model="settings.language"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="ar">๐ธ๐ฆ ุงูุนุฑุจูุฉ</option>
                <option value="en">๐บ๐ธ English</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Preferences Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span>๐ฏ</span>
            <span>ุงูุชูุถููุงุช</span>
          </h2>
          
          <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <h3 class="font-medium">ููู ุงูุฑุงุชุจ</h3>
                <p class="text-sm text-gray-600">ุงูููู ูู ุงูุดูุฑ</p>
              </div>
              <input 
                type="number" 
                x-model="settings.salary_day"
                min="1"
                max="31"
                class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
              >
            </div>

            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <h3 class="font-medium">ุงูุชูุจููุงุช</h3>
                <p class="text-sm text-gray-600">ุฅุดุนุงุฑุงุช ุงูููุฒุงููุฉ</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="settings.enable_notifications" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>

            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <h3 class="font-medium">ุชุทุจูู ุงูููุงุนุฏ ุชููุงุฆูุงู</h3>
                <p class="text-sm text-gray-600">ุชุตููู ุชููุงุฆู</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="settings.auto_apply_rules" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>
        </div>

      </div>

      <!-- Save Button (Professional Pattern) -->
      <div class="mt-6 flex gap-4">
        <button 
          type="submit"
          :disabled="formStates.isSubmitting"
          class="px-8 py-4 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          <span x-show="!formStates.isSubmitting">๐พ</span>
          <span x-show="formStates.isSubmitting" class="animate-spin">โณ</span>
          <span x-text="formStates.isSubmitting ? 'ุฌุงุฑู ุงูุญูุธ...' : 'ุญูุธ ุงูุฅุนุฏุงุฏุงุช'"></span>
        </button>
        <a 
          href="?page=index"
          class="px-8 py-4 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition"
        >
          โ ุงูุนูุฏุฉ ูููุญุฉ ุงูุชุญูู
        </a>
      </div>
    </form>

    <!-- Categories Management Section -->
    <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-2xl font-bold flex items-center gap-2">
          <span>๐ท๏ธ</span>
          <span>ุฅุฏุงุฑุฉ ุงูุชุตูููุงุช</span>
        </h2>
        <button 
          @click="showAddCategoryModal = true"
          class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center gap-2"
        >
          <span>โ</span>
          <span>ุฅุถุงูุฉ ุชุตููู</span>
        </button>
      </div>

      <!-- Categories Loading -->
      <div x-show="categoriesLoading" class="text-center py-8">
        <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mx-auto"></div>
        <p class="text-gray-500 mt-2">ุฌุงุฑู ุชุญููู ุงูุชุตูููุงุช...</p>
      </div>

      <!-- Categories Grid -->
      <div x-show="!categoriesLoading" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4">
        <template x-for="cat in categories" :key="cat.row">
          <div 
            class="p-4 border-2 rounded-lg transition"
            :class="cat.active ? 'border-gray-200 bg-white' : 'border-red-200 bg-red-50 opacity-60'"
          >
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <span class="text-2xl" x-text="cat.icon || '๐ฆ'"></span>
                <div>
                  <h3 class="font-bold" x-text="cat.name"></h3>
                  <p class="text-sm text-gray-500" x-text="cat.notes || ''"></p>
                </div>
              </div>
              <div class="flex gap-2">
                <button 
                  @click="editCategory(cat)"
                  class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg"
                  title="ุชุนุฏูู"
                >
                  โ๏ธ
                </button>
                <button 
                  @click="deleteCategory(cat)"
                  class="p-2 text-red-600 hover:bg-red-100 rounded-lg"
                  title="ุญุฐู"
                  x-show="!['ุฃุฎุฑู', 'ุฑุงุชุจ', 'ุชุญููู', 'ุชุญูู', 'ูุฑููุถุฉ'].includes(cat.name)"
                >
                  ๐๏ธ
                </button>
              </div>
            </div>
            <div class="mt-2 flex items-center gap-2">
              <div 
                class="w-4 h-4 rounded-full"
                :style="'background-color: ' + (cat.color || '#6B7280')"
              ></div>
              <span class="text-xs" :class="cat.active ? 'text-green-600' : 'text-red-600'" x-text="cat.active ? 'ูุดุท' : 'ูุนุทู'"></span>
            </div>
          </div>
        </template>
      </div>

      <!-- Empty State -->
      <div x-show="!categoriesLoading && categories.length === 0" class="text-center py-8 text-gray-500">
        <span class="text-4xl block mb-2">๐ญ</span>
        <p>ูุง ุชูุฌุฏ ุชุตูููุงุช. ุฃุถู ุชุตูููุงู ุฌุฏูุฏุงู.</p>
      </div>

      <!-- Clean Test Categories Button -->
      <div class="mt-6 pt-4 border-t border-gray-200">
        <button 
          @click="cleanTestCategories()"
          :disabled="formStates.isCleaning"
          class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition disabled:opacity-50"
        >
          <span x-show="!formStates.isCleaning">๐งน ุชูุธูู ุงูุชุตูููุงุช ุงูุชุฌุฑูุจูุฉ</span>
          <span x-show="formStates.isCleaning">โณ ุฌุงุฑู ุงูุชูุธูู...</span>
        </button>
        <p class="text-sm text-gray-500 mt-2">ุฅุฒุงูุฉ ุงูุชุตูููุงุช ุงูุชู ุชุญุชูู ุนูู ูููุงุช ูุซู: test, ุชุฌุฑูุจ, fake</p>
      </div>
    </div>

    <!-- Add/Edit Category Modal -->
    <div 
      x-show="showAddCategoryModal || showEditCategoryModal" 
      x-transition
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
      @click.self="closeModals()"
    >
      <div class="bg-white rounded-xl p-6 w-full max-w-md shadow-2xl">
        <h3 class="text-xl font-bold mb-4" x-text="showEditCategoryModal ? 'ุชุนุฏูู ุงูุชุตููู' : 'ุฅุถุงูุฉ ุชุตููู ุฌุฏูุฏ'"></h3>
        
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ุงุณู ุงูุชุตููู *</label>
            <input 
              type="text" 
              x-model="categoryForm.name"
              class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              placeholder="ูุซุงู: ุทุนุงูุ ูููุ ุชุณูู"
              maxlength="50"
            >
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุฃููููุฉ</label>
            <div class="flex gap-2 flex-wrap">
              <template x-for="icon in availableIcons" :key="icon">
                <button 
                  type="button"
                  @click="categoryForm.icon = icon"
                  class="w-10 h-10 text-xl rounded-lg border-2 transition"
                  :class="categoryForm.icon === icon ? 'border-blue-500 bg-blue-50' : 'border-gray-200 hover:border-gray-400'"
                  x-text="icon"
                ></button>
              </template>
            </div>
          </div>
          
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">ุงูููู</label>
            <div class="flex gap-2 flex-wrap">
              <template x-for="color in availableColors" :key="color">
                <button 
                  type="button"
                  @click="categoryForm.color = color"
                  class="w-8 h-8 rounded-full border-2 transition"
                  :class="categoryForm.color === color ? 'border-gray-800 ring-2 ring-offset-2 ring-gray-400' : 'border-transparent'"
                  :style="'background-color: ' + color"
                ></button>
              </template>
            </div>
          </div>

          <div class="flex items-center gap-3" x-show="showEditCategoryModal">
            <input type="checkbox" x-model="categoryForm.active" id="catActive" class="w-4 h-4">
            <label for="catActive" class="text-sm text-gray-700">ุชุตููู ูุดุท</label>
          </div>
        </div>
        
        <div class="flex gap-3 mt-6">
          <button 
            @click="saveCategory()"
            :disabled="!categoryForm.name || formStates.isSavingCategory"
            class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span x-show="!formStates.isSavingCategory" x-text="showEditCategoryModal ? 'ุญูุธ ุงูุชุนุฏููุงุช' : 'ุฅุถุงูุฉ ุงูุชุตููู'"></span>
            <span x-show="formStates.isSavingCategory">โณ ุฌุงุฑู ุงูุญูุธ...</span>
          </button>
          <button 
            @click="closeModals()"
            class="px-4 py-3 bg-gray-300 text-gray-700 rounded-lg font-bold hover:bg-gray-400"
          >
            ุฅูุบุงุก
          </button>
        </div>
      </div>
    </div>

    <!-- Quick Links -->
    <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4">๐ ุฑูุงุจุท ุณุฑูุนุฉ</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <a href="?page=index" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
          <span class="text-2xl block mb-2">๐</span>
          <span class="font-medium">ููุญุฉ ุงูุชุญูู</span>
        </a>
        <a href="?page=features" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
          <span class="text-2xl block mb-2">โจ</span>
          <span class="font-medium">ุงูููุฒุงุช</span>
        </a>
        <a href="?page=test" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
          <span class="text-2xl block mb-2">๐งช</span>
          <span class="font-medium">ุงุฎุชุจุงุฑุงุช</span>
        </a>
      </div>
    </div>

    <!-- Danger Zone - Data Reset -->
    <div class="mt-8 bg-red-50 border-2 border-red-200 rounded-xl shadow-lg p-6">
      <div class="flex items-center gap-3 mb-6">
        <span class="text-3xl">โ๏ธ</span>
        <div>
          <h2 class="text-2xl font-bold text-red-800">ููุทูุฉ ุงูุฎุทุฑ</h2>
          <p class="text-red-600">ูุฐู ุงูุนูููุงุช ูุง ูููู ุงูุชุฑุงุฌุน ุนููุง!</p>
        </div>
      </div>

      <!-- Data Stats -->
      <div x-show="resetStats" class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6">
        <template x-for="opt in resetOptions" :key="opt.id">
          <div 
            class="p-3 rounded-lg text-center cursor-pointer border-2 transition"
            :class="selectedResets.includes(opt.id) ? 'border-red-500 bg-red-100' : 'border-gray-200 bg-white hover:border-red-300'"
            @click="toggleResetOption(opt.id)"
            x-show="opt.id !== 'all'"
          >
            <span class="text-2xl block" x-text="opt.icon"></span>
            <span class="font-medium block" x-text="opt.label"></span>
            <span class="text-sm text-gray-500" x-text="opt.count + ' ุณุฌู'"></span>
          </div>
        </template>
      </div>

      <!-- Reset Confirmation -->
      <div x-show="selectedResets.length > 0" class="bg-white rounded-lg p-4 border-2 border-red-300">
        <p class="text-red-700 font-bold mb-3">
          โ๏ธ ุฃูุช ุนูู ูุดู ุญุฐู: 
          <span x-text="selectedResets.map(id => resetOptions.find(o => o.id === id)?.label).join('ุ ')"></span>
        </p>
        
        <div class="mb-4">
          <label class="block text-sm font-medium text-gray-700 mb-2">
            ููุชุฃููุฏุ ุงูุชุจ <code class="bg-gray-100 px-2 py-1 rounded">CONFIRM_RESET</code>
          </label>
          <input 
            type="text" 
            x-model="resetConfirmation"
            class="w-full px-4 py-3 border-2 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500"
            :class="resetConfirmation === 'CONFIRM_RESET' ? 'border-green-500' : 'border-gray-300'"
            placeholder="ุงูุชุจ CONFIRM_RESET ููุชุฃููุฏ"
            dir="ltr"
          >
        </div>

        <div class="flex gap-3">
          <button 
            @click="executeReset()"
            :disabled="resetConfirmation !== 'CONFIRM_RESET' || formStates.isResetting"
            class="px-6 py-3 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
          >
            <span x-show="!formStates.isResetting">๐๏ธ ุชูููุฐ ุงูุญุฐู</span>
            <span x-show="formStates.isResetting" class="animate-pulse">โณ ุฌุงุฑู ุงูุญุฐู...</span>
          </button>
          <button 
            @click="cancelReset()"
            class="px-6 py-3 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition"
          >
            ุฅูุบุงุก
          </button>
        </div>
      </div>

      <!-- Reset All Button -->
      <div class="mt-4 pt-4 border-t border-red-200">
        <button 
          @click="selectAllForReset()"
          class="px-4 py-2 bg-red-800 text-white rounded-lg hover:bg-red-900 transition"
        >
          โ๏ธ ุชุญุฏูุฏ ุงููู ููุญุฐู
        </button>
        <p class="text-sm text-red-600 mt-2">ุณูุญุฐู ุฌููุน ุงููุนุงููุงุช ูุงูุญุณุงุจุงุช ูุงูุชุญูููุงุช ูุฅุนุงุฏุฉ ุถุจุท ุงูููุฒุงููุงุช</p>
      </div>
    </div>

  </div>

  <script>
    function settingsPage() {
      return {
        settings: {
          user_name: '',
          default_currency: 'USD',
          language: 'ar',
          salary_day: 1,
          enable_notifications: true,
          auto_apply_rules: true
        },

        // Categories management
        categories: [],
        categoriesLoading: false,
        showAddCategoryModal: false,
        showEditCategoryModal: false,
        categoryForm: {
          row: null,
          name: '',
          icon: '๐ฆ',
          color: '#6B7280',
          active: true
        },
        availableIcons: ['๐ฝ๏ธ', '๐', '๐', '๐๏ธ', '๐', '๐ฌ', '๐', '๐', '๐ฐ', 'โ๏ธ', '๐ฆ', '๐ณ', '๐ฎ', 'โ๏ธ', '๐ช', '๐', 'โ', '๐', '๐ฅ', '๐ฑ'],
        availableColors: ['#EF4444', '#F59E0B', '#10B981', '#3B82F6', '#8B5CF6', '#EC4899', '#06B6D4', '#6366F1', '#22C55E', '#64748B', '#6B7280', '#1F2937'],

        // Data reset management
        resetStats: null,
        resetOptions: [],
        selectedResets: [],
        resetConfirmation: '',

        notifications: {
          success: { show: false, text: '' },
          error: { show: false, text: '' }
        },

        formStates: {
          isSubmitting: false,
          isLoading: false,
          isSavingCategory: false,
          isCleaning: false,
          isResetting: false
        },

        init() {
          setTimeout(() => {
            this.loadSettings();
            this.loadCategories();
            this.loadResetOptions();
          }, 100);
        },

        loadSettings() {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.log('Running in standalone mode - using defaults');
            return;
          }
          
          this.formStates.isLoading = true;
          
          google.script.run
            .withSuccessHandler((result) => {
              this.formStates.isLoading = false;
              if (result && result.settings) {
                this.settings = { ...this.settings, ...result.settings };
              }
            })
            .withFailureHandler((error) => {
              this.formStates.isLoading = false;
              console.error('Load error:', error);
            })
            .getSettings();
        },

        loadResetOptions() {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            // Demo data for standalone mode
            this.resetStats = { transactions: 150, budgets: 12, accounts: 5, transfers: 8, categories: 20 };
            this.resetOptions = [
              { id: 'transactions', label: 'ุงููุนุงููุงุช', icon: '๐ณ', count: 150 },
              { id: 'budgets', label: 'ุงูููุฒุงููุงุช', icon: '๐', count: 12 },
              { id: 'accounts', label: 'ุงูุญุณุงุจุงุช', icon: '๐ฆ', count: 5 },
              { id: 'transfers', label: 'ุงูุชุญูููุงุช', icon: 'โ๏ธ', count: 8 },
              { id: 'categories', label: 'ุงูุชุตูููุงุช', icon: '๐ท๏ธ', count: 20 }
            ];
            return;
          }
          
          google.script.run
            .withSuccessHandler((result) => {
              if (result && result.success) {
                this.resetStats = result.stats;
                this.resetOptions = result.options;
              }
            })
            .withFailureHandler((error) => {
              console.error('Load reset options error:', error);
            })
            .SOV1_UI_getResetOptions_();
        },

        toggleResetOption(id) {
          if (this.selectedResets.includes(id)) {
            this.selectedResets = this.selectedResets.filter(r => r !== id);
          } else {
            this.selectedResets.push(id);
          }
        },

        selectAllForReset() {
          this.selectedResets = ['transactions', 'budgets', 'accounts', 'transfers'];
        },

        cancelReset() {
          this.selectedResets = [];
          this.resetConfirmation = '';
        },

        executeReset() {
          if (this.resetConfirmation !== 'CONFIRM_RESET') {
            alert('ูุฌุจ ูุชุงุจุฉ CONFIRM_RESET ููุชุฃููุฏ');
            return;
          }
          
          if (this.selectedResets.length === 0) {
            alert('ูู ูุชู ุชุญุฏูุฏ ุฃู ุจูุงูุงุช ููุญุฐู');
            return;
          }
          
          if (!confirm('โ๏ธ ุชุฃููุฏ ููุงุฆู: ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุจูุงูุงุช ุงููุญุฏุฏุฉุ\\n\\nูุฐุง ุงูุฅุฌุฑุงุก ูุง ูููู ุงูุชุฑุงุฌุน ุนูู!')) {
            return;
          }
          
          this.formStates.isResetting = true;
          
          google.script.run
            .withSuccessHandler((result) => {
              this.formStates.isResetting = false;
              
              if (result && result.success) {
                let msg = 'ุชู ุงูุญุฐู ุจูุฌุงุญ:\\n';
                for (let key in result.deleted) {
                  msg += 'โข ' + key + ': ' + result.deleted[key] + ' ุณุฌู\\n';
                }
                this.notifications.success.show = true;
                this.notifications.success.text = msg;
                setTimeout(() => { this.notifications.success.show = false; }, 5000);
                
                // Reset form and reload stats
                this.cancelReset();
                this.loadResetOptions();
              } else {
                this.notifications.error.show = true;
                this.notifications.error.text = result.error || 'ูุดู ุงูุญุฐู';
              }
            })
            .withFailureHandler((error) => {
              this.formStates.isResetting = false;
              this.notifications.error.show = true;
              this.notifications.error.text = 'ุฎุทุฃ: ' + error.message;
            })
            .SOV1_UI_resetData_('OPEN', this.selectedResets, this.resetConfirmation);
        },

        loadCategories() {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            return;
          }
          
          this.categoriesLoading = true;
          
          google.script.run
            .withSuccessHandler((cats) => {
              this.categoriesLoading = false;
              if (cats && Array.isArray(cats)) {
                this.categories = cats;
              }
            })
            .withFailureHandler((error) => {
              this.categoriesLoading = false;
              console.error('Categories load error:', error);
            })
            .SOV1_UI_getCategoriesManage_('OPEN');
        },

        saveSettings() {
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            this.notifications.error.show = true;
            this.notifications.error.text = 'ุงูุฑุฌุงุก ูุชุญ ุงูุตูุญุฉ ูู ุฎูุงู ุฑุงุจุท ุงููุดุฑ';
            return;
          }
          
          this.formStates.isSubmitting = true;
          this.notifications.success.show = false;
          this.notifications.error.show = false;

          google.script.run
            .withSuccessHandler((result) => {
              this.formStates.isSubmitting = false;
              
              if (result && result.success) {
                this.notifications.success.show = true;
                this.notifications.success.text = result.message || 'ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!';
                setTimeout(() => { this.notifications.success.show = false; }, 3000);
              } else {
                this.notifications.error.show = true;
                this.notifications.error.text = result.error || 'ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช';
              }
            })
            .withFailureHandler((error) => {
              this.formStates.isSubmitting = false;
              this.notifications.error.show = true;
              this.notifications.error.text = 'ุฎุทุฃ: ' + error.message;
            })
            .saveSettings(this.settings);
        },

        // Category Management Functions
        editCategory(cat) {
          this.categoryForm = {
            row: cat.row,
            name: cat.name,
            icon: cat.icon || '๐ฆ',
            color: cat.color || '#6B7280',
            active: cat.active !== false
          };
          this.showEditCategoryModal = true;
        },

        deleteCategory(cat) {
          if (!confirm('ูู ุชุฑูุฏ ุญุฐู ุงูุชุตููู "' + cat.name + '"ุ\nุณูุชู ุชุนุทููู ูููุณ ุญุฐูู ููุงุฆูุงู.')) {
            return;
          }
          
          google.script.run
            .withSuccessHandler((result) => {
              if (result && result.ok) {
                this.notifications.success.show = true;
                this.notifications.success.text = 'ุชู ุญุฐู ุงูุชุตููู';
                setTimeout(() => { this.notifications.success.show = false; }, 3000);
                this.loadCategories();
              }
            })
            .withFailureHandler((error) => {
              this.notifications.error.show = true;
              this.notifications.error.text = 'ุฎุทุฃ: ' + error.message;
            })
            .SOV1_UI_deleteCategory_('OPEN', cat.row);
        },

        saveCategory() {
          if (!this.categoryForm.name.trim()) {
            alert('ุงุณู ุงูุชุตููู ูุทููุจ');
            return;
          }
          
          this.formStates.isSavingCategory = true;
          
          if (this.showEditCategoryModal && this.categoryForm.row) {
            // Update existing
            google.script.run
              .withSuccessHandler((result) => {
                this.formStates.isSavingCategory = false;
                if (result && result.ok) {
                  this.closeModals();
                  this.notifications.success.show = true;
                  this.notifications.success.text = 'ุชู ุชุญุฏูุซ ุงูุชุตููู';
                  setTimeout(() => { this.notifications.success.show = false; }, 3000);
                  this.loadCategories();
                }
              })
              .withFailureHandler((error) => {
                this.formStates.isSavingCategory = false;
                alert('ุฎุทุฃ: ' + error.message);
              })
              .SOV1_UI_updateCategory_('OPEN', this.categoryForm.row, this.categoryForm.name, this.categoryForm.icon, this.categoryForm.color, this.categoryForm.active);
          } else {
            // Add new
            google.script.run
              .withSuccessHandler((result) => {
                this.formStates.isSavingCategory = false;
                if (result && result.ok) {
                  this.closeModals();
                  this.notifications.success.show = true;
                  this.notifications.success.text = 'ุชู ุฅุถุงูุฉ ุงูุชุตููู "' + result.name + '"';
                  setTimeout(() => { this.notifications.success.show = false; }, 3000);
                  this.loadCategories();
                }
              })
              .withFailureHandler((error) => {
                this.formStates.isSavingCategory = false;
                alert('ุฎุทุฃ: ' + error.message);
              })
              .SOV1_UI_addCategory_('OPEN', this.categoryForm.name, this.categoryForm.icon, this.categoryForm.color);
          }
        },

        cleanTestCategories() {
          if (!confirm('ูู ุชุฑูุฏ ุชูุธูู ุงูุชุตูููุงุช ุงูุชุฌุฑูุจูุฉุ\nุณูุชู ุฅุฒุงูุฉ ุงูุชุตูููุงุช ุงูุชู ุชุญุชูู ุนูู: test, ุชุฌุฑูุจ, fake, dummy')) {
            return;
          }
          
          this.formStates.isCleaning = true;
          
          google.script.run
            .withSuccessHandler((result) => {
              this.formStates.isCleaning = false;
              this.notifications.success.show = true;
              this.notifications.success.text = 'ุชู ุงูุชูุธูู: ' + (result.categories || 0) + ' ุชุตูููุ ' + (result.transactions || 0) + ' ุนูููุฉุ ' + (result.budgets || 0) + ' ููุฒุงููุฉ';
              setTimeout(() => { this.notifications.success.show = false; }, 5000);
              this.loadCategories();
            })
            .withFailureHandler((error) => {
              this.formStates.isCleaning = false;
              this.notifications.error.show = true;
              this.notifications.error.text = 'ุฎุทุฃ ูู ุงูุชูุธูู: ' + error.message;
            })
            .SOV1_CLEAN_TEST_CATEGORIES_();
        },

        closeModals() {
          this.showAddCategoryModal = false;
          this.showEditCategoryModal = false;
          this.categoryForm = { row: null, name: '', icon: '๐ฆ', color: '#6B7280', active: true };
        }
      };
    }
  </script>

</body>
</html>
