<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ุงูุฅุนุฏุงุฏุงุช - MoneyTracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-50" x-data="settingsPage()" x-init="init()">
  
  <!-- Header -->
  <div class="bg-gray-800 text-white shadow-lg">
    <div class="container mx-auto px-4 py-6">
      <h1 class="text-3xl font-bold">โ๏ธ ุงูุฅุนุฏุงุฏุงุช</h1>
      <p class="text-gray-300 mt-2">ุฅุฏุงุฑุฉ ุฅุนุฏุงุฏุงุช ุงููุธุงู ูุงูุชูุถููุงุช</p>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">

    <!-- Success Message (Professional Pattern from Firefly III) -->
    <div 
      x-show="notifications.success.show" 
      x-transition
      class="bg-green-50 border-l-4 border-green-500 rounded-lg p-4 mb-6 shadow-md"
    >
      <div class="flex items-center gap-3">
        <div class="text-2xl">โ</div>
        <div>
          <h3 class="font-bold text-green-800">ุชู ุงูุญูุธ ุจูุฌุงุญ!</h3>
          <p class="text-green-700" x-text="notifications.success.text"></p>
        </div>
        <button @click="notifications.success.show = false" class="mr-auto text-green-600 hover:text-green-800">
          โ
        </button>
      </div>
    </div>

    <!-- Error Message -->
    <div 
      x-show="notifications.error.show" 
      x-transition
      class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6 shadow-md"
    >
      <div class="flex items-center gap-3">
        <div class="text-2xl">โ</div>
        <div>
          <h3 class="font-bold text-red-800">ุฎุทุฃ ูู ุงูุญูุธ</h3>
          <p class="text-red-700" x-text="notifications.error.text"></p>
        </div>
        <button @click="notifications.error.show = false" class="mr-auto text-red-600 hover:text-red-800">
          โ
        </button>
      </div>
    </div>

    <!-- Loading Overlay (Fixes "ุฌุงุฑู ูุชุญููู" stuck issue) -->
    <div 
      x-show="formStates.isSubmitting" 
      x-transition
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
    >
      <div class="bg-white rounded-xl p-8 shadow-2xl text-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-4 border-blue-600 mx-auto mb-4"></div>
        <p class="text-xl font-semibold text-gray-700">ุฌุงุฑู ุงูุญูุธ...</p>
        <p class="text-gray-500 mt-2">ุงูุฑุฌุงุก ุงูุงูุชุธุงุฑ</p>
      </div>
    </div>

    <!-- Settings Form -->
    <form @submit.prevent="saveSettings()">
      <div class="grid md:grid-cols-2 gap-6">
        
        <!-- User Profile Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span>๐ค</span>
            <span>ุงูููู ุงูุดุฎุตู</span>
          </h2>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุงุณู</label>
              <input 
                type="text" 
                x-model="settings.user_name"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="ุฃุฏุฎู ุงุณูู"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุจุฑูุฏ ุงูุฅููุชุฑููู</label>
              <input 
                type="email" 
                x-model="settings.user_email"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="example@gmail.com"
                dir="ltr"
              >
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงูุนููุฉ ุงูุงูุชุฑุงุถูุฉ</label>
              <select 
                x-model="settings.default_currency"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="USD">๐บ๐ธ USD - ุฏููุงุฑ ุฃูุฑููู</option>
                <option value="SAR">๐ธ๐ฆ SAR - ุฑูุงู ุณุนูุฏู</option>
                <option value="AED">๐ฆ๐ช AED - ุฏุฑูู ุฅูุงุฑุงุชู</option>
                <option value="EGP">๐ช๐ฌ EGP - ุฌููู ูุตุฑู</option>
                <option value="EUR">๐ช๐บ EUR - ููุฑู</option>
                <option value="GBP">๐ฌ๐ง GBP - ุฌููู ุฅุณุชุฑูููู</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">ุงููุบุฉ</label>
              <select 
                x-model="settings.language"
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
              >
                <option value="ar">๐ธ๐ฆ ุงูุนุฑุจูุฉ</option>
                <option value="en">๐บ๐ธ English</option>
              </select>
            </div>
          </div>
        </div>

        <!-- Preferences Card -->
        <div class="bg-white rounded-xl shadow-lg p-6">
          <h2 class="text-2xl font-bold mb-6 flex items-center gap-2">
            <span>๐ฏ</span>
            <span>ุงูุชูุถููุงุช</span>
          </h2>
          
          <div class="space-y-4">
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <h3 class="font-medium">ููู ุงูุฑุงุชุจ</h3>
                <p class="text-sm text-gray-600">ุงูููู ูู ุงูุดูุฑ</p>
              </div>
              <input 
                type="number" 
                x-model="settings.salary_day"
                min="1"
                max="31"
                class="w-20 px-3 py-2 border border-gray-300 rounded-lg text-center"
              >
            </div>

            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <h3 class="font-medium">ุงูุชูุจููุงุช</h3>
                <p class="text-sm text-gray-600">ุฅุดุนุงุฑุงุช ุงูููุฒุงููุฉ</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="settings.enable_notifications" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>

            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div>
                <h3 class="font-medium">ุชุทุจูู ุงูููุงุนุฏ ุชููุงุฆูุงู</h3>
                <p class="text-sm text-gray-600">ุชุตููู ุชููุงุฆู</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="settings.auto_apply_rules" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
              </label>
            </div>
          </div>
        </div>

      </div>

      <!-- Save Button (Professional Pattern) -->
      <div class="mt-6 flex gap-4">
        <button 
          type="submit"
          :disabled="formStates.isSubmitting"
          class="px-8 py-4 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition shadow-lg disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          <span x-show="!formStates.isSubmitting">๐พ</span>
          <span x-show="formStates.isSubmitting" class="animate-spin">โณ</span>
          <span x-text="formStates.isSubmitting ? 'ุฌุงุฑู ุงูุญูุธ...' : 'ุญูุธ ุงูุฅุนุฏุงุฏุงุช'"></span>
        </button>
        <a 
          href="?page=index"
          class="px-8 py-4 bg-gray-500 text-white rounded-lg font-bold hover:bg-gray-600 transition"
        >
          โ ุงูุนูุฏุฉ ูููุญุฉ ุงูุชุญูู
        </a>
      </div>
    </form>

    <!-- Quick Links -->
    <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
      <h2 class="text-xl font-bold mb-4">๐ ุฑูุงุจุท ุณุฑูุนุฉ</h2>
      <div class="grid md:grid-cols-3 gap-4">
        <a href="?page=index" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
          <span class="text-2xl block mb-2">๐</span>
          <span class="font-medium">ููุญุฉ ุงูุชุญูู</span>
        </a>
        <a href="?page=features" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
          <span class="text-2xl block mb-2">โจ</span>
          <span class="font-medium">ุงูููุฒุงุช</span>
        </a>
        <a href="?page=test" class="block p-4 border-2 border-gray-200 rounded-lg hover:border-blue-500 hover:bg-blue-50 transition">
          <span class="text-2xl block mb-2">๐งช</span>
          <span class="font-medium">ุงุฎุชุจุงุฑุงุช</span>
        </a>
      </div>
    </div>

  </div>

  <script>
    function settingsPage() {
      return {
        settings: {
          user_name: '',
          default_currency: 'USD',
          language: 'ar',
          salary_day: 1,
          enable_notifications: true,
          auto_apply_rules: true
        },

        notifications: {
          success: { show: false, text: '' },
          error: { show: false, text: '' }
        },

        // Professional pattern: separate loading state
        formStates: {
          isSubmitting: false,
          isLoading: false
        },

        init() {
          // CRITICAL FIX: Load async, don't block initialization
          setTimeout(() => {
            this.loadSettings();
          }, 100);
        },

        loadSettings() {
          // Don't call if google.script.run doesn't exist (testing)
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            console.log('Running in standalone mode - using defaults');
            return;
          }
          
          this.formStates.isLoading = true;
          
          google.script.run
            .withSuccessHandler((result) => {
              this.formStates.isLoading = false;
              if (result && result.settings) {
                this.settings = { ...this.settings, ...result.settings };
              }
            })
            .withFailureHandler((error) => {
              this.formStates.isLoading = false;
              console.error('Load error:', error);
              // Don't show error to user - just use defaults
            })
            .getSettings();
        },

        saveSettings() {
          // CRITICAL FIX: Check if google.script.run exists
          if (typeof google === 'undefined' || !google.script || !google.script.run) {
            this.notifications.error.show = true;
            this.notifications.error.text = 'ุงูุฑุฌุงุก ูุชุญ ุงูุตูุญุฉ ูู ุฎูุงู ุฑุงุจุท ุงููุดุฑ';
            return;
          }
          
          // CRITICAL FIX: Proper loading state management (Firefly III pattern)
          this.formStates.isSubmitting = true;
          this.notifications.success.show = false;
          this.notifications.error.show = false;

          google.script.run
            .withSuccessHandler((result) => {
              // ALWAYS clear loading state first
              this.formStates.isSubmitting = false;
              
              if (result && result.success) {
                // Show success message
                this.notifications.success.show = true;
                this.notifications.success.text = result.message || 'ุชู ุญูุธ ุงูุฅุนุฏุงุฏุงุช ุจูุฌุงุญ!';
                
                // Auto-hide after 3 seconds
                setTimeout(() => {
                  this.notifications.success.show = false;
                }, 3000);
              } else {
                // Show error
                this.notifications.error.show = true;
                this.notifications.error.text = result.error || 'ูุดู ุญูุธ ุงูุฅุนุฏุงุฏุงุช';
              }
            })
            .withFailureHandler((error) => {
              // ALWAYS clear loading state on error
              this.formStates.isSubmitting = false;
              this.notifications.error.show = true;
              this.notifications.error.text = 'ุฎุทุฃ: ' + error.message;
            })
            .saveSettings(this.settings);
        }
      };
    }
  </script>

</body>
</html>
