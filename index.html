<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>SJA Money Tracker v2.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background-color: #f3f4f6; }
    .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
    [x-cloak] { display: none !important; }
  </style>
  <script>
    function appData() {
      return {
        page: 'dashboard',
        mobileMenu: false,
        loading: false,
        loadingStates: { settings: false, transactions: false, budgets: false, accounts: false, parsing: false },
        setupMode: false,
        setupStep: 1,
        configStatus: { hasSheet: false, hasTelegram: false, hasAI: false },
        setupData: { botToken: '', chatId: '', sheetId: '' },
        stats: { income: 0, expense: 0, balance: 0, savings: 0, incomeDeltaText: '' },
        transactions: [],
        allTransactions: [],
        filteredTransactions: [],
        searchQuery: '',
        budgets: [],
        errorMessage: '',
        showAddModal: false,
        showEditTransactionModal: false,
        editingTransaction: null,
        newTransaction: { amount: '', merchant: '', category: 'أخرى', type: 'expense', account: 'نقدي', notes: '' },
        // AI Parsing State
        pasting: false,
        rawPasteInput: '',
        loadingStates: { parsing: false },
        categories: [], // Loaded dynamically from backend
        categoryOptions: [],
        categoriesLoaded: false,
        userSettings: { user_name: '', user_email: '', enable_notifications: true, telegram_notifications: true, budget_alerts: true, default_currency: 'SAR', language: 'ar', salary_day: 1, auto_apply_rules: true },
        reportPeriod: 'monthly',
        reportData: null,
        accounts: [],
        showAccountModal: false,
        showAIExtraction: false,
        editingAccount: null,
        newAccount: { name: '', type: 'بنك', number: '', bank: '', balance: 0, aliases: '', isMine: true, isInternal: false, notes: '', smsText: '' },
        // Bulk import states
        showBulkImportModal: false,
        bulkSmsText: '',
        bulkParseResults: [],
        bulkParsing: false,
        showBudgetModal: false,
        editingBudget: null,
        newBudget: { category: '', limit: '' },
        showCategoryModal: false,
        editingCategory: null,
        newCategory: { name: '', icon: '📦', color: '#6B7280', type: 'expense', description: '' },
        showPrivacyModal: false,
        toasts: [],
        // Test panel states
        testingStates: { sms: false, ai: false, telegram: false, fullFlow: false },
        testResults: { sms: '', ai: '', telegram: '', fullFlow: '' },
        
        navigateToPage(pageName) {
          this.page = pageName;
          // Auto-load data when navigating to certain pages
          if (pageName === 'reports' && !this.reportData) {
            this.loadReport('monthly');
          }
        },
        
        init() {
          console.log('🚀 SJA Money Tracker v2.1 - Fast Loading');
          console.log('✅ Using optimized fast API with caching');
          this.loading = true;
          this.loadTime = Date.now();
          
          // ✅ Safety timeout - stop loading after 10 seconds no matter what
          var self = this;
          setTimeout(function() {
            if (self.loading) {
              console.warn('⚠️ Loading timeout - forcing complete');
              self.loading = false;
              if (!self.transactions || self.transactions.length === 0) {
                self.errorMessage = 'تعذر تحميل البيانات. تحقق من الاتصال.';
              }
            }
          }, 10000);
          
          // Try fast API first, fallback to regular
          this.tryFastLoad();
        },
        
        // NEW: Fast loading with fallback
        tryFastLoad() {
          if (typeof google === 'undefined' || !google.script) {
            console.error('Google Apps Script API not available');
            this.loading = false;
            this.errorMessage = 'لا يمكن الاتصال بالخادم';
            return;
          }
          
          console.log('⚡ Trying fast API...');
          google.script.run
            .withSuccessHandler(result => {
              if (result && result.success && result.data) {
                console.log('⚡ Fast load succeeded in ' + (Date.now() - this.loadTime) + 'ms');
                this.processFastData(result.data);
              } else {
                console.log('⚠️ Fast API returned no data, falling back...');
                this.loadSettings();
              }
            })
            .withFailureHandler(err => {
              console.log('⚠️ Fast API failed, falling back to regular: ' + err);
              this.loadSettings();
            })
            .SOV1_FAST_getDashboard();
        },
        
        // Load categories from backend
        loadCategories() {
          if (this.categoriesLoaded) return;
          
          if (typeof google === 'undefined' || !google.script) {
            // Fallback to defaults
            this.categories = ['طعام', 'نقل', 'فواتير', 'تسوق', 'سكن', 'ترفيه', 'صحة', 'راتب', 'تحويل', 'أخرى'];
            return;
          }
          
          google.script.run
            .withSuccessHandler(cats => {
              if (cats && Array.isArray(cats) && cats.length > 0) {
                // Categories can be objects with name/icon or plain strings
                this.categories = cats.map(c => typeof c === 'object' ? c.name : c);
                this.categoriesLoaded = true;
                console.log('✅ Categories loaded:', this.categories.length);
              } else {
                // Fallback defaults
                this.categories = ['طعام', 'نقل', 'فواتير', 'تسوق', 'سكن', 'ترفيه', 'صحة', 'راتب', 'تحويل', 'أخرى'];
              }
            })
            .withFailureHandler(err => {
              console.warn('⚠️ Failed to load categories:', err);
              this.categories = ['طعام', 'نقل', 'فواتير', 'تسوق', 'سكن', 'ترفيه', 'صحة', 'راتب', 'تحويل', 'أخرى'];
            })
            .SOV1_UI_getCategories('OPEN');
        },
        
        // NEW: Process fast API data
        processFastData(data) {
          try {
            if (data.kpi) {
              this.incomeMonth = data.kpi.incomeM || 0;
              this.spendMonth = data.kpi.spendM || 0;
              this.netMonth = data.kpi.netM || 0;
            }
            if (data.recentTransactions) {
              this.transactions = data.recentTransactions;
            }
            if (data.budgets) {
              this.budgets = data.budgets;
            }
            if (data.accounts) {
              this.accounts = data.accounts;
            }
            // Also load categories
            this.loadCategories();
            this.loading = false;
            console.log('✅ Data loaded in ' + (Date.now() - this.loadTime) + 'ms');
          } catch (e) {
            console.error('Error processing fast data:', e);
            this.loadSettings();
          }
        },
        
        loadSettings() {
          // Load categories in parallel
          this.loadCategories();
          
          google.script.run
            .withSuccessHandler(result => {
              if (result && result.settings) {
                this.userSettings = result.settings;
                console.log('Settings loaded:', result.settings);
              }
              // After settings load, refresh data
              this.refreshData();
            })
            .withFailureHandler(err => {
              console.error('Error loading settings:', err);
              // Load data anyway even if settings fail
              this.refreshData();
            })
            .SOV1_UI_getSettings();
        },
        
        checkFirstTimeSetup() {
          this.loading = true;
          
          // Check if google.script.run is available
          if (typeof google === 'undefined' || !google.script) {
            console.error('Google Apps Script API not available');
            this.loading = false;
            this.errorMessage = 'لا يمكن الاتصال بالخادم. تأكد من نشر التطبيق بشكل صحيح.';
            return;
          }
          
          google.script.run
            .withSuccessHandler(status => {
              this.configStatus = status;
              if (!status.hasSheet) {
                this.setupMode = true;
                this.loading = false;
                this.errorMessage = 'يرجى إعداد Google Sheets أولاً';
              } else {
                this.refreshData();
              }
            })
            .withFailureHandler(err => {
              console.error('Config check failed:', err);
              this.loading = false;
              this.errorMessage = 'تحذير: قد يكون النظام غير مهيأ بالكامل';
              // Try to load data anyway
              this.refreshData();
            })
            .SOV1_UI_checkConfig();
        },

        refreshData() {
          this.loading = true;
          this.errorMessage = '';
          
          var timeoutId = null;
          var completed = false;
          
          // Extended timeout with better error message
          timeoutId = setTimeout(() => {
            if (!completed && this.loading) {
              this.loading = false;
              this.errorMessage = '⏱️ انتهت مهلة التحميل (30 ثانية). قد يكون السبب:\n' +
                '1. الاتصال بالإنترنت بطيء\n' +
                '2. كمية بيانات كبيرة في الجداول\n' +
                '3. خطأ في Google Apps Script\n\n' +
                'جرب: تحديث الصفحة أو التحقق من Google Sheets';
              console.error('Timeout after 30 seconds');
            }
          }, 30000); // Increased to 30 seconds
          
          // Check if google.script.run is available
          if (typeof google === 'undefined' || !google.script) {
            completed = true;
            clearTimeout(timeoutId);
            this.loading = false;
            this.errorMessage = '❌ خطأ: لا يمكن الاتصال بـ Google Apps Script\n' +
              'تأكد من:\n' +
              '1. أنك تستخدم رابط Web App المنشور\n' +
              '2. لديك إذن الوصول للملف\n' +
              '3. التطبيق منشور بشكل صحيح';
            return;
          }
          
          console.log('🔄 Loading dashboard data...');
          
          // ✅ OPTIMIZED: Single API call instead of 4 separate calls
          google.script.run
            .withSuccessHandler(data => {
              completed = true;
              clearTimeout(timeoutId);
              
              console.log('✅ All dashboard data received:', data);
              
              // CRITICAL: Show debug log if available
              if (data && data.debugLog && Array.isArray(data.debugLog)) {
                console.log('📋 Debug Log from Backend:');
                data.debugLog.forEach(log => console.log('  ' + log));
              }
              
              // Check if response is null or undefined
              if (!data || data === null || typeof data === 'undefined') {
                this.loading = false;
                this.errorMessage = '⚠️ لم يتم استلام بيانات من الخادم.\n' +
                  'الأسباب المحتملة:\n' +
                  '1. Google Sheets غير موجود أو محذوف\n' +
                  '2. لا تملك صلاحيات الوصول\n' +
                  '3. خطأ في Backend Script\n\n' +
                  'جرب: فتح Google Sheets مباشرة والتحقق من البيانات';
                console.error('❌ Response is null/undefined');
                return;
              }
              
              // Check for error in response
              if (data.error || data.success === false) {
                this.loading = false;
                
                // Build detailed error message
                var errorDetails = '❌ خطأ من الخادم: ' + (data.error || 'خطأ غير معروف');
                
                // Add debug log to error message if available
                if (data.debugLog && Array.isArray(data.debugLog)) {
                  errorDetails += '\n\n📋 تفاصيل التشخيص:\n' + data.debugLog.join('\n');
                }
                
                // Add error stack if available
                if (data.errorStack) {
                  errorDetails += '\n\n🔍 Stack Trace:\n' + data.errorStack;
                }
                
                errorDetails += '\n\nقد يكون السبب:\n' +
                  '1. أخطاء في الأكواد البرمجية\n' +
                  '2. مشكلة في صلاحيات Google Sheets\n' +
                  '3. بيانات تالفة في الجداول';
                
                this.errorMessage = errorDetails;
                console.error('❌ Backend error:', data);
                return;
              }
              
              // Load KPI stats
              if (data.dashboard && data.dashboard.kpi) {
                this.stats.income = data.dashboard.kpi.incomeM || 0;
                this.stats.expense = data.dashboard.kpi.spendM || 0;
                this.stats.balance = data.dashboard.kpi.totalBalance || data.dashboard.kpi.netM || 0;  // ✅ Use total account balance
                this.stats.savings = data.dashboard.kpi.netM || 0;  // ✅ Net = Income - Expense
                const delta = data.dashboard.kpi.incomeDeltaPct;
                if (typeof delta === 'number') {
                  const sign = delta >= 0 ? '+' : '';
                  const pct = Math.abs(delta).toFixed(1);
                  this.stats.incomeDeltaText = sign + pct + '% عن الشهر الماضي';
                } else {
                  this.stats.incomeDeltaText = '';
                }
                console.log('✅ KPI loaded:', this.stats);
              } else {
                console.warn('⚠️ No KPI data in response');
              }
              
              // Load transactions
              if (data.transactions && Array.isArray(data.transactions)) {
                this.allTransactions = data.transactions.map((tx, i) => ({
                  id: tx.uuid || tx.row || i,  // ✅ Prefer UUID for tracking
                  row: tx.row,  // Keep row for reference
                  uuid: tx.uuid || '', 
                  date: tx.date,
                  merchant: tx.merchant || 'غير محدد',
                  category: tx.category || tx.type || 'أخرى',
                  amount: tx.amount || 0,
                  type: tx.type || '',
                  account: tx.account || '',
                  notes: tx.notes || '',
                  source: tx.source || '' 
                }));
                this.transactions = this.allTransactions.slice(0, 10);
                console.log('✅ Transactions loaded:', this.transactions.length);
              } else {
                console.warn('⚠️ No transactions in response');
                this.transactions = [];
                this.allTransactions = [];
              }
              
              // Load budgets
              if (data.budgets && Array.isArray(data.budgets)) {
                this.budgets = data.budgets;
                console.log('✅ Budgets loaded:', this.budgets.length);
              } else {
                console.warn('⚠️ No budgets in response');
                this.budgets = [];
              }
              
              // Load accounts
              if (data.accounts && Array.isArray(data.accounts)) {
                this.accounts = data.accounts;
                console.log('✅ Accounts loaded:', this.accounts.length);
              } else {
                this.accounts = [];
              }
              
              // Load categories
              this.loadCategories();
              
              this.loading = false;
              console.log('✅ Dashboard refresh complete');
            })
            .withFailureHandler(err => {
              completed = true;
              clearTimeout(timeoutId);
              
              console.error('❌ Error loading data:', err);
              this.loading = false;
              
              var errorMsg = '❌ فشل تحميل البيانات:\n';
              
              if (err && err.message) {
                errorMsg += err.message;
                
                // Add helpful hints based on error type
                if (err.message.includes('غير مصرح') || err.message.includes('unauthorized')) {
                  errorMsg += '\n\n💡 السبب المحتمل: مشكلة في صلاحيات الوصول';
                } else if (err.message.includes('not found') || err.message.includes('لم يتم العثور')) {
                  errorMsg += '\n\n💡 السبب المحتمل: الجداول المطلوبة غير موجودة';
                } else if (err.message.includes('timeout')) {
                  errorMsg += '\n\n💡 السبب المحتمل: الاتصال بطيء أو البيانات كثيرة';
                }
              } else {
                errorMsg += String(err);
              }
              
              errorMsg += '\n\n🔧 الحلول المقترحة:\n' +
                '1. تحديث الصفحة (F5)\n' +
                '2. فتح Google Sheets والتحقق من البيانات\n' +
                '3. تشغيل testDashboardData() في Apps Script Editor';
              
              this.errorMessage = errorMsg;
            })
            .SOV1_UI_getAllDashboardData_safe('OPEN');
        },
        
        completeSetup() {
          this.loading = true;
          google.script.run
            .withSuccessHandler(result => {
              this.loading = false;
              if (result.success) {
                this.setupMode = false;
                this.refreshData();
                this.showToast('✅ تم إعداد النظام بنجاح!');
              } else {
                this.showToast('❌ فشل الإعداد: ' + result.message, 'error');
              }
            })
            .withFailureHandler(err => {
              this.loading = false;
              this.showToast('❌ خطأ: ' + err.message, 'error');
            })
            .SOV1_UI_quickSetup(this.setupData);
        },
        
        skipSetup() {
          this.setupMode = false;
          this.refreshData();
        },
        
        getBudgetProgress(budget) {
          if (!budget.limit || budget.limit === 0) return 0;
          return Math.min(100, (budget.spent / budget.limit) * 100);
        },
        
        getBudgetColor(progress) {
          if (progress >= 100) return 'bg-red-500';
          if (progress >= 80) return 'bg-yellow-500';
          return 'bg-green-500';
        },

        formatMoney(amount) {
          return new Intl.NumberFormat('ar-SA', { style: 'currency', currency: 'SAR' }).format(amount || 0);
        },

        formatDate(dateStr) {
          if(!dateStr) return '';
          const d = new Date(dateStr);
          if (isNaN(d.getTime())) return dateStr; // Return as-is if invalid
          return d.toLocaleDateString('ar-SA', { month: 'short', day: 'numeric', hour: '2-digit', minute:'2-digit' });
        },
        
        getCategoryIcon(cat) {
            const map = {
              'طعام': '🍔', 'نقل': '🚕', 'فواتير': '🧾', 'تسوق': '🛍️',
              'مطاعم': '🌭', 'سكن': '🏠', 'ترفيه': '🎮', 'صحة': '💊',
              'تعليم': '📚', 'راتب': '💰', 'استثمار': '📈'
            };
            return map[cat] || '💸';
          },
          
          getAccountDisplay(val) {
              if(!val) return '';
              const acc = this.accounts.find(a => a.number && String(a.number).endsWith(String(val)));
              return acc ? acc.name : val;
          },

        showAllTransactions() {
          this.page = 'transactions';
          this.transactions = this.allTransactions;
        },
        
        openAddModal() {
          this.showAddModal = true;
          this.newTransaction = { amount: '', merchant: '', category: 'أخرى', type: 'expense', notes: '', account: 'نقدي' };
          this.rawPasteInput = '';  // Clear paste input for fresh start
        },
        
        parseRawText() {
          const text = this.rawPasteInput;
          if (!text) {
              this.showToast('Please paste some text first', 'warning');
              return;
          }
          
          // Bulk paste support (separated by blank lines)
          const chunks = text.split(/\n\s*\n/).map(t => t.trim()).filter(t => t.length > 0);
          if (chunks.length > 1) {
              this.loadingStates.parsing = true;
              google.script.run
                .withSuccessHandler(res => {
                  this.loadingStates.parsing = false;
                  if (res && res.success) {
                    this.showToast('✅ تم إضافة ' + (res.added || 0) + ' عمليات بنجاح');
                    this.rawPasteInput = '';
                    this.pasting = false;
                    this.refreshData();
                  } else {
                    this.showToast('❌ فشل التحليل: ' + (res && res.error || 'خطأ غير معروف'), 'error');
                  }
                })
                .withFailureHandler(err => {
                  this.loadingStates.parsing = false;
                  this.showToast('AI Error: ' + err.message, 'error');
                })
                .SOV1_UI_bulkIngestSMS(chunks);
              return;
          }

          this.loadingStates.parsing = true;
          
          google.script.run
            .withSuccessHandler(res => {
              this.loadingStates.parsing = false;
              if (res.success && res.result) {
                const r = res.result;
                // Auto-fill form
                if (r.amount) this.newTransaction.amount = r.amount;
                if (r.merchant) this.newTransaction.merchant = r.merchant;
                if (r.category) this.newTransaction.category = r.category;
                
                // Smart Type Detection
                if (r.type) {
                     this.newTransaction.type = (r.type === 'income') ? 'income' : 'expense';
                } else if (r.isIncoming !== undefined) {
                     this.newTransaction.type = r.isIncoming ? 'income' : 'expense';
                }

                // Append any notes
                if (r.notes) this.newTransaction.notes = r.notes;

                // Account Helper: Try to match last 4 digits if provided
                if (r.accNum) {
                    const match = this.accounts.find(a => a.number && a.number.toString().endsWith(r.accNum));
                    if (match) {
                        this.newTransaction.account = match.name;
                    }
                }
                
                // Close paste area
                this.pasting = false;
                this.rawPasteInput = '';
                
                this.showToast('✨ Parsed by Grok!', 'success');
              } else {
                this.showToast('❌ Parsing failed: ' + (res.error || 'Unknown'), 'error');
              }
            })
            .withFailureHandler(err => {
              this.loadingStates.parsing = false;
              this.showToast('AI Error: ' + err.message, 'error');
            })
            .SOV1_UI_parseWithAI(text);
        },
        
        deleteTransaction(tx) {
          if (!confirm('هل أنت متأكد من حذف هذه العملية؟\n' + tx.merchant + ' - ' + this.formatMoney(tx.amount))) {
            return;
          }
          
          this.loading = true;
          google.script.run
            .withSuccessHandler(result => {
              this.loading = false;
              this.showToast('✅ تم حذف العملية بنجاح');
              this.refreshData();
            })
            .withFailureHandler(err => {
              this.loading = false;
              this.errorMessage = 'فشل حذف العملية: ' + (err.message || err);
              this.showToast('❌ فشل حذف العملية: ' + (err.message || err), 'error');
            })
            .SOV1_UI_deleteTransaction(tx.id);
        },
        
        addTransaction() {
          // Validation
          if (!this.newTransaction.merchant || this.newTransaction.merchant.trim() === '') {
            this.showToast('يرجى إدخال اسم التاجر', 'error');
            return;
          }
          
          if (!this.isPositiveNumber(this.newTransaction.amount)) {
            this.showToast('يرجى إدخال مبلغ صحيح أكبر من صفر', 'error');
            return;
          }
          
          // Optimistic UI: Add to UI immediately
          const optimisticTx = {
            id: 'temp-' + Date.now(),
            date: new Date().toISOString(),
            merchant: this.newTransaction.merchant,
            category: this.newTransaction.category,
            amount: this.newTransaction.type === 'expense' ? this.newTransaction.amount : -this.newTransaction.amount,
            type: this.newTransaction.type
          };
          
          this.transactions.unshift(optimisticTx);
          this.allTransactions.unshift(optimisticTx);
          
          // Update stats optimistically
          if (this.newTransaction.type === 'expense') {
            this.stats.expense += parseFloat(this.newTransaction.amount);
          } else {
            this.stats.income += parseFloat(this.newTransaction.amount);
          }
          this.stats.balance = this.stats.income - this.stats.expense;
          
          // Close modal immediately for better UX
          this.showAddModal = false;
          
          const txData = {
              amount: this.newTransaction.amount,
              merchant: this.newTransaction.merchant,
              category: this.newTransaction.category,
              type: this.newTransaction.type,
              notes: this.newTransaction.notes || '',
              account: this.newTransaction.account || 'نقدي'
          };
          
          console.log('Adding transaction (optimistic):', txData);
          
          // Backend sync (async)
          google.script.run
            .withSuccessHandler(result => {
              console.log('Transaction confirmed by backend:', result);
              // Refresh to get accurate data from server
              setTimeout(() => this.refreshData(), 1000);
            })
            .withFailureHandler(err => {
              // Rollback optimistic update on failure
              this.transactions = this.transactions.filter(t => t.id !== optimisticTx.id);
              this.allTransactions = this.allTransactions.filter(t => t.id !== optimisticTx.id);
              this.errorMessage = 'فشل إضافة العملية: ' + (err.message || err);
              this.showToast('❌ فشل إضافة العملية. سيتم التحديث.', 'error');
              this.refreshData();
            })
            .SOV1_UI_createTransaction(txData);
        },
        
        saveSettings() {
          // Validation
          if (!this.userSettings.user_name || this.userSettings.user_name.trim() === '') {
            this.showToast('يرجى إدخال الاسم', 'error');
            return;
          }
          
          if (this.userSettings.user_email && !this.isValidEmail(this.userSettings.user_email)) {
            this.showToast('يرجى إدخال بريد إلكتروني صحيح', 'error');
            return;
          }
          
          this.loadingStates.settings = true;
          
          google.script.run
            .withSuccessHandler((result) => {
              this.loadingStates.settings = false;
              this.showToast('تم حفظ الإعدادات بنجاح');
              // Refresh settings to update UI immediately
              this.loadSettings();
            })
            .withFailureHandler(err => {
              this.loadingStates.settings = false;
              this.showToast('فشل حفظ الإعدادات', 'error');
            })
            .SOV1_UI_saveSettings(this.userSettings);
        },
        
        loadReport(period) {
          this.reportPeriod = period;
          this.loading = true;
          
          google.script.run
            .withSuccessHandler(data => {
              this.loading = false;
              this.reportData = data;
              console.log('Report data loaded:', data);
            })
            .withFailureHandler(err => {
              this.loading = false;
              this.errorMessage = 'فشل تحميل التقرير: ' + (err.message || err);
              console.error('Error loading report:', err);
            })
            .SOV1_UI_getReportData('OPEN', period);
        },
        
        loadAccounts() {
          google.script.run
            .withSuccessHandler(data => {
              this.accounts = data || [];
              console.log('Accounts loaded:', data);
            })
            .withFailureHandler(err => {
              console.error('Error loading accounts:', err);
              this.accounts = [];
            })
            .SOV1_UI_getAccounts();
        },
        
        addOrEditBudget() {
          // Validation
          if (!this.newBudget.category || this.newBudget.category.trim() === '') {
            this.showToast('يرجى إدخال اسم التصنيف', 'error');
            return;
          }
          
          if (!this.isPositiveNumber(this.newBudget.limit)) {
            this.showToast('يرجى إدخال مبلغ صحيح أكبر من صفر', 'error');
            return;
          }
          
          this.loadingStates.budgets = true;
          
          if (this.editingBudget) {
            // Update
            google.script.run
              .withSuccessHandler(result => {
                this.loadingStates.budgets = false;
                this.showBudgetModal = false;
                this.showToast('تم تحديث الميزانية بنجاح');
                this.refreshData();
              })
              .withFailureHandler(err => {
                this.loadingStates.budgets = false;
                this.showToast('فشل تحديث الميزانية', 'error');
              })
              .SOV1_UI_updateBudget(this.newBudget.category, parseFloat(this.newBudget.limit));
          } else {
            // Create
            google.script.run
              .withSuccessHandler(result => {
                this.loadingStates.budgets = false;
                this.showBudgetModal = false;
                this.showToast('تم حفظ الميزانية بنجاح');
                this.refreshData();
              })
              .withFailureHandler(err => {
                this.loadingStates.budgets = false;
                this.showToast('فشل حفظ الميزانية', 'error');
              })
              .SOV1_UI_saveBudget(this.newBudget);
          }
        },
        
        deleteBudget(category) {
          if (!confirm('هل أنت متأكد من حذف ميزانية ' + category + '؟')) {
            return;
          }
          
          this.loadingStates.budgets = true;
          google.script.run
            .withSuccessHandler(result => {
              this.loadingStates.budgets = false;
              this.showToast('تم حذف الميزانية');
              this.refreshData();
            })
            .withFailureHandler(err => {
              this.loadingStates.budgets = false;
              this.showToast('فشل حذف الميزانية', 'error');
            })
            .SOV1_UI_deleteBudget(category);
        },

        // Category Management Functions
        loadCategories() {
          if (this.categoriesLoaded) return;
          
          google.script.run
            .withSuccessHandler(categories => {
              const cats = categories || [];
              this.categories = cats;
              this.categoryOptions = cats.map(c => typeof c === 'object' ? c.name : c).filter(Boolean);
              this.categoriesLoaded = true;
            })
            .withFailureHandler(err => {
              console.error('Failed to load categories:', err);
              this.categories = [];
              this.categoryOptions = [];
            })
            .SOV1_UI_getCategoriesManage('OPEN');
        },

        openEditCategoryModal(category) {
          this.editingCategory = category;
          this.newCategory = {
            name: category.name,
            icon: category.icon,
            color: category.color,
            type: category.type || 'expense',
            description: category.description || ''
          };
          this.showCategoryModal = true;
        },

        saveCategory() {
          if (!this.newCategory.name.trim()) {
            this.showToast('يرجى إدخال اسم التصنيف', 'error');
            return;
          }

          const isEditing = this.editingCategory !== null;
          const action = isEditing ? 'تحديث' : 'إضافة';

          if (isEditing) {
            // SOV1_UI_updateCategory(token, row, name, icon, color, active, description)
            google.script.run
              .withSuccessHandler(result => {
                this.showToast('تم ' + action + ' التصنيف بنجاح');
                this.showCategoryModal = false;
                this.loadCategories();
                this.refreshData();
              })
              .withFailureHandler(err => {
                this.showToast('فشل ' + action + ' التصنيف: ' + (err.message || err), 'error');
              })
              .SOV1_UI_updateCategory(
                'OPEN',
                this.editingCategory.row,
                this.newCategory.name,
                this.newCategory.icon,
                this.newCategory.color,
                true, // active
                this.newCategory.description
              );
          } else {
            // SOV1_UI_addCategory(token, name, icon, color, description)
            google.script.run
              .withSuccessHandler(result => {
                this.showToast('تم ' + action + ' التصنيف بنجاح');
                this.showCategoryModal = false;
                this.loadCategories();
                this.refreshData();
              })
              .withFailureHandler(err => {
                this.showToast('فشل ' + action + ' التصنيف: ' + (err.message || err), 'error');
              })
              .SOV1_UI_addCategory(
                'OPEN',
                this.newCategory.name,
                this.newCategory.icon,
                this.newCategory.color,
                this.newCategory.description
              );
          }
        },

        deleteCategory(categoryName) {
          if (!confirm('هل أنت متأكد من حذف تصنيف "' + categoryName + '"؟ سيتم تعطيل التصنيف بدلاً من حذفه نهائياً.')) {
            return;
          }

          google.script.run
            .withSuccessHandler(result => {
              this.showToast('تم حذف التصنيف');
              this.loadCategories();
              this.refreshData();
            })
            .withFailureHandler(err => {
              this.showToast('فشل حذف التصنيف', 'error');
            })
            .SOV1_UI_deleteCategory('OPEN', this.categories.find(c => c.name === categoryName)?.row);
        },

        cleanupCategories() {
          if (!confirm('هل تريد تنظيف التصنيفات؟ سيتم إزالة التصنيفات التجريبية وتوحيد التصنيفات المكررة.')) {
            return;
          }

          google.script.run
            .withSuccessHandler(result => {
              this.showToast(result.message || 'تم تنظيف التصنيفات');
              this.loadCategories();
              this.refreshData();
            })
            .withFailureHandler(err => {
              this.showToast('فشل تنظيف التصنيفات', 'error');
            })
            .SOV1_UI_cleanupCategories('OPEN');
        },
        
        saveSettings() {
          if (!this.userSettings.user_name) {
            this.showToast('يرجى إدخال الاسم', 'error');
            return;
          }
          
          this.loading = true;
          console.log('Saving settings:', this.userSettings);
          
          // Safety timeout
          const timeoutId = setTimeout(() => {
            this.loading = false;
            this.errorMessage = 'انتهت مهلة الحفظ';
          }, 8000);
          
          google.script.run
            .withSuccessHandler((result) => {
              clearTimeout(timeoutId);
              this.loading = false;
              this.showToast('✅ تم حفظ الإعدادات بنجاح');
              console.log('Settings saved:', result);
            })
            .withFailureHandler(err => {
              clearTimeout(timeoutId);
              this.loading = false;
              this.errorMessage = 'فشل حفظ الإعدادات: ' + (err.message || err);
              this.showToast('❌ فشل حفظ الإعدادات: ' + (err.message || err), 'error');
            })
            .SOV1_UI_saveSettings(this.userSettings);
        },
        
        openAccountModal() {
          this.editingAccount = null;
          this.newAccount = { name: '', type: 'بنك', number: '', bank: '', aliases: '', isMine: true, isInternal: false, smsText: '', balance: 0 };
          this.showAccountModal = true;
        },
        
        extractFromSMS() {
          if (!this.newAccount.smsText || this.newAccount.smsText.trim().length === 0) {
            this.showToast('⚠️ الرجاء لصق نص الرسالة أولاً', 'error');
            return;
          }
          
          this.loading = true;
          
          google.script.run
            .withSuccessHandler(result => {
              this.loading = false;
              if (result.success && result.account) {
                // Auto-fill form with AI extracted data
                this.newAccount = { ...this.newAccount, ...result.account };
                this.showToast('✅ تم استخراج البيانات من الرسالة!');
              } else {
                this.showToast('❌ فشل الاستخراج: ' + (result.error || 'خطأ غير معروف'), 'error');
              }
            })
            .withFailureHandler(err => {
              this.loading = false;
              this.showToast('❌ خطأ: ' + (err.message || err), 'error');
            })
            .SOV1_UI_extractAccountFromSMS(this.newAccount.smsText);
        },

        // ---------- Bulk Import SMS (frontend) ----------
        parseBulkSms() {
          if (!this.bulkSmsText || this.bulkSmsText.trim().length === 0) { this.showToast('⚠️ الرجاء لصق رسائل SMS أولاً', 'error'); return; }
          this.bulkParsing = true;
          var groups = (this.bulkSmsText || '').split(/\r?\n\s*\r?\n/).map(g => g.trim()).filter(g => g.length > 0).map(g => g.split(/\r?\n/).join(' | '));
          google.script.run
            .withSuccessHandler(result => {
              this.bulkParsing = false;
              if (result && result.success && result.results) {
                // Attach selection flag
                this.bulkParseResults = result.results.map(function(r) { r.selected = false; return r; });
                this.showBulkImportModal = true;
              } else {
                this.showToast('❌ فشل التحليل: ' + (result && result.error || 'خطأ غير معروف'), 'error');
              }
            })
            .withFailureHandler(err => { this.bulkParsing = false; this.showToast('❌ خطأ: ' + (err.message || err), 'error'); })
            .SOV1_UI_bulkExtractAccounts(groups);
        },

        importSelectedAccounts() {
          var selected = this.bulkParseResults.filter(r => r.selected && r.result && r.result.success && r.result.account);
          if (selected.length === 0) { this.showToast('لا توجد عناصر محددة للاستيراد', 'error'); return; }
          var accounts = selected.map(s => {
            var a = s.result.account;
            return { name: a.name || (a.bank + ' ' + (a.number || '')), type: a.type || 'بنك', number: a.number || '', bank: a.bank || '', balance: 0, isMine: true, isInternal: !!a.isInternal, aliases: a.aliases || '', notes: 'imported via bulk SMS' };
          });
          this.loading = true;
          google.script.run
            .withSuccessHandler(res => {
              this.loading = false;
              if (res && res.success) {
                this.showBulkImportModal = false;
                this.bulkParseResults = [];
                this.bulkSmsText = '';
                this.showToast('✅ ' + (res.results && res.results.length || 0) + ' حسابات تم استيرادها');
                this.loadAccounts();
              } else {
                this.showToast('❌ فشل الاستيراد: ' + (res && res.error || 'خطأ غير معروف'), 'error');
              }
            })
            .withFailureHandler(err => { this.loading = false; this.showToast('❌ خطأ: ' + (err.message || err), 'error'); })
            .SOV1_UI_bulkAddAccounts(accounts);
        },
        
        editAccount(account) {
          this.editingAccount = account;
          this.newAccount = { ...account };
          this.showAccountModal = true;
        },
        
        saveAccount() {
          if (!this.newAccount.name || !this.newAccount.type) {
            this.showToast('الاسم والنوع مطلوبان', 'error');
            return;
          }
          
          this.loading = true;
          
          if (this.editingAccount) {
            // Update
            google.script.run
              .withSuccessHandler(result => {
                this.loading = false;
                this.showAccountModal = false;
                this.showToast('✅ تم تحديث الحساب');
                this.loadAccounts();
              })
              .withFailureHandler(err => {
                this.loading = false;
                this.showToast('❌ فشل التحديث: ' + (err.message || err), 'error');
              })
              .SOV1_UI_updateAccount(this.editingAccount.id, this.newAccount);
          } else {
            // Add new
            google.script.run
              .withSuccessHandler(result => {
                this.loading = false;
                this.showAccountModal = false;
                this.showToast('✅ تم إضافة الحساب');
                this.loadAccounts();
              })
              .withFailureHandler(err => {
                this.loading = false;
                this.showToast('❌ فشل الإضافة: ' + (err.message || err), 'error');
              })
              .SOV1_UI_addAccount(this.newAccount);
          }
        },
        
        deleteAccount(account) {
          if (!confirm('هل أنت متأكد من حذف الحساب: ' + account.name + '?')) {
            return;
          }
          
          this.loading = true;
          google.script.run
            .withSuccessHandler(result => {
              this.loading = false;
              this.showToast('✅ تم حذف الحساب');
              this.loadAccounts();
            })
            .withFailureHandler(err => {
              this.loading = false;
              this.showToast('❌ فشل الحذف', 'error');
            })
            .SOV1_UI_deleteAccount(account.id);
        },
        
        showToast(message, type = 'success') {
          const id = Date.now();
          this.toasts.push({ id, message, type });
          setTimeout(() => {
            this.toasts = this.toasts.filter(t => t.id !== id);
          }, 3000);
        },
        
        isValidEmail(email) {
          const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return regex.test(email);
        },
        
        isPositiveNumber(value) {
          const num = parseFloat(value);
          return !isNaN(num) && num > 0;
        },

        // ============ TEST PANEL FUNCTIONS ============
        
        testSMSParsing() {
          this.testingStates.sms = true;
          this.testResults.sms = 'جاري اختبار تحليل SMS...';
          
          // Sample SMS message for testing
          const testSMS = 'تم خصم مبلغ 150.00 ريال من حسابك الجاري ****1234 لدى ماكدونالدز في 2025/01/24';
          
          google.script.run
            .withSuccessHandler(result => {
              this.testingStates.sms = false;
              if (result && result.success) {
                this.testResults.sms = '✅ نجح تحليل SMS!\n\n' +
                  'المبلغ: ' + (result.amount || 'غير محدد') + '\n' +
                  'التاجر: ' + (result.merchant || 'غير محدد') + '\n' +
                  'الحساب: ' + (result.account || 'غير محدد') + '\n' +
                  'النوع: ' + (result.type || 'غير محدد');
              } else {
                this.testResults.sms = '⚠️ فشل التحليل: ' + (result?.error || 'خطأ غير معروف');
              }
            })
            .withFailureHandler(err => {
              this.testingStates.sms = false;
              this.testResults.sms = '❌ خطأ: ' + (err.message || err);
            })
            .SOV1_UI_testParseSMS(testSMS);
        },
        
        testAIClassification() {
          this.testingStates.ai = true;
          this.testResults.ai = 'جاري اختبار تصنيف AI...';
          
          google.script.run
            .withSuccessHandler(result => {
              this.testingStates.ai = false;
              if (result && result.success) {
                this.testResults.ai = '✅ نجح تصنيف AI!\n\n' +
                  'التصنيف: ' + (result.category || 'غير محدد') + '\n' +
                  'الثقة: ' + (result.confidence || 'غير محدد') + '%\n' +
                  'المصدر: ' + (result.source || 'غير محدد');
              } else {
                this.testResults.ai = '⚠️ فشل التصنيف: ' + (result?.error || 'خطأ غير معروف');
              }
            })
            .withFailureHandler(err => {
              this.testingStates.ai = false;
              this.testResults.ai = '❌ خطأ: ' + (err.message || err);
            })
            .SOV1_UI_testAIClassify('ماكدونالدز', 150);
        },
        
        testTelegram() {
          this.testingStates.telegram = true;
          this.testResults.telegram = 'جاري إرسال رسالة تجريبية...';
          
          google.script.run
            .withSuccessHandler(result => {
              this.testingStates.telegram = false;
              if (result && result.success) {
                this.testResults.telegram = '✅ تم إرسال الرسالة بنجاح!\n\n' +
                  'تحقق من تيليجرام لرؤية الرسالة التجريبية.';
              } else {
                this.testResults.telegram = '⚠️ فشل الإرسال: ' + (result?.error || 'خطأ غير معروف');
              }
            })
            .withFailureHandler(err => {
              this.testingStates.telegram = false;
              this.testResults.telegram = '❌ خطأ: ' + (err.message || err);
            })
            .SOV1_UI_testTelegram();
        },
        
        testFullFlow() {
          this.testingStates.fullFlow = true;
          this.testResults.fullFlow = 'جاري اختبار التدفق الكامل...\n' +
            '1️⃣ تحليل SMS...\n' +
            '2️⃣ تصنيف AI...\n' +
            '3️⃣ حفظ البيانات...\n' +
            '4️⃣ إرسال إشعار...';
          
          google.script.run
            .withSuccessHandler(result => {
              this.testingStates.fullFlow = false;
              if (result && result.success) {
                this.testResults.fullFlow = '✅ نجح التدفق الكامل!\n\n' +
                  '📝 SMS: ' + (result.steps?.sms || '✓') + '\n' +
                  '🤖 AI: ' + (result.steps?.ai || '✓') + '\n' +
                  '💾 Save: ' + (result.steps?.save || '✓') + '\n' +
                  '📱 Telegram: ' + (result.steps?.telegram || '✓') + '\n\n' +
                  'النتيجة: ' + (result.summary || 'اكتمل بنجاح');
              } else {
                this.testResults.fullFlow = '⚠️ فشل التدفق: ' + (result?.error || 'خطأ غير معروف') +
                  '\n\nالخطوات المكتملة:\n' +
                  (result?.steps ? JSON.stringify(result.steps, null, 2) : 'غير متاح');
              }
            })
            .withFailureHandler(err => {
              this.testingStates.fullFlow = false;
              this.testResults.fullFlow = '❌ خطأ: ' + (err.message || err);
            })
            .SOV1_UI_testFullFlow();
        },
        // ============ END TEST PANEL ============

        // ============ REPORT EXPORT FUNCTIONS ============
        exportReportPDF() {
          this.showToast('جاري إنشاء PDF...', 'info');
          
          // Create a printable version of the report
          const reportContent = document.getElementById('reportContent');
          if (!reportContent) {
            this.showToast('لا يوجد تقرير للتصدير', 'error');
            return;
          }
          
          // Create PDF-friendly HTML
          const periodNames = { daily: 'اليوم', weekly: 'الأسبوع', monthly: 'الشهر' };
          const periodName = periodNames[this.reportPeriod] || 'التقرير';
          
          const printContent = `
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
              <meta charset="utf-8">
              <title>تقرير ${periodName} - SJA Money Tracker</title>
              <style>
                body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; padding: 40px; direction: rtl; }
                h1 { color: #16a34a; margin-bottom: 10px; }
                .date { color: #666; margin-bottom: 30px; }
                .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                .stat-box { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; }
                .stat-label { font-size: 14px; color: #666; margin-bottom: 5px; }
                .stat-value { font-size: 24px; font-weight: bold; }
                .green { color: #16a34a; }
                .red { color: #dc2626; }
                .blue { color: #2563eb; }
                .categories { margin-top: 30px; }
                .categories h2 { margin-bottom: 20px; }
                .cat-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
                .footer { margin-top: 50px; text-align: center; color: #999; font-size: 12px; }
                @media print { body { padding: 20px; } }
              </style>
            </head>
            <body>
              <h1>📊 تقرير ${periodName}</h1>
              <div class="date">التاريخ: ${new Date().toLocaleDateString('ar-SA')}</div>
              
              <div class="stats">
                <div class="stat-box"><div class="stat-label">الدخل</div><div class="stat-value green">${this.formatMoney(this.reportData?.income || 0)}</div></div>
                <div class="stat-box"><div class="stat-label">المصروفات</div><div class="stat-value red">${this.formatMoney(this.reportData?.expenses || 0)}</div></div>
                <div class="stat-box"><div class="stat-label">الادخار</div><div class="stat-value ${(this.reportData?.savings || 0) >= 0 ? 'green' : 'red'}">${this.formatMoney(this.reportData?.savings || 0)}</div></div>
                <div class="stat-box"><div class="stat-label">عدد العمليات</div><div class="stat-value blue">${this.reportData?.transactionCount || 0}</div></div>
              </div>
              
              <div class="categories">
                <h2>المصروفات حسب التصنيف</h2>
                ${(this.reportData?.chartData || []).map(item => 
                  `<div class="cat-item"><span>${item.category}</span><span>${this.formatMoney(item.amount)}</span></div>`
                ).join('')}
              </div>
              
              <div class="footer">SJA Money Tracker - ${new Date().toLocaleDateString('ar-SA')}</div>
            </body>
            </html>
          `;
          
          // Open print dialog (user can save as PDF)
          const printWindow = window.open('', '_blank');
          printWindow.document.write(printContent);
          printWindow.document.close();
          printWindow.focus();
          
          setTimeout(() => {
            printWindow.print();
            this.showToast('اختر "حفظ كـ PDF" من نافذة الطباعة', 'success');
          }, 500);
        },
        
        exportReportCSV() {
          if (!this.reportData) {
            this.showToast('لا يوجد تقرير للتصدير', 'error');
            return;
          }
          
          const periodNames = { daily: 'daily', weekly: 'weekly', monthly: 'monthly' };
          const period = periodNames[this.reportPeriod] || 'report';
          
          // Create CSV content
          let csv = 'التصنيف,المبلغ\n';
          (this.reportData?.chartData || []).forEach(item => {
            csv += `"${item.category}",${item.amount}\n`;
          });
          csv += `\n"إجمالي الدخل",${this.reportData?.income || 0}\n`;
          csv += `"إجمالي المصروفات",${this.reportData?.expenses || 0}\n`;
          csv += `"الادخار",${this.reportData?.savings || 0}\n`;
          csv += `"عدد العمليات",${this.reportData?.transactionCount || 0}\n`;
          
          const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = `report_${period}_${new Date().toISOString().split('T')[0]}.csv`;
          link.click();
          
          this.showToast('تم تصدير التقرير بنجاح', 'success');
        },
        
        printReport() {
          if (!this.reportData) {
            this.showToast('لا يوجد تقرير للطباعة', 'error');
            return;
          }
          this.exportReportPDF(); // Same as PDF - opens print dialog
        },
        
        exportAllDataPDF() {
          this.showToast('جاري إنشاء PDF...', 'info');
          
          // Create comprehensive PDF with all transactions
          const printContent = `
            <!DOCTYPE html>
            <html lang="ar" dir="rtl">
            <head>
              <meta charset="utf-8">
              <title>تقرير المعاملات - SJA Money Tracker</title>
              <style>
                body { font-family: 'Segoe UI', Tahoma, Arial, sans-serif; padding: 40px; direction: rtl; }
                h1 { color: #16a34a; margin-bottom: 10px; }
                .date { color: #666; margin-bottom: 30px; }
                .summary { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
                .summary-box { border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; text-align: center; }
                .summary-label { font-size: 14px; color: #666; margin-bottom: 5px; }
                .summary-value { font-size: 24px; font-weight: bold; }
                .green { color: #16a34a; }
                .red { color: #dc2626; }
                table { width: 100%; border-collapse: collapse; margin-top: 30px; }
                th, td { border: 1px solid #e5e7eb; padding: 12px; text-align: right; }
                th { background: #f9fafb; font-weight: bold; }
                tr:nth-child(even) { background: #f9fafb; }
                .footer { margin-top: 50px; text-align: center; color: #999; font-size: 12px; }
                @media print { body { padding: 20px; } }
              </style>
            </head>
            <body>
              <h1>📊 تقرير المعاملات المالية</h1>
              <div class="date">التاريخ: ${new Date().toLocaleDateString('ar-SA')}</div>
              
              <div class="summary">
                <div class="summary-box"><div class="summary-label">الرصيد</div><div class="summary-value green">${this.formatMoney(this.stats.balance)}</div></div>
                <div class="summary-box"><div class="summary-label">الدخل</div><div class="summary-value green">${this.formatMoney(this.stats.income)}</div></div>
                <div class="summary-box"><div class="summary-label">المصروفات</div><div class="summary-value red">${this.formatMoney(this.stats.expense)}</div></div>
                <div class="summary-box"><div class="summary-label">التوفير</div><div class="summary-value">${this.formatMoney(this.stats.savings)}</div></div>
              </div>
              
              <h2>آخر ${Math.min(this.allTransactions.length, 50)} معاملة</h2>
              <table>
                <thead>
                  <tr>
                    <th>التاريخ</th>
                    <th>التاجر</th>
                    <th>التصنيف</th>
                    <th>المبلغ</th>
                  </tr>
                </thead>
                <tbody>
                  ${this.allTransactions.slice(0, 50).map(tx => `
                    <tr>
                      <td>${this.formatDate(tx.date)}</td>
                      <td>${tx.merchant || 'غير محدد'}</td>
                      <td>${tx.category || 'أخرى'}</td>
                      <td class="${tx.amount > 0 ? 'red' : 'green'}">${this.formatMoney(Math.abs(tx.amount))}</td>
                    </tr>
                  `).join('')}
                </tbody>
              </table>
              
              <div class="footer">SJA Money Tracker - تم الإنشاء في ${new Date().toLocaleString('ar-SA')}</div>
            </body>
            </html>
          `;
          
          const printWindow = window.open('', '_blank');
          printWindow.document.write(printContent);
          printWindow.document.close();
          printWindow.focus();
          
          setTimeout(() => {
            printWindow.print();
            this.showToast('اختر "حفظ كـ PDF" من نافذة الطباعة', 'success');
          }, 500);
        },
        // ============ END REPORT EXPORT ============

        exportData() {
          this.showToast('جاري تصدير البيانات...', 'info');
          google.script.run
            .withSuccessHandler(csv => {
              const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
              const link = document.createElement('a');
              const url = URL.createObjectURL(blob);
              link.setAttribute('href', url);
              link.setAttribute('download', 'transactions_' + new Date().toISOString().split('T')[0] + '.csv');
              link.style.visibility = 'hidden';
              document.body.appendChild(link);
              link.click();
              document.body.removeChild(link);
              this.showToast('تم تصدير البيانات بنجاح', 'success');
            })
            .withFailureHandler(err => {
              this.showToast('فشل تصدير البيانات', 'error');
            })
            .SOV1_UI_exportData();
        },
        
        confirmDeleteAccount() {
          if (confirm('⚠️ تحذير: سيتم حذف جميع بياناتك بشكل نهائي. هل أنت متأكد؟\\n\\nاكتب \"نعم\" للتأكيد.')) {
            const confirmation = prompt('اكتب \"حذف\" للتأكيد النهائي:');
            if (confirmation === 'حذف') {
              this.deleteUserAccount();
            } else {
              this.showToast('تم إلغاء الحذف', 'info');
            }
          }
        },
        
        deleteUserAccount() {
          this.showToast('جاري حذف الحساب...', 'info');
          google.script.run
            .withSuccessHandler(result => {
              alert('✅ تم حذف حسابك بنجاح. سيتم تحديث الصفحة.');
              window.location.reload();
            })
            .withFailureHandler(err => {
              this.showToast('فشل حذف الحساب: ' + err.message, 'error');
            })
            .SOV1_UI_deleteUserAccount();
        },
        
        searchTransactions() {
          if (!this.searchQuery || this.searchQuery.trim() === '') {
            this.filteredTransactions = this.allTransactions;
          } else {
            const query = this.searchQuery.toLowerCase();
            this.filteredTransactions = this.allTransactions.filter(tx => 
              tx.merchant.toLowerCase().includes(query) ||
              tx.category.toLowerCase().includes(query) ||
              String(tx.amount).includes(query)
            );
          }
          this.transactions = this.filteredTransactions.slice(0, 50);
        },
        
        openEditBudgetModal(budget) {
          this.editingBudget = budget;
          this.newBudget = { category: budget.category, limit: budget.limit };
          this.showBudgetModal = true;
        },
        
        openEditTransactionModal(tx) {
          this.editingTransaction = tx;
          this.newTransaction = {
            rowId: tx.uuid || tx.id, // ✅ Prefer UUID, fallback to id (which could be row)
            merchant: tx.merchant,
            category: tx.category,
            amount: tx.amount,
            notes: tx.notes || '',
            type: tx.type || 'expense',
            account: tx.account || 'نقدي'
          };
          this.showEditTransactionModal = true;
        },
        
        saveEditedTransaction() {
          // Validation
          if (!this.newTransaction.merchant || this.newTransaction.merchant.trim() === '') {
            this.showToast('يرجى إدخال اسم التاجر', 'error');
            return;
          }
          
          if (!this.isPositiveNumber(this.newTransaction.amount)) {
            this.showToast('يرجى إدخال مبلغ صحيح أكبر من صفر', 'error');
            return;
          }
          
          if (!this.newTransaction.category || this.newTransaction.category.trim() === '') {
            this.showToast('يرجى اختيار التصنيف', 'error');
            return;
          }
          
          this.loading = true;
          google.script.run
            .withSuccessHandler(result => {
              this.loading = false;
              this.showEditTransactionModal = false;
              this.showToast('تم تحديث العملية بنجاح');
              this.refreshData();
            })
            .withFailureHandler(err => {
              this.loading = false;
              this.showToast('فشل تحديث العملية', 'error');
            })
            .SOV1_UI_updateTransaction(this.newTransaction.rowId, {
              merchant: this.newTransaction.merchant,
              category: this.newTransaction.category,
              amount: parseFloat(this.newTransaction.amount),
              notes: this.newTransaction.notes,
              type: this.newTransaction.type,
              account: this.newTransaction.account
            });
        }
      }
    }
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="text-gray-800" x-data="appData()" x-init="init()" x-cloak>
  
  <!-- Setup Wizard Overlay -->
  <div x-show="setupMode" class="fixed inset-0 bg-gradient-to-br from-blue-600 to-purple-700 z-50 flex items-center justify-center p-4" x-transition>
    <div class="bg-white rounded-3xl shadow-2xl max-w-2xl w-full p-8">
      <!-- Header -->
      <div class="text-center mb-8">
        <div class="text-6xl mb-4">💰</div>
        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">مرحباً في SJA Money Tracker</h1>
        <p class="text-gray-600">دعنا نعد نظامك في دقائق!</p>
      </div>

      <!-- Error Alert -->
      <div x-show="errorMessage" class="mb-6 p-4 bg-red-50 border border-red-200 rounded-xl text-red-700 text-sm" x-transition>
        <strong>⚠️ خطأ:</strong> <span x-text="errorMessage"></span>
      </div>

      <!-- Setup Status -->
      <div class="space-y-4 mb-8">
        <div class="flex items-center gap-3 p-4 rounded-xl" :class="configStatus.hasSheet ? 'bg-green-50' : 'bg-gray-50'">
          <span x-show="configStatus.hasSheet" class="text-2xl">✅</span>
          <span x-show="!configStatus.hasSheet" class="text-2xl">⚠️</span>
          <div class="flex-1">
            <div class="font-bold text-gray-900">Google Sheets</div>
            <div class="text-sm text-gray-600">تخزين البيانات</div>
          </div>
          <span x-show="configStatus.hasSheet" class="text-xs text-green-600 font-bold">جاهز</span>
          <span x-show="!configStatus.hasSheet" class="text-xs text-gray-500 font-bold">مطلوب</span>
        </div>

        <div class="flex items-center gap-3 p-4 rounded-xl" :class="configStatus.hasTelegram ? 'bg-green-50' : 'bg-gray-50'">
          <span x-show="configStatus.hasTelegram" class="text-2xl">✅</span>
          <span x-show="!configStatus.hasTelegram" class="text-2xl">⚠️</span>
          <div class="flex-1">
            <div class="font-bold text-gray-900">Telegram Bot</div>
            <div class="text-sm text-gray-600">استقبال الرسائل</div>
          </div>
          <span x-show="configStatus.hasTelegram" class="text-xs text-green-600 font-bold">متصل</span>
          <span x-show="!configStatus.hasTelegram" class="text-xs text-gray-500 font-bold">مطلوب</span>
        </div>

        <div class="flex items-center gap-3 p-4 rounded-xl" :class="configStatus.hasAI ? 'bg-green-50' : 'bg-yellow-50'">
          <span x-show="configStatus.hasAI" class="text-2xl">✅</span>
          <span x-show="!configStatus.hasAI" class="text-2xl">ℹ️</span>
          <div class="flex-1">
            <div class="font-bold text-gray-900">AI Classification</div>
            <div class="text-sm text-gray-600">تصنيف تلقائي للمعاملات</div>
          </div>
          <span x-show="configStatus.hasAI" class="text-xs text-green-600 font-bold">مفعّل</span>
          <span x-show="!configStatus.hasAI" class="text-xs text-yellow-600 font-bold">اختياري</span>
        </div>
      </div>

      <!-- Quick Start Guide -->
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 mb-6">
        <h3 class="font-bold text-blue-900 mb-3 flex items-center gap-2">
          <span>📚</span> دليل البدء السريع
        </h3>
        <ol class="space-y-2 text-sm text-blue-800">
          <li class="flex gap-2"><span class="font-bold">1.</span> افتح Google Sheets وانسخ معرف الملف (SHEET_ID)</li>
          <li class="flex gap-2"><span class="font-bold">2.</span> أنشئ بوت تيليجرام عبر @BotFather</li>
          <li class="flex gap-2"><span class="font-bold">3.</span> الصق البيانات في Script Properties</li>
          <li class="flex gap-2"><span class="font-bold">4.</span> أرسل /start للبوت للحصول على Chat ID</li>
        </ol>
      </div>

      <!-- Actions -->
      <div class="flex gap-3">
        <button @click="skipSetup()" class="flex-1 px-6 py-3 border-2 border-gray-300 rounded-xl font-bold text-gray-700 hover:bg-gray-50 transition">
          تخطي الآن
        </button>
        <button @click="page='setup'; setupMode=false" class="flex-1 px-6 py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white rounded-xl font-bold hover:shadow-lg transition">
          فتح دليل الإعداد
        </button>
      </div>

      <div class="mt-4 text-center">
        <a href="https://github.com/your-repo/wiki/setup" target="_blank" class="text-sm text-blue-600 hover:underline">
          📖 شاهد الفيديو التعليمي
        </a>
      </div>
    </div>
  </div>
  
  <!-- Sidebar (Desktop) -->
  <div class="fixed inset-y-0 right-0 w-64 bg-white shadow-xl hidden lg:flex flex-col z-20">
    <div class="h-20 flex items-center justify-center border-b border-gray-100">
      <div class="text-2xl font-extrabold text-green-600 tracking-tight flex items-center gap-2">
        <span class="text-green-600 font-black">SJA</span>
      </div>
    </div>
    <nav class="flex-1 px-4 py-6 space-y-2">
      <a href="#" @click.prevent="page='dashboard'" :class="{'bg-green-50 text-green-700': page==='dashboard', 'text-gray-600 hover:bg-gray-50': page!=='dashboard'}" class="flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors">
        <span>📊</span> لوحة التحكم
      </a>
      <a href="#" @click.prevent="page='transactions'" :class="{'bg-green-50 text-green-700': page==='transactions', 'text-gray-600 hover:bg-gray-50': page!=='transactions'}" class="flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors">
        <span>📋</span> العمليات
      </a>
      <a href="#" @click.prevent="page='budgets'" :class="{'bg-green-50 text-green-700': page==='budgets', 'text-gray-600 hover:bg-gray-50': page!=='budgets'}" class="flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors">
        <span></span> الميزانيات والتصنيفات
      </a>
      <a href="#" @click.prevent="page='reports'" :class="{'bg-green-50 text-green-700': page==='reports', 'text-gray-600 hover:bg-gray-50': page!=='reports'}" class="flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors">
        <span>📊</span> التقارير
      </a>
      <a href="#" @click.prevent="page='accounts'" :class="{'bg-green-50 text-green-700': page==='accounts', 'text-gray-600 hover:bg-gray-50': page!=='accounts'}" class="flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors">
        <span>🏦</span> الحسابات
      </a>
      <a href="#" @click.prevent="page='settings'" :class="{'bg-green-50 text-green-700': page==='settings', 'text-gray-600 hover:bg-gray-50': page!=='settings'}" class="flex items-center gap-3 px-4 py-3 rounded-xl font-medium transition-colors">
        <span>⚙️</span> الإعدادات
      </a>
    </nav>
    <div class="p-4 border-t border-gray-100">
      <div class="flex items-center gap-3 px-4 py-3">
        <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-700 font-bold" x-text="(userSettings.user_name || 'مستخدم')[0]"></div>
        <div>
          <div class="text-sm font-bold" x-text="userSettings.user_name || 'مستخدم'"></div>
          <div class="text-xs text-gray-500" x-text="userSettings.user_email || ''"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobile Header -->
  <div class="lg:hidden fixed top-0 inset-x-0 h-16 bg-white shadow-sm z-20 flex items-center justify-between px-4">
    <div class="text-xl font-extrabold text-green-600">SJA</div>
    <button @click="mobileMenu = !mobileMenu" class="p-2 rounded-lg bg-gray-100 text-gray-600 focus:outline-none">
      <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
    </button>
  </div>
  
  <!-- Mobile Menu Overlay -->
  <div x-show="mobileMenu" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden" @click="mobileMenu = false" x-transition.opacity></div>
  <div x-show="mobileMenu" class="fixed inset-y-0 right-0 w-64 bg-white z-40 lg:hidden shadow-2xl flex flex-col" 
       x-transition:enter="transition ease-out duration-300" x-transition:enter-start="translate-x-full" x-transition:enter-end="translate-x-0"
       x-transition:leave="transition ease-in duration-200" x-transition:leave-start="translate-x-0" x-transition:leave-end="translate-x-full">
       <div class="h-16 flex items-center justify-between px-4 border-b">
         <span class="font-bold text-lg">القائمة</span>
         <button @click="mobileMenu = false" class="text-gray-500">&times;</button>
       </div>
       <nav class="flex-1 p-4 space-y-2">
         <!-- Mobile Links (same as desktop) -->
         <a href="#" @click="page='dashboard'; mobileMenu=false" :class="{'bg-green-50 text-green-700': page==='dashboard'}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 font-medium">
           <span>📊</span> لوحة التحكم
         </a>
         <a href="#" @click="page='transactions'; mobileMenu=false" :class="{'bg-green-50 text-green-700': page==='transactions'}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 font-medium">
           <span>📋</span> العمليات
         </a>
         <a href="#" @click="page='budgets'; mobileMenu=false" :class="{'bg-green-50 text-green-700': page==='budgets'}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 font-medium">
           <span></span> الميزانيات والتصنيفات
         </a>
         <a href="#" @click="page='reports'; mobileMenu=false" :class="{'bg-green-50 text-green-700': page==='reports'}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 font-medium">
           <span>📊</span> التقارير
         </a>
         <a href="#" @click="page='accounts'; mobileMenu=false" :class="{'bg-green-50 text-green-700': page==='accounts'}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 font-medium">
           <span>🏦</span> الحسابات
         </a>
         <a href="#" @click="page='settings'; mobileMenu=false" :class="{'bg-green-50 text-green-700': page==='settings'}" class="flex items-center gap-3 px-4 py-3 rounded-lg hover:bg-gray-50 font-medium">
           <span>⚙️</span> الإعدادات
         </a>
       </nav>
  </div>

  <!-- Main Content -->
  <main class="lg:mr-64 min-h-screen pt-20 lg:pt-8 px-4 lg:px-8 pb-8 transition-all duration-300">
    
    <!-- Global Loading Overlay -->
    <div x-show="loading" x-transition.opacity class="fixed inset-0 bg-white/80 backdrop-blur-sm z-50 flex items-center justify-center">
      <div class="text-center">
        <div class="w-16 h-16 border-4 border-green-200 border-t-green-600 rounded-full animate-spin mx-auto mb-4"></div>
        <p class="text-gray-600 font-medium">جاري التحميل...</p>
      </div>
    </div>

    <!-- Error Message Banner -->
    <div x-show="errorMessage" x-transition class="fixed top-4 left-1/2 transform -translate-x-1/2 z-40 max-w-md w-full mx-4">
      <div class="bg-red-500 text-white px-6 py-4 rounded-lg shadow-lg flex items-start gap-3">
        <span class="text-2xl">⚠️</span>
        <div class="flex-1">
          <div class="font-bold mb-1">خطأ في التحميل</div>
          <div class="text-sm" x-text="errorMessage"></div>
        </div>
        <button @click="errorMessage = ''" class="text-white/80 hover:text-white">&times;</button>
      </div>
    </div>

    <!-- PAGE: DASHBOARD -->
    <div x-show="page === 'dashboard'" x-transition.opacity>
      <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">نظرة عامة</h1>
          <p class="text-gray-500 text-sm mt-1">أهلاً بك، إليك ملخصك المالي لهذا الشهر.</p>
        </div>
        <div class="flex gap-2">
           <button @click="refreshData()" class="px-4 py-2 bg-white border border-gray-200 rounded-lg text-sm font-medium hover:bg-gray-50 transition shadow-sm flex items-center gap-2">
             <span x-show="loading" class="animate-spin">↻</span>
             <span>تحديث</span>
           </button>
           <button @click="openAddModal()" class="px-3 py-2 bg-green-600 text-white rounded-lg text-xs font-semibold hover:bg-green-700 transition shadow-sm w-fit self-start">
             + عملية جديدة
           </button>
        </div>
      </header>

      <!-- KPI Grid -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
        <!-- Balance Card -->
        <div class="bg-gradient-to-br from-indigo-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg shadow-blue-100 relative overflow-hidden group hover:scale-[1.02] transition-transform">
          <div class="absolute top-0 right-0 w-32 h-32 bg-white opacity-10 rounded-full -mr-16 -mt-16 group-hover:scale-150 transition-transform duration-700"></div>
          <div class="text-blue-100 text-sm font-medium mb-1">إجمالي الأرصدة</div>
          <div class="text-3xl font-extrabold tracking-tight" x-text="formatMoney(stats.balance)">0.00</div>
          <div class="mt-4 flex items-center text-xs text-blue-100 bg-white/20 w-fit px-2 py-1 rounded-lg backdrop-blur-sm">
            <span>جميع الحسابات</span>
          </div>
        </div>

        <!-- Income Card -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-2">
            <div class="text-gray-500 text-sm font-medium">الدخل الشهري</div>
            <div class="w-8 h-8 rounded-full bg-green-50 flex items-center justify-center text-green-600">↓</div>
          </div>
          <div class="text-2xl font-bold text-gray-900" x-text="formatMoney(stats.income)">0.00</div>
          <div class="mt-2 text-xs font-medium" x-show="stats.incomeDeltaText" :class="stats.incomeDeltaText.startsWith('-') ? 'text-red-600' : 'text-green-600'" x-text="stats.incomeDeltaText"></div>
        </div>

        <!-- Expense Card -->
        <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
           <div class="flex items-center justify-between mb-2">
            <div class="text-gray-500 text-sm font-medium">المصروفات</div>
            <div class="w-8 h-8 rounded-full bg-red-50 flex items-center justify-center text-red-600">↑</div>
          </div>
          <div class="text-2xl font-bold text-gray-900" x-text="formatMoney(stats.expense)">0.00</div>
          <div class="mt-2 text-xs text-red-600 font-medium">ضمن الميزانية المحددة</div>
        </div>

         <!-- Savings Card -->
         <div class="bg-white rounded-2xl p-6 shadow-sm border border-gray-100 hover:shadow-md transition-shadow">
           <div class="flex items-center justify-between mb-2">
            <div class="text-gray-500 text-sm font-medium">صافي الشهر</div>
            <div class="w-8 h-8 rounded-full bg-purple-50 flex items-center justify-center text-purple-600">★</div>
          </div>
          <div class="text-2xl font-bold" :class="stats.savings >= 0 ? 'text-green-600' : 'text-red-600'" x-text="formatMoney(stats.savings)">0.00</div>
          <div class="mt-2 text-xs font-medium" :class="stats.savings >= 0 ? 'text-green-600' : 'text-red-600'" x-text="stats.savings >= 0 ? 'ممتاز! واصل التقدم.' : 'تجاوزت المصروفات'"></div>
        </div>
      </div>

      <!-- Accounts Summary Section -->
      
      <div class="mt-8" x-show="accounts.length > 0"> 
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-bold text-gray-800">💳 حساباتي</h3>
          <a href="#" @click.prevent="page = 'accounts'" class="text-sm text-green-600 hover:underline font-medium">إدارة الحسابات</a>
        </div>
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          <template x-for="account in accounts.slice(0, 8)" :key="account.name">
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-xl p-4 text-white shadow-lg hover:shadow-xl transition-shadow">
              <div class="flex items-center justify-between mb-3">
                <span class="text-xl">
                  <span x-show="account.type === 'بنك' || !account.type">🏦</span>
                  <span x-show="account.type === 'بطاقة'">💳</span>
                  <span x-show="account.type === 'محفظة'">👛</span>
                </span>
                <span class="text-xs bg-white/20 px-2 py-1 rounded-full" x-text="account.bank || account.type || 'حساب'"></span>
              </div>
              <div class="font-bold text-sm truncate mb-1" x-text="account.name">اسم الحساب</div>
              <div class="text-xs opacity-80 font-mono" x-show="account.number" x-text="'•••• ' + String(account.number).slice(-4)"></div>
              <div class="text-lg font-bold" x-text="formatMoney(account.balance || 0)">0.00</div>
              <div x-show="account.lastUpdate" class="text-xs opacity-75 mt-2" x-text="'آخر تحديث: ' + formatDate(account.lastUpdate)"></div>
            </div>
          </template>
        </div>
        <div x-show="accounts.length > 4" class="mt-3 text-center">
          <button @click="page = 'accounts'" class="text-sm text-green-600 hover:underline font-medium">
            عرض جميع الحسابات (<span x-text="accounts.length"></span>)
          </button>
        </div>
      </div>

      <!-- Recent Transactions & Charts -->
      <div class="grid lg:grid-cols-3 gap-8">
        <!-- Recent Transactions List -->
        <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
          <div class="px-6 py-4 border-b border-gray-50 flex items-center justify-between bg-gray-50/50">
            <h3 class="font-bold text-gray-800">آخر العمليات</h3>
            <a href="#" @click.prevent="showAllTransactions()" class="text-xs text-green-600 font-semibold hover:underline">عرض الكل</a>
          </div>
          <div class="divide-y divide-gray-50">
             <!-- Loop Transactions -->
             <template x-for="(tx, txIndex) in transactions.slice(0, 10)" :key="'dash-tx-' + txIndex">
               <div class="flex items-center justify-between p-4 hover:bg-gray-50 transition-colors group cursor-pointer">
                 <div class="flex items-center gap-4">
                   <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center text-xl shadow-inner group-hover:scale-110 transition-transform">
                     <span x-text="getCategoryIcon(tx.category)">🛒</span>
                   </div>
                   <div>
                     <div class="font-bold text-gray-900 text-sm" x-text="tx.merchant">Subway</div>
                     <div class="text-xs text-gray-500 mt-0.5" x-text="formatDate(tx.date)">Today, 10:23 AM</div>
                   </div>
                 </div>
                 <div class="text-right">
                   <div class="font-bold text-sm" :class="tx.amount > 0 ? 'text-red-500' : 'text-green-600'" x-text="formatMoney(Math.abs(tx.amount))">-25.00</div>
                   <div class="text-[10px] uppercase tracking-wider font-semibold text-gray-400 mt-0.5" x-text="tx.category">FOOD</div>
                 </div>
               </div>
             </template>
             <div x-show="transactions.length === 0" class="p-8 text-center">
               <div class="text-4xl mb-2">📋</div>
               <p class="text-gray-400 mb-3">لا توجد عمليات حديثة</p>
               <button @click="currentPage = 'transactions'" class="text-sm px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition">
                 ➕ إضافة عملية
               </button>
             </div>
          </div>
        </div>

        <!-- Mini Budget/Stats -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h3 class="font-bold text-gray-800 mb-6">توزيع المصروفات</h3>
          
          <!-- Show message if no budgets -->
          <div x-show="budgets.length === 0" class="text-center py-8">
            <div class="text-4xl mb-3">📊</div>
            <p class="text-sm text-gray-400 mb-3">لا توجد ميزانيات محددة</p>
            <button @click="currentPage = 'budgets'" class="text-sm px-4 py-2 bg-green-500 text-white rounded-lg font-medium hover:bg-green-600 transition">
              ➕ إضافة ميزانية
            </button>
          </div>
          
          <!-- Show top 3 budgets -->
          <template x-if="budgets.length > 0">
            <div class="space-y-4">
              <template x-for="(budget, idx) in budgets.slice(0, 3)" :key="idx">
                <div class="flex items-center justify-between text-sm">
                  <div class="flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full" 
                          :class="idx === 0 ? 'bg-green-500' : idx === 1 ? 'bg-blue-500' : 'bg-purple-500'"></span>
                    <span x-text="budget.category">التصنيف</span>
                  </div>
                  <span class="font-bold" x-text="formatMoney(budget.spent)">0</span>
                </div>
              </template>
            </div>
          </template>
        </div>
      </div>
    </div>

    <!-- PAGE: TRANSACTIONS -->
    <div x-show="page === 'transactions'" x-transition.opacity>
      <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">العمليات المالية</h1>
          <p class="text-gray-500 text-sm mt-1">جميع معاملاتك المالية في مكان واحد</p>
        </div>
        <button @click="refreshData()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition">
          تحديث القائمة
        </button>
      </header>
      
      <!-- Search Bar -->
      <div class="mb-6 bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div class="flex gap-3">
          <div class="flex-1 relative">
            <input 
              type="text" 
              x-model="searchQuery"
              @input="searchTransactions()"
              placeholder="ابحث في العمليات... (التاجر، التصنيف، المبلغ)"
              class="w-full px-4 py-3 pr-12 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent"
            >
            <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl">🔍</span>
          </div>
          <button 
            @click="searchQuery = ''; searchTransactions()"
            x-show="searchQuery"
            class="px-6 py-3 bg-gray-100 hover:bg-gray-200 rounded-lg transition font-medium text-gray-700"
          >
            مسح
          </button>
        </div>
        <div x-show="searchQuery" class="mt-2 text-sm text-gray-600">
          <span x-text="'عدد النتائج: ' + transactions.length"></span>
        </div>
      </div>

      <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-100">
              <tr>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">التاريخ</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">التاجر</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">الحساب</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">التصنيف</th>
                <th class="px-6 py-4 text-right text-xs font-bold text-gray-600 uppercase">المبلغ</th>
                <th class="px-6 py-4 text-center text-xs font-bold text-gray-600 uppercase">الإجراءات</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-50">
              <template x-for="(tx, txIndex) in transactions" :key="'tx-' + txIndex">
                <tr class="hover:bg-gray-50 transition-colors">
                  <td class="px-6 py-4 text-sm text-gray-600" x-text="formatDate(tx.date)"></td>
                  <td class="px-6 py-4">
                    <div class="flex items-center gap-3">
                      <span class="text-xl" x-text="getCategoryIcon(tx.category)"></span>
                      <div>
                          <div class="font-medium text-gray-900" x-text="tx.merchant"></div>
                          <div x-show="tx.notes" class="text-xs text-gray-400 truncate max-w-[150px]" x-text="tx.notes"></div>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 text-sm text-gray-600">
                      <span x-text="getAccountDisplay(tx.account)" class="px-2 py-1 bg-gray-50 rounded text-xs"></span>
                  </td>
                  <td class="px-6 py-4">
                    <span class="px-3 py-1 bg-gray-100 text-gray-700 rounded-full text-xs font-medium" x-text="tx.category"></span>
                  </td>
                  <td class="px-6 py-4">
                    <span class="font-bold" :class="tx.amount > 0 ? 'text-red-600' : 'text-green-600'" x-text="formatMoney(Math.abs(tx.amount))"></span>
                  </td>
                  <td class="px-6 py-4">
                    <div class="flex items-center justify-center gap-2">
                      <button @click="openEditTransactionModal(tx)" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="تعديل">
                        ✏️
                      </button>
                      <button @click="deleteTransaction(tx)" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="حذف">
                        🗑️
                      </button>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
        <div x-show="transactions.length === 0" class="p-12 text-center">
          <div class="text-6xl mb-4">📋</div>
          <p class="text-gray-500 text-lg mb-6">لا توجد عمليات لعرضها</p>
          <button @click="showAddModal = true" class="px-6 py-3 bg-green-500 text-white rounded-xl font-bold hover:bg-green-600 transition shadow-lg">
            ➕ إضافة أول عملية
          </button>
        </div>
      </div>
    </div>

    <!-- PAGE: BUDGETS -->
    <div x-show="page === 'budgets'" x-transition.opacity>
      <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">الميزانيات</h1>
          <p class="text-gray-500 text-sm mt-1">تتبع مصروفاتك حسب التصنيف</p>
        </div>
        <button @click="refreshData()" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition">
          تحديث
        </button>
      </header>

      <!-- No budgets message -->
      <div x-show="budgets.length === 0" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
        <div class="text-6xl mb-4">📊</div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">لا توجد ميزانيات</h3>
        <p class="text-gray-600 mb-6">ابدأ بإضافة ميزانيات لتتبع مصروفاتك حسب التصنيف</p>
        <button @click="showBudgetModal = true; editingBudget = null; newBudget = {category: '', limit: 0}" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg">
          ➕ إضافة أول ميزانية
        </button>
      </div>

      <!-- Budgets Grid -->
      <div x-show="budgets.length > 0" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="budget in budgets" :key="budget.category">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class="text-3xl" x-text="getCategoryIcon(budget.category)">💸</span>
                <div>
                  <h3 class="font-bold text-gray-900" x-text="budget.category">التصنيف</h3>
                  <p class="text-xs text-gray-500">الميزانية الشهرية</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button @click="openEditBudgetModal(budget)" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition" title="تعديل">
                  ✏️
                </button>
                <button @click="deleteBudget(budget.category)" class="w-8 h-8 bg-red-100 hover:bg-red-200 rounded-lg flex items-center justify-center transition" title="حذف">
                  🗑️
                </button>
              </div>
            </div>
            <div class="mb-2">
              <div class="flex justify-between text-sm mb-1">
                <span class="text-gray-600">المصروف</span>
                <span class="font-bold text-gray-900">
                  <span x-text="formatMoney(budget.spent)">0</span> / 
                  <span x-text="formatMoney(budget.limit)">0</span>
                </span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="h-2 rounded-full transition-all" 
                     :class="getBudgetColor(getBudgetProgress(budget))"
                     :style="'width: ' + getBudgetProgress(budget) + '%'"></div>
              </div>
            </div>
            <p class="text-xs font-medium mt-3" 
               :class="getBudgetProgress(budget) >= 100 ? 'text-red-600' : getBudgetProgress(budget) >= 80 ? 'text-yellow-600' : 'text-green-600'">
              <template x-if="getBudgetProgress(budget) >= 100">
                <span>✗ تجاوزت بـ <span x-text="formatMoney(budget.spent - budget.limit)"></span></span>
              </template>
              <template x-if="getBudgetProgress(budget) < 100">
                <span>✓ باقي <span x-text="formatMoney(budget.limit - budget.spent)"></span></span>
              </template>
            </p>
          </div>
        </template>
      </div>
    </div>

    <!-- PAGE: CATEGORIES -->
    <div x-show="page === 'categories'" x-transition.opacity>
      <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">إدارة التصنيفات</h1>
          <p class="text-gray-500 text-sm mt-1">تنظيم وإدارة تصنيفات المعاملات</p>
        </div>
        <div class="flex gap-3">
          <button @click="cleanupCategories()" class="px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-medium hover:bg-yellow-700 transition">
            🧹 تنظيف
          </button>
          <button @click="showCategoryModal = true; editingCategory = null; newCategory = {name: '', icon: '📦', color: '#6B7280'}" class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition">
            ➕ إضافة تصنيف
          </button>
        </div>
      </header>

      <!-- Categories Grid -->
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        <template x-for="category in categories" :key="category.name">
          <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <span class="text-3xl" x-text="category.icon">📦</span>
                <div>
                  <h3 class="font-bold text-gray-900" x-text="category.name">التصنيف</h3>
                  <p class="text-xs text-gray-500" x-text="category.type === 'income' ? 'دخل' : 'مصروف'">نوع</p>
                </div>
              </div>
              <div class="flex gap-2">
                <button @click="openEditCategoryModal(category)" class="w-8 h-8 bg-gray-100 hover:bg-gray-200 rounded-lg flex items-center justify-center transition" title="تعديل">
                  ✏️
                </button>
                <button @click="deleteCategory(category.name)" class="w-8 h-8 bg-red-100 hover:bg-red-200 rounded-lg flex items-center justify-center transition" title="حذف">
                  🗑️
                </button>
              </div>
            </div>
            <div class="text-sm text-gray-600">
              <p x-text="category.description || 'لا يوجد وصف'">الوصف</p>
            </div>
            <div class="mt-3 flex items-center gap-2">
              <div class="w-4 h-4 rounded-full" :style="'background-color: ' + category.color"></div>
              <span class="text-xs text-gray-500" x-text="category.active ? 'نشط' : 'غير نشط'">الحالة</span>
            </div>
          </div>
        </template>
      </div>

      <!-- Category Modal -->
      <div x-show="showCategoryModal" @click.self="showCategoryModal = false" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition>
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
          <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-gray-900" x-text="editingCategory ? 'تعديل التصنيف' : 'إضافة تصنيف جديد'">إضافة تصنيف</h3>
            <button @click="showCategoryModal = false" class="text-gray-400 hover:text-gray-600">✕</button>
          </div>

          <form @submit.prevent="saveCategory()">
            <div class="space-y-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">اسم التصنيف</label>
                <input x-model="newCategory.name" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">الأيقونة</label>
                <input x-model="newCategory.icon" type="text" placeholder="📦" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">اللون</label>
                <input x-model="newCategory.color" type="color" class="w-full h-10 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">النوع</label>
                <select x-model="newCategory.type" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                  <option value="expense">مصروف</option>
                  <option value="income">دخل</option>
                </select>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">الوصف (اختياري)</label>
                <textarea x-model="newCategory.description" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" placeholder="وصف التصنيف..."></textarea>
              </div>
            </div>

            <div class="flex gap-3 mt-6">
              <button type="button" @click="showCategoryModal = false" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition">
                إلغاء
              </button>
              <button type="submit" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition">
                حفظ
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- PAGE: SETTINGS -->
    <div x-show="page === 'settings'" x-transition.opacity>
      <header class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">الإعدادات</h1>
        <p class="text-gray-500 text-sm mt-1">تخصيص النظام حسب احتياجاتك</p>
      </header>

      <div class="space-y-6">
        <!-- Account Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span>👤</span> الحساب الشخصي
          </h2>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">الاسم</label>
              <input type="text" x-model="userSettings.user_name" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">البريد الإلكتروني</label>
              <input type="email" x-model="userSettings.user_email" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2">يوم نزول الراتب</label>
              <input type="number" x-model="userSettings.salary_day" min="1" max="31" class="w-full px-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              <p class="text-xs text-gray-500 mt-1">يستخدم لحساب الميزانيات الشهرية (من 1 إلى 31)</p>
            </div>
            <div class="pt-4">
              <button @click="saveSettings()" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">
                💾 حفظ التغييرات
              </button>
            </div>
          </div>
        </div>

        <!-- Notifications Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span>🔔</span> الإشعارات
          </h2>
          <div class="space-y-4">
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-900">إشعارات تيليجرام</p>
                <p class="text-xs text-gray-500">استقبال التنبيهات عبر بوت تيليجرام</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="userSettings.telegram_notifications" @change="saveSettings()" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content=[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
              </label>
            </div>
            <div class="flex items-center justify-between">
              <div>
                <p class="font-medium text-gray-900">تنبيهات الميزانية</p>
                <p class="text-xs text-gray-500">إشعار عند تجاوز حد الميزانية</p>
              </div>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" x-model="userSettings.budget_alerts" @change="saveSettings()" class="sr-only peer">
                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
              </label>
            </div>
          </div>
        </div>

        <!-- System Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span>⚙️</span> النظام
          </h2>
          <div class="space-y-3">
            <div class="p-4 border border-gray-200 rounded-lg">
              <p class="font-medium text-gray-900 mb-3">📤 تصدير البيانات</p>
              <div class="flex gap-2">
                <button @click="exportData()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition">
                  📊 CSV
                </button>
                <button @click="exportAllDataPDF()" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition">
                  📄 PDF
                </button>
              </div>
            </div>
            <button @click="showPrivacyModal = true" class="w-full px-4 py-3 text-right border border-gray-200 rounded-lg hover:bg-gray-50 transition flex items-center justify-between">
              <span class="font-medium text-gray-900">سياسة الخصوصية</span>
              <span class="text-gray-400">→</span>
            </button>
            <button @click="confirmDeleteAccount()" class="w-full px-4 py-3 text-right border border-red-200 rounded-lg hover:bg-red-50 transition flex items-center justify-between text-red-600">
              <span class="font-medium">حذف الحساب</span>
              <span>⚠️</span>
            </button>
          </div>
        </div>

        <!-- Test Panel Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h2 class="font-bold text-gray-900 mb-4 flex items-center gap-2">
            <span>🧪</span> لوحة الاختبارات
          </h2>
          <p class="text-sm text-gray-600 mb-4">اختبر مكونات النظام للتأكد من عملها بشكل صحيح</p>
          
          <div class="space-y-3">
            <!-- Test SMS Parsing -->
            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <p class="font-medium text-gray-900">📝 اختبار تحليل SMS</p>
                  <p class="text-xs text-gray-500">تجربة قراءة رسالة بنكية</p>
                </div>
                <button @click="testSMSParsing()" 
                        :disabled="testingStates.sms"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 disabled:bg-gray-400 transition">
                  <span x-show="!testingStates.sms">تشغيل</span>
                  <span x-show="testingStates.sms">جاري...</span>
                </button>
              </div>
              <div x-show="testResults.sms" class="mt-2 p-3 bg-gray-50 rounded text-xs font-mono overflow-auto max-h-40 whitespace-pre-wrap" x-text="testResults.sms"></div>
            </div>

            <!-- Test AI Classification -->
            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <p class="font-medium text-gray-900">🤖 اختبار تصنيف AI</p>
                  <p class="text-xs text-gray-500">تجربة التصنيف الذكي</p>
                </div>
                <button @click="testAIClassification()" 
                        :disabled="testingStates.ai"
                        class="px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium hover:bg-purple-700 disabled:bg-gray-400 transition">
                  <span x-show="!testingStates.ai">تشغيل</span>
                  <span x-show="testingStates.ai">جاري...</span>
                </button>
              </div>
              <div x-show="testResults.ai" class="mt-2 p-3 bg-gray-50 rounded text-xs font-mono overflow-auto max-h-40 whitespace-pre-wrap" x-text="testResults.ai"></div>
            </div>

            <!-- Test Telegram -->
            <div class="p-4 border border-gray-200 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <p class="font-medium text-gray-900">📱 اختبار تيليجرام</p>
                  <p class="text-xs text-gray-500">إرسال رسالة تجريبية</p>
                </div>
                <button @click="testTelegram()" 
                        :disabled="testingStates.telegram"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 disabled:bg-gray-400 transition">
                  <span x-show="!testingStates.telegram">تشغيل</span>
                  <span x-show="testingStates.telegram">جاري...</span>
                </button>
              </div>
              <div x-show="testResults.telegram" class="mt-2 p-3 bg-gray-50 rounded text-xs font-mono overflow-auto max-h-40 whitespace-pre-wrap" x-text="testResults.telegram"></div>
            </div>

            <!-- Test Full Flow -->
            <div class="p-4 border border-orange-200 bg-orange-50 rounded-lg">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <p class="font-medium text-gray-900">⚡ اختبار التدفق الكامل</p>
                  <p class="text-xs text-gray-500">SMS → AI → حفظ → إشعار (شامل)</p>
                </div>
                <button @click="testFullFlow()" 
                        :disabled="testingStates.fullFlow"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg text-sm font-medium hover:bg-orange-700 disabled:bg-gray-400 transition">
                  <span x-show="!testingStates.fullFlow">تشغيل</span>
                  <span x-show="testingStates.fullFlow">جاري...</span>
                </button>
              </div>
              <div x-show="testResults.fullFlow" class="mt-2 p-3 bg-white rounded text-xs font-mono overflow-auto max-h-40 whitespace-pre-wrap" x-text="testResults.fullFlow"></div>
            </div>
          </div>
        </div>

        <div class="text-center text-sm text-gray-500 py-4">
          <p>SJA Money Tracker v2.1</p>
          <p class="mt-1">صُنع بـ ❤️ في السعودية</p>
        </div>
      </div>
    </div>

    <!-- PAGE: REPORTS -->
    <div x-show="page === 'reports'" x-transition.opacity>
      <header class="mb-8">
        <h1 class="text-2xl font-bold text-gray-900">التقارير</h1>
        <p class="text-gray-500 text-sm mt-1">تقارير شاملة عن مصروفاتك ودخلك</p>
      </header>
      
      <div class="grid md:grid-cols-3 gap-4 mb-8">
        <button @click="loadReport('daily')" class="p-6 bg-white rounded-xl border-2 border-gray-200 hover:border-green-500 transition" :class="reportPeriod === 'daily' ? 'border-green-500 bg-green-50' : ''">
          <div class="text-3xl mb-2">📅</div>
          <div class="font-bold text-gray-900">تقرير اليوم</div>
        </button>
        <button @click="loadReport('weekly')" class="p-6 bg-white rounded-xl border-2 border-gray-200 hover:border-green-500 transition" :class="reportPeriod === 'weekly' ? 'border-green-500 bg-green-50' : ''">
          <div class="text-3xl mb-2">📊</div>
          <div class="font-bold text-gray-900">تقرير الأسبوع</div>
        </button>
        <button @click="loadReport('monthly')" class="p-6 bg-white rounded-xl border-2 border-gray-200 hover:border-green-500 transition" :class="reportPeriod === 'monthly' ? 'border-green-500 bg-green-50' : ''">
          <div class="text-3xl mb-2">📈</div>
          <div class="font-bold text-gray-900">تقرير الشهر</div>
        </button>
      </div>
      
      <!-- Export Buttons -->
      <div x-show="reportData" class="flex gap-3 mb-6">
        <button @click="exportReportPDF()" class="px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition flex items-center gap-2">
          📄 تصدير PDF
        </button>
        <button @click="exportReportCSV()" class="px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium hover:bg-blue-700 transition flex items-center gap-2">
          📊 تصدير CSV
        </button>
        <button @click="printReport()" class="px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-medium hover:bg-gray-700 transition flex items-center gap-2">
          🖨️ طباعة
        </button>
      </div>

      <div x-show="!reportData" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-8 text-center">
        <div class="text-6xl mb-4">📊</div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">اختر فترة التقرير</h3>
        <p class="text-gray-600">انقر على أحد الأزرار أعلاه لعرض التقرير</p>
      </div>
      
      <div x-show="reportData" class="space-y-6" id="reportContent">
        <!-- Stats -->
        <div class="grid md:grid-cols-4 gap-4">
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="text-sm text-gray-600 mb-1">الدخل</div>
            <div class="text-2xl font-bold text-green-600" x-text="formatMoney(reportData?.income || 0)">0</div>
          </div>
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="text-sm text-gray-600 mb-1">المصروفات</div>
            <div class="text-2xl font-bold text-red-600" x-text="formatMoney(reportData?.expenses || 0)">0</div>
          </div>
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="text-sm text-gray-600 mb-1">الادخار</div>
            <div class="text-2xl font-bold" :class="(reportData?.savings || 0) >= 0 ? 'text-green-600' : 'text-red-600'" x-text="formatMoney(reportData?.savings || 0)">0</div>
          </div>
          <div class="bg-white rounded-xl border border-gray-200 p-6">
            <div class="text-sm text-gray-600 mb-1">عدد العمليات</div>
            <div class="text-2xl font-bold text-blue-600" x-text="reportData?.transactionCount || 0">0</div>
          </div>
        </div>
        
        <!-- Category Breakdown -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
          <h3 class="font-bold text-gray-900 mb-4">المصروفات حسب التصنيف</h3>
          <div class="space-y-3">
            <template x-for="item in (reportData?.chartData || [])" :key="item.category">
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span x-text="item.category">التصنيف</span>
                  <span class="font-bold" x-text="formatMoney(item.amount)">0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div class="h-2 rounded-full bg-green-500" :style="'width: ' + (item.amount / (reportData?.expenses || 1) * 100) + '%'"></div>
                </div>
              </div>
            </template>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE: ACCOUNTS -->
    <div x-show="page === 'accounts'" x-transition.opacity>
      <header class="mb-8 flex justify-between items-center">
        <div>
          <h1 class="text-2xl font-bold text-gray-900">الحسابات البنكية</h1>
          <p class="text-gray-500 text-sm mt-1">إدارة حساباتك وبطاقاتك البنكية</p>
        </div>
        <div class="flex gap-3">
          <button @click="showBulkImportModal = true" class="px-4 py-3 bg-purple-600 text-white rounded-xl font-bold hover:bg-purple-700 transition">
            📥 استيراد SMS
          </button>
          <button @click="openAccountModal()" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition flex items-center gap-2">
            <span>➕</span> إضافة حساب
          </button>
        </div>
      </header>
      
      <div x-show="accounts.length === 0" class="bg-white rounded-2xl shadow-sm border border-gray-100 p-12 text-center">
        <div class="text-6xl mb-4">🏦</div>
        <h3 class="text-xl font-bold text-gray-900 mb-2">لا توجد حسابات</h3>
        <p class="text-gray-600 mb-6">أضف حساباتك البنكية لتتبع أرصدتك وعملياتك المالية</p>
        <button @click="openAccountModal()" class="px-6 py-3 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition shadow-lg">
          ➕ إضافة أول حساب
        </button>
      </div>
      
      <div x-show="accounts.length > 0" class="grid md:grid-cols-2 gap-6">
        <template x-for="account in accounts" :key="account.id || account.name">
          <div class="bg-gradient-to-br from-green-600 to-green-700 rounded-2xl shadow-lg p-6 text-white relative">
            <div class="absolute top-4 left-4 flex gap-2">
              <button @click="editAccount(account)" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center">
                ✏️
              </button>
              <button @click="deleteAccount(account)" class="w-8 h-8 bg-white/20 hover:bg-white/30 rounded-lg flex items-center justify-center">
                🗑️
              </button>
            </div>
            <div class="flex justify-between items-start mb-4 pr-20">
              <div>
                <p class="text-lg font-bold mb-1" x-text="account.name">اسم الحساب</p>
                <p class="text-xs opacity-75" x-text="(account.type || 'حساب') + ' • ' + (account.bank || '')"></p>
              </div>
              <div class="text-2xl">
                <span x-show="account.type === 'بنك' || !account.type">🏦</span>
                <span x-show="account.type === 'بطاقة'">💳</span>
                <span x-show="account.type === 'محفظة'">👛</span>
              </div>
            </div>
            
            <!-- Balance Display -->
            <div class="bg-white/10 rounded-xl p-4 mb-4">
              <p class="text-xs opacity-75 mb-1">الرصيد الحالي</p>
              <p class="text-2xl font-bold" x-text="formatMoney(account.balance || 0)">0.00 ر.س</p>
              <p x-show="account.lastUpdate" class="text-xs opacity-60 mt-1" x-text="'آخر تحديث: ' + formatDate(account.lastUpdate)"></p>
            </div>
            
            <div class="mb-2" x-show="account.number">
              <p class="text-xs opacity-75 mb-1">رقم الحساب</p>
              <p class="text-sm font-mono tracking-wider" x-text="account.number || ''">****</p>
            </div>
            <div class="flex gap-2 mt-4">
              <span x-show="account.isMine" class="px-2 py-1 bg-white/20 rounded text-xs">حسابي</span>
              <span x-show="account.isInternal" class="px-2 py-1 bg-white/20 rounded text-xs">تحويل داخلي</span>
            </div>
          </div>
        </template>
      </div>
    </div>

  </main>

  <!-- Add Transaction Modal -->
  <div x-show="showAddModal" @click.self="showAddModal = false" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-2 sm:p-4" x-transition>
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] flex flex-col" @click.stop>
      <!-- Fixed Header -->
      <div class="flex items-center justify-between p-4 border-b border-gray-100 flex-shrink-0">
        <h2 class="text-lg font-bold text-gray-900">إضافة عملية</h2>
        <button @click="showAddModal = false" class="text-gray-400 hover:text-gray-600 text-xl">✕</button>
      </div>

      <!-- Scrollable Content -->
      <div class="overflow-y-auto flex-1 p-4">
        <!-- SMS Paste Area - Always visible for easy bulk input -->
        <div class="mb-4 p-3 bg-purple-50 rounded-xl border-2 border-dashed border-purple-300">
          <div class="flex items-center gap-2 mb-2">
            <span class="text-lg">📱</span>
            <span class="text-sm font-bold text-purple-700">لصق رسائل SMS (يدعم عدة رسائل)</span>
          </div>
          <textarea x-model="rawPasteInput" 
                    class="w-full h-16 p-2 text-sm border border-purple-200 rounded-lg focus:border-purple-500 focus:ring-0 mb-2 bg-white"
                    placeholder="الصق رسائل البنك هنا... (افصل بين كل رسالة بسطر فارغ)"></textarea>
        <button @click="parseRawText()" 
                :disabled="!rawPasteInput || loadingStates.parsing"
                class="w-full py-2 bg-purple-600 text-white rounded-lg font-bold hover:bg-purple-700 disabled:opacity-50 flex items-center justify-center gap-2">
            <span x-show="loadingStates.parsing" class="animate-spin">⌛</span>
            <span x-text="loadingStates.parsing ? 'جاري التحليل...' : '✨ تحليل بـ Grok'"></span>
        </button>
        </div>
      
        <div class="text-center text-xs text-gray-400 mb-2">— أو أدخل يدوياً —</div>
      
        <div class="space-y-3">
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">نوع العملية</label>
            <div class="grid grid-cols-2 gap-2">
              <button @click="newTransaction.type = 'expense'" :class="newTransaction.type === 'expense' ? 'bg-red-500 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-2 rounded-lg text-sm font-medium transition">
                💸 مصروف
              </button>
              <button @click="newTransaction.type = 'income'" :class="newTransaction.type === 'income' ? 'bg-green-500 text-white' : 'bg-gray-100 text-gray-700'" class="px-3 py-2 rounded-lg text-sm font-medium transition">
                💰 دخل
              </button>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">الحساب</label>
              <select x-model="newTransaction.account" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
                 <option value="نقدي">نقدي</option>
                 <template x-for="acc in accounts" :key="acc.name">
                   <option :value="acc.name" x-text="acc.name"></option>
                 </template>
              </select>
            </div>
            <div>
              <label class="block text-xs font-medium text-gray-700 mb-1">المبلغ</label>
              <input type="number" x-model="newTransaction.amount" placeholder="0.00" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            </div>
          </div>
        
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">التاجر / الوصف</label>
            <input type="text" x-model="newTransaction.merchant" placeholder="اسم المتجر أو وصف العملية" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
        
          <div>
            <label class="block text-xs font-medium text-gray-700 mb-1">التصنيف</label>
            <select x-model="newTransaction.category" class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
              <template x-for="(cat, catIdx) in categoryOptions" :key="'add-cat-' + catIdx">
                <option :value="cat" x-text="cat"></option>
              </template>
            </select>
          </div>

          <div>
             <label class="block text-xs font-medium text-gray-700 mb-1">ملاحظات (اختياري)</label>
             <input type="text" x-model="newTransaction.notes" placeholder="ملاحظات..." class="w-full px-3 py-2 text-sm border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
          </div>
        </div>
      </div>
      
      <!-- Fixed Footer -->
      <div class="flex gap-3 p-4 border-t border-gray-100 flex-shrink-0">
        <button @click="showAddModal = false" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition text-sm">
          إلغاء
        </button>
        <button @click="addTransaction()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition text-sm">
          ✓ إضافة
        </button>
      </div>
    </div>
  </div>

  <!-- Budget Modal -->
  <div x-show="showBudgetModal" @click.self="showBudgetModal = false" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition>
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6" @click.stop>
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold text-gray-900" x-text="editingBudget ? 'تعديل الميزانية' : 'إضافة ميزانية جديدة'">إضافة ميزانية</h2>
        <button @click="showBudgetModal = false" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">التصنيف</label>
          <select x-model="newBudget.category" :disabled="editingBudget !== null" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent disabled:bg-gray-100">
            <option value="">اختر التصنيف</option>
            <template x-for="(cat, catIdx) in categoryOptions" :key="'budget-cat-' + catIdx">
              <option :value="cat" x-text="cat"></option>
            </template>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">الحد الأقصى (SAR)</label>
          <input type="number" x-model="newBudget.limit" placeholder="0.00" step="0.01" min="0" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <p class="text-sm text-blue-800">
            💡 سيتم تنبيهك عندما تصل المصروفات إلى 80% من الحد الأقصى
          </p>
        </div>
        
        <div class="flex gap-3 pt-4">
          <button @click="showBudgetModal = false" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition">
            إلغاء
          </button>
          <button @click="addOrEditBudget()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition">
            ✓ حفظ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Account Modal -->
  <div x-show="showAccountModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" x-transition>
    <div @click.outside="showAccountModal = false" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
      <h3 class="text-xl font-bold text-gray-900 mb-6" x-text="editingAccount ? 'تعديل حساب' : 'إضافة حساب جديد'">إضافة حساب</h3>
      
      <!-- AI Smart Extraction - Collapsible -->
      <div x-show="!editingAccount" class="mb-6">
        <button 
          @click="showAIExtraction = !showAIExtraction"
          class="w-full flex items-center justify-between p-4 bg-gradient-to-r from-purple-50 to-blue-50 rounded-xl border-2 border-purple-200 hover:border-purple-300 transition"
        >
          <div class="flex items-center gap-2">
            <span class="text-2xl">🤖</span>
            <span class="font-bold text-purple-900">استخراج ذكي بالذكاء الاصطناعي</span>
          </div>
          <span x-text="showAIExtraction ? '▼' : '◀'" class="text-purple-600 font-bold"></span>
        </button>
        
        <div x-show="showAIExtraction" x-transition class="mt-3 p-4 bg-purple-50/50 rounded-xl border border-purple-100">
          <p class="text-sm text-purple-700 mb-3">الصق رسالة SMS من البنك وسيقوم النظام باستخراج البيانات تلقائياً</p>
          <textarea x-model="newAccount.smsText" placeholder="مثال: تم الشراء من AMAZON بمبلغ 299.00 SAR من بطاقة الراجحي **9767" rows="3" class="w-full px-4 py-3 border border-purple-300 rounded-lg focus:ring-2 focus:ring-purple-500 mb-3 text-sm"></textarea>
          <button @click="extractFromSMS()" class="w-full px-4 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-bold hover:from-purple-700 hover:to-blue-700 transition flex items-center justify-center gap-2">
            <span>✨</span> استخراج البيانات من الرسالة
          </button>
        </div>
      </div>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">اسم الحساب *</label>
          <input type="text" x-model="newAccount.name" placeholder="مثال: الراجحي 9767" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">النوع *</label>
          <select x-model="newAccount.type" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
            <option value="بنك">بنك</option>
            <option value="بطاقة">بطاقة</option>
            <option value="محفظة">محفظة إلكترونية</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">الرصيد الحالي</label>
          <input type="number" step="0.01" x-model="newAccount.balance" placeholder="0.00" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" dir="ltr">
          <p class="text-xs text-gray-500 mt-1">سيتم تحديث الرصيد تلقائياً عند استلام رسائل بنكية جديدة</p>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">رقم الحساب / آخر 4 أرقام</label>
          <input type="text" x-model="newAccount.number" placeholder="9767 أو 0305" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">البنك / الجهة</label>
          <input type="text" x-model="newAccount.bank" placeholder="AlrajhiBank, STC Pay, إلخ" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">أسماء بديلة (مفصولة بفاصلة)</label>
          <input type="text" x-model="newAccount.aliases" placeholder="الراجحي,alrajhi,alrajhi bank" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات</label>
          <textarea x-model="newAccount.notes" placeholder="ملاحظات إضافية عن الحساب" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-transparent" rows="2"></textarea>
        </div>
        
        <div class="flex gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" x-model="newAccount.isMine" class="w-5 h-5 text-green-600 rounded">
            <span class="text-sm text-gray-700">حسابي</span>
          </label>
          
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" x-model="newAccount.isInternal" class="w-5 h-5 text-green-600 rounded">
            <span class="text-sm text-gray-700">تحويل داخلي</span>
          </label>
        </div>
        
        <div class="flex gap-3 pt-4">
          <button @click="showAccountModal = false" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50 transition">
            إلغاء
          </button>
          <button @click="saveAccount()" class="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700 transition">
            ✓ حفظ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bulk Import Modal -->
  <div x-show="showBulkImportModal" @click.self="showBulkImportModal = false" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4" x-transition>
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full p-6 max-h-[80vh] overflow-y-auto">
      <div class="flex items-center justify-between mb-4">
        <h3 class="text-xl font-bold">استيراد مجموعة SMS</h3>
        <button @click="showBulkImportModal = false" class="text-gray-400 hover:text-gray-600">✕</button>
      </div>
      <p class="text-sm text-gray-600 mb-3">الصق رسائل SMS المتعددة (افصل الرسائل بسطر فارغ) ثم اضغط <strong>تحليل</strong>.</p>
      <textarea x-model="bulkSmsText" rows="6" class="w-full px-4 py-3 border rounded-lg mb-3"></textarea>
      <div class="flex gap-3 mb-4">
        <button @click="parseBulkSms()" class="px-4 py-2 bg-purple-600 text-white rounded-lg">🔍 تحليل</button>
        <button @click="bulkSmsText=''; bulkParseResults=[]" class="px-4 py-2 border rounded-lg">مسح</button>
        <div x-show="bulkParsing" class="text-sm text-gray-500 ml-2">جاري التحليل...</div>
      </div>
      <template x-if="bulkParseResults && bulkParseResults.length">
        <div>
          <h4 class="font-bold mb-2">النتائج</h4>
          <div class="space-y-2">
            <template x-for="(r, idx) in bulkParseResults" :key="idx">
              <div class="p-3 border rounded-lg flex items-start gap-3">
                <input type="checkbox" x-model="r.selected" class="mt-1" />
                <div class="flex-1">
                  <div class="text-sm text-gray-700 font-medium" x-text="r.sms"></div>
                  <div class="text-sm text-gray-500" x-text="r.result && (r.result.error || (r.result.account && r.result.account.name) || JSON.stringify(r.result))"></div>
                </div>
              </div>
            </template>
          </div>
          <div class="mt-4 flex justify-end gap-3">
            <button @click="importSelectedAccounts()" class="px-4 py-2 bg-green-600 text-white rounded-lg">✓ استيراد المحدد</button>
            <button @click="showBulkImportModal=false" class="px-4 py-2 border rounded-lg">إغلاق</button>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Toast Notifications -->
  <div class="fixed top-4 left-4 z-50 space-y-2">
    <template x-for="toast in toasts" :key="toast.id">
      <div 
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="transform translate-x-full opacity-0"
        x-transition:enter-end="transform translate-x-0 opacity-100"
        x-transition:leave="transition ease-in duration-200"
        x-transition:leave-start="transform translate-x-0 opacity-100"
        x-transition:leave-end="transform translate-x-full opacity-0"
        class="px-6 py-4 rounded-xl shadow-lg flex items-center gap-3 min-w-[300px]"
        :class="toast.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'"
      >
        <span x-text="toast.type === 'success' ? '✓' : '✕'" class="text-2xl"></span>
        <span x-text="toast.message" class="font-medium"></span>
      </div>
    </template>
  </div>

  <!-- Edit Transaction Modal -->
  <div x-show="showEditTransactionModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-4 z-50" x-transition>
    <div @click.outside="showEditTransactionModal = false" class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
      <h3 class="text-xl font-bold text-gray-900 mb-6">تعديل العملية</h3>
      
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">نوع العملية</label>
          <select x-model="newTransaction.type" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500">
            <option value="expense">مصروف</option>
            <option value="income">دخل</option>
            <option value="transfer">تحويل</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">الحساب</label>
          <select x-model="newTransaction.account" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500">
            <option value="نقدي">نقدي</option>
            <template x-for="acc in accounts" :key="'edit-acc-' + acc.name">
              <option :value="acc.name" x-text="acc.name"></option>
            </template>
          </select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">التاجر *</label>
          <input type="text" x-model="newTransaction.merchant" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">المبلغ *</label>
          <input type="number" step="0.01" x-model="newTransaction.amount" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500">
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">التصنيف</label>
          <select x-model="newTransaction.category" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500">
            <template x-for="(cat, catIdx) in categoryOptions" :key="'edit-cat-' + catIdx">
              <option :value="cat" x-text="cat"></option>
            </template>
          </select>
        </div>
        
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ملاحظات</label>
          <textarea x-model="newTransaction.notes" rows="2" class="w-full px-4 py-3 border border-gray-200 rounded-lg focus:ring-2 focus:ring-green-500"></textarea>
        </div>
        
        <div class="flex gap-3 pt-4">
          <button @click="showEditTransactionModal = false" class="flex-1 px-6 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
            إلغاء
          </button>
          <button @click="saveEditedTransaction()" class="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
            حفظ التعديلات
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Privacy Policy Modal -->
  <div x-show="showPrivacyModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" style="background: rgba(0,0,0,0.5);">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div @click.away="showPrivacyModal = false" class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-y-auto">
        <div class="sticky top-0 bg-white border-b border-gray-200 p-6 flex items-center justify-between">
          <h2 class="text-2xl font-bold text-gray-900">🔒 سياسة الخصوصية</h2>
          <button @click="showPrivacyModal = false" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
          </button>
        </div>
        
        <div class="p-6 space-y-4 text-right">
          <div>
            <h3 class="font-bold text-lg text-gray-900 mb-2">📊 جمع البيانات</h3>
            <p class="text-gray-700">نحن نجمع فقط البيانات التي تدخلها بنفسك: العمليات المالية، الميزانيات، الحسابات، والإعدادات.</p>
          </div>
          
          <div>
            <h3 class="font-bold text-lg text-gray-900 mb-2">🔐 تخزين البيانات</h3>
            <p class="text-gray-700">جميع بياناتك مخزنة في جداول Google Sheets الخاصة بك. نحن لا نخزن أي بيانات على خوادم خارجية.</p>
          </div>
          
          <div>
            <h3 class="font-bold text-lg text-gray-900 mb-2">🤖 استخدام الذكاء الاصطناعي</h3>
            <p class="text-gray-700">نستخدم GROQ API و Gemini لتحليل الرسائل النصية واستخراج بيانات العمليات. يتم إرسال نص الرسالة فقط، دون أي معلومات شخصية.</p>
          </div>
          
          <div>
            <h3 class="font-bold text-lg text-gray-900 mb-2">📱 Telegram Bot</h3>
            <p class="text-gray-700">إذا قمت بتفعيل إشعارات Telegram، سيتم إرسال إشعارات إلى رقم الدردشة المحدد. لا نشارك بياناتك مع أطراف ثالثة.</p>
          </div>
          
          <div>
            <h3 class="font-bold text-lg text-gray-900 mb-2">🗑️ حذف البيانات</h3>
            <p class="text-gray-700">يمكنك حذف حسابك وجميع بياناتك في أي وقت من صفحة الإعدادات. الحذف نهائي ولا يمكن التراجع عنه.</p>
          </div>
          
          <div>
            <h3 class="font-bold text-lg text-gray-900 mb-2">🔒 الأمان</h3>
            <p class="text-gray-700">التطبيق يعمل على Google Apps Script مع بروتوكول HTTPS. جميع البيانات محمية بنظام أمان Google.</p>
          </div>
          
          <div class="border-t border-gray-200 pt-4 mt-4">
            <p class="text-sm text-gray-600">آخر تحديث: يناير 2026</p>
            <p class="text-sm text-gray-600 mt-2">للاستفسارات: <a href="mailto:support@sjatracker.com" class="text-green-600 hover:underline">support@sjatracker.com</a></p>
          </div>
          
          <button @click="showPrivacyModal = false" class="w-full px-6 py-3 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 transition">
            فهمت
          </button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>

